/*
 * File: app/view/org/TabOrgVodomer.js
 * Date: Sat Jul 25 2020 20:31:26 GMT+0300 (EEST)
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Ykis.view.org.TabOrgVodomer', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.taborgvodomer',

    requires: [
        'Ykis.view.org.TabOrgVodomerViewModel',
        'Ykis.view.org.TabOrgVodomerViewController',
        'Ext.form.Panel',
        'Ext.grid.Panel',
        'Ext.view.Table',
        'Ext.grid.column.Number',
        'Ext.grid.column.Action',
        'Ext.grid.column.Date',
        'Ext.form.FieldSet',
        'Ext.selection.CheckboxModel',
        'Ext.button.Button',
        'Ext.form.field.Date',
        'Ext.form.field.Checkbox',
        'Ext.form.field.Display',
        'Ext.form.field.Hidden',
        'Ext.form.field.Number',
        'Ext.panel.Tool'
    ],

    controller: 'taborgvodomer',
    viewModel: {
        type: 'taborgvodomer'
    },
    id: 'tabOrgVodomer',
    layout: 'fit',
    title: 'Водомір',

    initConfig: function(instanceConfig) {
        var me = this,
            config = {
                items: [
                    {
                        xtype: 'form',
                        id: 'fmOrgVodomer',
                        scrollable: true,
                        bodyPadding: 10,
                        icon: '',
                        title: '',
                        items: [
                            {
                                xtype: 'container',
                                width: 1040,
                                layout: 'anchor',
                                items: [
                                    {
                                        xtype: 'gridpanel',
                                        anchor: '100%',
                                        id: 'grOrgHVodomer',
                                        margin: 2,
                                        collapsed: true,
                                        collapsible: true,
                                        title: 'Прилади обліку води зняті з обліку',
                                        emptyText: 'Приборов учета нет в истории',
                                        store: 'StOrgHVodomer',
                                        columns: [
                                            {
                                                xtype: 'numbercolumn',
                                                hidden: true,
                                                dataIndex: 'raion',
                                                text: 'House_id'
                                            },
                                            {
                                                xtype: 'gridcolumn',
                                                hidden: true,
                                                dataIndex: 'period',
                                                text: 'Address'
                                            },
                                            {
                                                xtype: 'actioncolumn',
                                                width: 40,
                                                menuDisabled: true,
                                                items: [
                                                    {
                                                        getClass: function(v, metadata, r, rowIndex, colIndex, store) {
                                                            metaData = 'x-grid-center-icon';
                                                            return metaData;
                                                        },
                                                        handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                                            // in use
                                                            var me = this;
                                                            //STORE

                                                            var stUser = Ext.data.StoreManager.get("StUser");
                                                            var stVodomer = Ext.data.StoreManager.get("StOrgVodomer");

                                                            //LOGIN & PASSWORD

                                                            var values =stUser.getAt(0);
                                                            var params = {
                                                                login:values.get('login'),
                                                                password:values.get('password'),
                                                                filial_id:values.get('filial_id'),
                                                                house_id:values.get('house_id'),
                                                                what:'OVodomerBack'
                                                            };
                                                            //GRID
                                                            var stHVodomer = view.getStore();
                                                            var value = stHVodomer.getAt(rowIndex).data;

                                                            //LOGIKA

                                                            Ext.Object.merge(value, params);
                                                            //console.log(value);

                                                            Ext.MessageBox.confirm({
                                                                title: 'Повернення приладу обліку з історії',
                                                                msg: 'Ви повертаєте прилад обліку з історії <br> Підтвердіть або скасуйте свої дії.',
                                                                buttons: Ext.MessageBox.OKCANCEL,
                                                                icon: Ext.MessageBox.INFO,
                                                                buttonText:{
                                                                    ok:'підтверджую',
                                                                    cancel:'скасувати'
                                                                },
                                                                fn:function(btn,newValue){
                                                                    if(btn=='ok'){
                                                                        QueryVodomer.spisanVodomer(value,function(results){
                                                                            if (results.success==="1"){

                                                                                stHVodomer.load({
                                                                                    params: {
                                                                                        what:'OrgHVodomer',
                                                                                        filial_id: value.filial_id,
                                                                                        login:value.login,
                                                                                        password:value.password
                                                                                    },
                                                                                    scope:this
                                                                                });
                                                                                stVodomer.load({
                                                                                    params: {
                                                                                        what:'OrgVodomer',
                                                                                        filial_id: value.filial_id,
                                                                                        vodomer_id: value.vodomer_id,
                                                                                        login:value.login,
                                                                                        password:value.password
                                                                                    },
                                                                                    scope:this
                                                                                });
                                                                                Ext.MessageBox.show({
                                                                                    title: 'Повернення приладу обліку з історії',
                                                                                    msg: results.msg,
                                                                                    buttons: Ext.MessageBox.OK,
                                                                                    icon: Ext.MessageBox.INFO
                                                                                });

                                                                            } else {
                                                                                Ext.MessageBox.show({
                                                                                    title: 'Повернення приладу обліку з історії',
                                                                                    msg: results.msg,
                                                                                    buttons: Ext.MessageBox.OK,
                                                                                    icon: Ext.MessageBox.ERROR
                                                                                });
                                                                            }
                                                                        });
                                                                    }
                                                                }
                                                            });
                                                        },
                                                        icon: 'resources/css/images/ico/door_out.png',
                                                        tooltip: 'Вернуть водомер из истории'
                                                    }
                                                ]
                                            },
                                            {
                                                xtype: 'gridcolumn',
                                                menuDisabled: true,
                                                text: 'Характеристика приладу обліку',
                                                columns: [
                                                    {
                                                        xtype: 'numbercolumn',
                                                        width: 80,
                                                        dataIndex: 'vodomer_id',
                                                        menuDisabled: true,
                                                        text: 'Ид',
                                                        format: '0'
                                                    },
                                                    {
                                                        xtype: 'gridcolumn',
                                                        renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                                            metaData.style = 'color:#D10000;font-weight:bold;';
                                                            var retValue = '';
                                                            switch (value) {
                                                                case 'Хвода':
                                                                retValue ='<span><img clas="icon" src="resources/css/images/ico/pipex.png"/></span>';
                                                                break;
                                                                case 'Гвода':
                                                                retValue ='<span><img clas="icon" src="resources/css/images/ico/pipeg.png"/></span>';
                                                            }
                                                            return retValue;
                                                        },
                                                        width: 55,
                                                        align: 'center',
                                                        dataIndex: 'voda',
                                                        menuDisabled: true,
                                                        text: 'вода'
                                                    },
                                                    {
                                                        xtype: 'gridcolumn',
                                                        width: 120,
                                                        dataIndex: 'model',
                                                        menuDisabled: true,
                                                        text: 'модель'
                                                    },
                                                    {
                                                        xtype: 'numbercolumn',
                                                        width: 110,
                                                        dataIndex: 'nomer',
                                                        menuDisabled: true,
                                                        text: 'номер',
                                                        format: '0'
                                                    },
                                                    {
                                                        xtype: 'gridcolumn',
                                                        width: 90,
                                                        dataIndex: 'place',
                                                        menuDisabled: true,
                                                        text: 'место'
                                                    }
                                                ]
                                            },
                                            {
                                                xtype: 'gridcolumn',
                                                menuDisabled: true,
                                                text: 'Дата',
                                                columns: [
                                                    {
                                                        xtype: 'datecolumn',
                                                        width: 90,
                                                        align: 'center',
                                                        dataIndex: 'zdate',
                                                        menuDisabled: true,
                                                        text: 'Випуску',
                                                        format: 'd-m-Y'
                                                    },
                                                    {
                                                        xtype: 'datecolumn',
                                                        width: 90,
                                                        align: 'center',
                                                        dataIndex: 'sdate',
                                                        menuDisabled: true,
                                                        text: 'Введен',
                                                        format: 'd-m-Y'
                                                    },
                                                    {
                                                        xtype: 'datecolumn',
                                                        width: 90,
                                                        align: 'center',
                                                        dataIndex: 'data_spis',
                                                        menuDisabled: true,
                                                        text: 'Списан',
                                                        format: 'd-m-Y'
                                                    }
                                                ]
                                            },
                                            {
                                                xtype: 'gridcolumn',
                                                menuDisabled: true,
                                                text: 'Поверка',
                                                columns: [
                                                    {
                                                        xtype: 'datecolumn',
                                                        width: 90,
                                                        align: 'center',
                                                        dataIndex: 'pdate',
                                                        menuDisabled: true,
                                                        text: 'Остання',
                                                        format: 'd-m-Y'
                                                    },
                                                    {
                                                        xtype: 'datecolumn',
                                                        width: 90,
                                                        align: 'center',
                                                        dataIndex: 'fpdate',
                                                        menuDisabled: true,
                                                        text: 'Наступна',
                                                        format: 'd-m-Y'
                                                    },
                                                    {
                                                        xtype: 'gridcolumn',
                                                        width: 90,
                                                        align: 'center',
                                                        dataIndex: 'plomba',
                                                        menuDisabled: true,
                                                        text: 'Пломба'
                                                    }
                                                ]
                                            },
                                            {
                                                xtype: 'actioncolumn',
                                                width: 40,
                                                menuDisabled: true,
                                                items: [
                                                    {
                                                        getClass: function(v, metadata, r, rowIndex, colIndex, store) {
                                                            metaData = 'x-grid-center-icon';
                                                            return metaData;
                                                        },
                                                        handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                                            // in use
                                                            var me = this;
                                                            //STORE

                                                            var stUser = Ext.data.StoreManager.get("StUser");
                                                            //LOGIN & PASSWORD

                                                            var values =stUser.getAt(0);
                                                            var params = {
                                                                login:values.get('login'),
                                                                password:values.get('password'),
                                                                filial_id:values.get('filial_id'),
                                                                house_id:values.get('house_id'),
                                                                what:'OVodomer'
                                                            };
                                                            //GRID
                                                            var stHVodomer = view.getStore();
                                                            var value = stHVodomer.getAt(rowIndex).data;

                                                            //LOGIKA

                                                            Ext.Object.merge(value, params);
                                                            //console.log(value);

                                                            Ext.MessageBox.confirm({
                                                                title: 'Видалення приладу обліку безповоротно',
                                                                msg: 'Ви безповоротно видаляєте прилад обліку<br>Підтвердіть або скасуйте свої дії.',
                                                                buttons: Ext.MessageBox.OKCANCEL,
                                                                icon: Ext.MessageBox.ERROR,
                                                                buttonText:{
                                                                    ok:'підтверджую',
                                                                    cancel:'скасувати'
                                                                },
                                                                fn:function(btn,newValue){
                                                                    if(btn=='ok'){
                                                                        QueryVodomer.delVodomer(value,function(results){
                                                                            if (results.success==="1"){

                                                                                stHVodomer.load({
                                                                                    params: {
                                                                                        what:'OrgHVodomer',
                                                                                        filial_id: value.filial_id,
                                                                                        login:value.login,
                                                                                        password:value.password
                                                                                    },
                                                                                    scope:this
                                                                                });
                                                                                // view.refresh();
                                                                                Ext.MessageBox.show({
                                                                                    title: 'Видалення приладу обліку безповоротно',
                                                                                    msg: results.msg,
                                                                                    buttons: Ext.MessageBox.OK,
                                                                                    icon: Ext.MessageBox.INFO
                                                                                });
                                                                            }
                                                                        });
                                                                    }
                                                                }
                                                            });
                                                        },
                                                        icon: 'resources/css/images/ico/no.png',
                                                        tooltip: 'Удалить водомер безвозвратно'
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            },
                            {
                                xtype: 'fieldset',
                                height: 510,
                                margin: 5,
                                style: 'background-color: #background-color: #CCC;',
                                width: 1040,
                                layout: 'absolute',
                                title: 'текущее показание счетчика',
                                items: [
                                    {
                                        xtype: 'gridpanel',
                                        x: 0,
                                        y: 40,
                                        height: 245,
                                        id: 'grOrgVodomer',
                                        width: 375,
                                        title: 'Прилади обліку води',
                                        store: 'StOrgVodomer',
                                        viewConfig: {
                                            getRowClass: function(record, rowIndex, rowParams, store) {

                                                if(record.get('out') === 1  ){
                                                    return 'change_color';
                                                }
                                                else if(record.get('paused') === 1 ){
                                                    return  'change_color';
                                                }
                                                else if(record.get('avg') === 1 ){
                                                    return  'change_color_yellow';
                                                }
                                                else if(record.get('avg') === 2 ){
                                                    return  'change_color_yellow';
                                                }
                                                else if(record.get('avg') === 3 ){
                                                    return  'change_color_yellow';
                                                }
                                                else if(record.get('avg') === 4 ){
                                                    return  'change_color_red';
                                                }
                                                else  if(record.get('norma') === 4 ){
                                                    return  'change_color_red';
                                                }

                                            },
                                            selectedItemCls: 'x-grid-item-selected change_color_pb'
                                        },
                                        columns: [
                                            {
                                                xtype: 'actioncolumn',
                                                width: 30,
                                                menuDisabled: true,
                                                stopSelection: false,
                                                items: [
                                                    {
                                                        getClass: function(v, metadata, r, rowIndex, colIndex, store) {
                                                            metaData = 'x-grid-center-icon';
                                                            return metaData;
                                                        },
                                                        handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                                            Ext.MessageBox.confirm({
                                                                title: 'Заміна приладу обліку',
                                                                msg: 'Ви замінюєте прилад обліку. <br> Підтвердіть або скасуйте свої дії. ',
                                                                buttons: Ext.MessageBox.OKCANCEL,
                                                                icon: Ext.MessageBox.ERROR,
                                                                buttonText:{
                                                                    ok:'підтверджую',
                                                                    cancel:'скасувати'
                                                                },
                                                                fn:function(btn,newValue){
                                                                    if(btn=='ok'){
                                                                        var dt = new Date();
                                                                        var fmVodomer = Ext.getCmp('fmOrgVodomer');
                                                                        var tek = fmVodomer.getForm().findField('tek').getValue();
                                                                        var bt = Ext.getCmp('btAddVodomer');

                                                                        var winAddVodomer = Ext.ClassManager.instantiateByAlias('widget.winaddvodomer');
                                                                        var form = winAddVodomer.down('#fmAddVodomer');
                                                                        var stUser = Ext.data.StoreManager.get("StUser");
                                                                        var values =stUser.getAt(0);
                                                                        var value = record;

                                                                        view.getSelectionModel().select(rowIndex);
                                                                        values.set({'vibor':'changeOrgVodomer','rowind':rowIndex});
                                                                        stUser.sync();
                                                                        form.getForm().findField('tek').setFieldLabel('Поточні показання');

                                                                        //form.getForm().findField('filial_id').hide();
                                                                        form.getForm().findField('address_id').hide();

                                                                        form.down('#btAddVodomer').setText('Перекидання приладу обліку');
                                                                        form.down('#fcntNewVodomer').hide();
                                                                        form.down('#chkExistentVod').hide();
                                                                        //form.getForm().findField('new_address_id').setValue(values.get('address_id'));
                                                                        form.loadRecord(value);
                                                                        form.getForm().findField('tek').setValue(tek);
                                                                        winAddVodomer.setTitle('Перекидання приладу обліку на іншу адресу');
                                                                        winAddVodomer.show();

                                                                    }
                                                                }
                                                            });
                                                        },
                                                        icon: 'resources/css/images/ico/delete.png',
                                                        tooltip: 'Перекидання приладу обліку'
                                                    }
                                                ]
                                            },
                                            {
                                                xtype: 'numbercolumn',
                                                hidden: true,
                                                dataIndex: 'vodomer_id',
                                                text: 'ид',
                                                format: '0'
                                            },
                                            {
                                                xtype: 'numbercolumn',
                                                hidden: true,
                                                dataIndex: 'address_id',
                                                text: 'Address_id',
                                                format: '0'
                                            },
                                            {
                                                xtype: 'numbercolumn',
                                                hidden: true,
                                                dataIndex: 'raion',
                                                text: 'House_id'
                                            },
                                            {
                                                xtype: 'gridcolumn',
                                                hidden: true,
                                                dataIndex: 'period',
                                                text: 'Address'
                                            },
                                            {
                                                xtype: 'gridcolumn',
                                                renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                                    metaData.style = 'color:#D10000;font-weight:bold;';
                                                    var retValue = '';
                                                    switch (value) {
                                                        case 'Хвода':
                                                        retValue ='<span><img clas="icon" src="resources/css/images/ico/pipex.png"/></span>';
                                                        break;
                                                        case 'Гвода':
                                                        retValue ='<span><img clas="icon" src="resources/css/images/ico/pipeg.png"/></span>';
                                                    }
                                                    return retValue;
                                                },
                                                width: 55,
                                                dataIndex: 'voda',
                                                menuDisabled: true,
                                                text: 'вода'
                                            },
                                            {
                                                xtype: 'gridcolumn',
                                                renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                                    if (record.get('out')===1){
                                                        metaData.tdCls = 'line-through';
                                                    }
                                                    return value;
                                                },
                                                width: 80,
                                                dataIndex: 'place',
                                                menuDisabled: true,
                                                text: 'место'
                                            },
                                            {
                                                xtype: 'gridcolumn',
                                                renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                                    if (record.get('out')===1){
                                                        metaData.tdCls = 'line-through';
                                                    }
                                                    return value;
                                                },
                                                width: 80,
                                                dataIndex: 'nomer',
                                                menuDisabled: true,
                                                text: 'номер'
                                            },
                                            {
                                                xtype: 'actioncolumn',
                                                width: 30,
                                                menuDisabled: true,
                                                stopSelection: false,
                                                items: [
                                                    {
                                                        getClass: function(v, metadata, r, rowIndex, colIndex, store) {
                                                            metaData = 'x-grid-center-icon';
                                                            return metaData;
                                                        },
                                                        handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                                            Ext.MessageBox.confirm({
                                                                title: 'Редагування приладу обліку',
                                                                msg: 'Ви редагуєте дані по приладу обліку <br> Підтвердіть або скасуйте свої дії.',
                                                                buttons: Ext.MessageBox.OKCANCEL,
                                                                icon: Ext.MessageBox.ERROR,
                                                                buttonText:{
                                                                    ok:'підтверджую',
                                                                    cancel:'скасувати'
                                                                },
                                                                fn:function(btn,newValue){
                                                                    if(btn=='ok'){
                                                                        var dt = new Date();
                                                                        var fmVodomer = Ext.getCmp('fmOrgVodomer');
                                                                        var tek = fmVodomer.getForm().findField('tek').getValue();

                                                                        var winAddVodomer = Ext.ClassManager.instantiateByAlias('widget.winaddvodomer');
                                                                        var form = winAddVodomer.down('#fmAddVodomer');
                                                                        var obrVodomer = form.down('#obrVodomer');
                                                                        var jointVodomer = form.down('#jointVodomer');
                                                                        var stUser = Ext.data.StoreManager.get("StUser");
                                                                        var values =stUser.getAt(0);
                                                                        var value = record;//stVodomer.getAt(rowIndex).data;
                                                                        //LOGIKA'
                                                                        //console.log(values.get('address_id'));
                                                                        view.getSelectionModel().select(rowIndex);
                                                                        values.set({'vibor':'editOrgVodomer','rowind':rowIndex});
                                                                        stUser.sync();
                                                                        form.getForm().findField('tek').setFieldLabel('Поточні показання');

                                                                        form.down('#btAddVodomer').setText('Оновити');
                                                                        form.down('#chkExistentVod').hide();
                                                                        //form.getForm().findField('vd').hide();
                                                                        //jointVodomer.hide();
                                                                        //obrVodomer.hide();
                                                                        form.loadRecord(value);
                                                                        form.getForm().findField('new_id').setValue(values.get('filial_id'));
                                                                        form.getForm().findField('address_id').hide();
                                                                        form.getForm().findField('filial_id').hide();
                                                                        form.getForm().findField('new_id').hide();


                                                                        form.getForm().findField('tek').setValue(tek);
                                                                        winAddVodomer.setTitle('Редагування приладу обліку');
                                                                        winAddVodomer.show();
                                                                    }
                                                                }
                                                            });
                                                        },
                                                        icon: 'resources/css/images/ico/edit.png',
                                                        tooltip: 'Обновить водомер'
                                                    }
                                                ]
                                            },
                                            {
                                                xtype: 'actioncolumn',
                                                width: 30,
                                                menuDisabled: true,
                                                items: [
                                                    {
                                                        handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                                            var stUser = Ext.data.StoreManager.get("StUser");
                                                            var stVodomer = Ext.data.StoreManager.get("StOrgVodomer");
                                                            var values =stUser.getAt(0);
                                                            var params = {
                                                                login:values.get('login'),
                                                                password:values.get('password'),
                                                                what:'OVodomer'

                                                            };
                                                            var grVodomer = Ext.getCmp('grOrgVodomer');
                                                            var value = stVodomer.getAt(rowIndex).data;
                                                            Ext.Object.merge(value, params);
                                                            //console.log(value);
                                                            Ext.MessageBox.confirm({
                                                                title: 'Повернення приладу обліку з повірки',
                                                                msg: 'Ви повертаєте прилад обліку з повірки <br> Підтвердіть або скасуйте свої дії.',
                                                                buttons: Ext.MessageBox.OKCANCEL,
                                                                icon: Ext.MessageBox.ERROR,
                                                                buttonText:{
                                                                    ok:'підтверджую',
                                                                    cancel:'скасувати'
                                                                },
                                                                fn:function(btn,newValue){
                                                                    if(btn=='ok'){
                                                                        QueryVodomer.outVodomerHistory(value,function(results){
                                                                            if (results.success==="1"){
                                                                                stVodomer.load({
                                                                                    params: {
                                                                                        what:'OrgVodomer',
                                                                                        filial_id: value.filial_id,
                                                                                        vodomer_id: value.vodomer_id,
                                                                                        login:value.login,
                                                                                        password:value.password
                                                                                    },
                                                                                    callback: function(records,operation,success){
                                                                                        if(success){
                                                                                            grVodomer.getView().getSelectionModel().select(rowIndex);
                                                                                            Ext.MessageBox.show({
                                                                                                title: 'Повернення приладу обліку з повірки',
                                                                                                msg: results.msg,
                                                                                                buttons: Ext.MessageBox.OK,
                                                                                                icon: Ext.MessageBox.INFO
                                                                                            });
                                                                                        }
                                                                                    },
                                                                                    scope:this
                                                                                });
                                                                            }
                                                                        });
                                                                    }
                                                                }
                                                            });



                                                        },
                                                        getClass: function(v, metadata, r, rowIndex, colIndex, store) {
                                                            var out = r.get('out');
                                                            if (out === 0 ) {
                                                                metaData = 'x-hide-display';
                                                            } else if (out === 1   ){
                                                                metaData = 'x-grid-center-icon';
                                                            }
                                                            return metaData;
                                                        },
                                                        icon: 'resources/css/images/ico/door_out.png',
                                                        tooltip: 'Повернути прилад обліку з повірки'
                                                    },
                                                    {
                                                        getClass: function(v, metadata, r, rowIndex, colIndex, store) {
                                                            //console.log(r);
                                                            var out = r.get('out');
                                                            //console.log(out);
                                                            if (out === 1 ) {
                                                                metaData = 'x-hide-display';
                                                                //console.log(1);
                                                            } else if (out === 0   ){
                                                                metaData = 'x-grid-center-icon';
                                                                // console.log(0);
                                                            }
                                                            return metaData;
                                                        },
                                                        handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                                            // in use
                                                            var me = this;
                                                            //STORE
                                                            var stUser = Ext.data.StoreManager.get("StUser");
                                                            var stVodomer = Ext.data.StoreManager.get("StOrgVodomer");
                                                            //LOGIN & PASSWORD
                                                            var values =stUser.getAt(0);
                                                            var params = {
                                                                login:values.get('login'),
                                                                password:values.get('password'),
                                                                what:'OVodomer'
                                                            };
                                                            //GRID
                                                            var grVodomer = Ext.getCmp('grOrgVodomer');
                                                            //FORMA
                                                            var value = stVodomer.getAt(rowIndex).data;
                                                            //LOGIKA
                                                            Ext.Object.merge(value, params);
                                                            //console.log(value);
                                                            Ext.MessageBox.confirm({
                                                                title: 'Виведення приладу обліку в повірку',
                                                                msg: 'Ви виводите прилад обліку в повірку <br> Підтвердіть або скасуйте свої дії.',
                                                                buttons: Ext.MessageBox.OKCANCEL,
                                                                icon: Ext.MessageBox.ERROR,
                                                                buttonText:{
                                                                    ok:'підтверджую',
                                                                    cancel:'скасувати'
                                                                },
                                                                fn:function(btn,newValue){
                                                                    if(btn=='ok'){
                                                                        QueryVodomer.inVodomerHistory(value,function(results){
                                                                            if (results.success==="1"){
                                                                                stVodomer.load({
                                                                                    params: {
                                                                                        what:'OrgVodomer',
                                                                                        filial_id: value.filial_id,
                                                                                        vodomer_id: value.vodomer_id,
                                                                                        login:value.login,
                                                                                        password:value.password
                                                                                    },
                                                                                    callback: function(records,operation,success){
                                                                                        if(success){
                                                                                            grVodomer.getView().getSelectionModel().select(rowIndex);
                                                                                            Ext.MessageBox.show({
                                                                                                title: 'Виведення приладу обліку в повірку',
                                                                                                msg: results.msg,
                                                                                                buttons: Ext.MessageBox.OK,
                                                                                                icon: Ext.MessageBox.INFO
                                                                                            });
                                                                                        }
                                                                                    },
                                                                                    scope:this
                                                                                });
                                                                            }
                                                                        });
                                                                    }
                                                                }
                                                            });


                                                        },
                                                        icon: 'resources/css/images/ico/maintenance_16.png',
                                                        tooltip: 'Висновок прилад обліку в повірку'
                                                    }
                                                ]
                                            },
                                            {
                                                xtype: 'actioncolumn',
                                                width: 30,
                                                menuDisabled: true,
                                                items: [
                                                    {
                                                        getClass: function(v, metadata, r, rowIndex, colIndex, store) {
                                                            metaData = 'x-grid-center-icon';
                                                            return metaData;
                                                        },
                                                        handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                                            var stUser = Ext.data.StoreManager.get("StUser");
                                                            var stTekPokVodomera = Ext.data.StoreManager.get("StTekPokOrgVodomera");
                                                            var stHVodomer = Ext.data.StoreManager.get("StOrgHVodomer");

                                                            var values =stUser.getAt(0);
                                                            var params = {
                                                                login:values.get('login'),
                                                                password:values.get('password'),
                                                                filial_id:values.get('filial_id'),
                                                                what:'OVodomer'
                                                            };
                                                            var store = view.getStore();
                                                            var value = store.getAt(rowIndex).data;

                                                            Ext.Object.merge(value, params);
                                                            //console.log(value);

                                                            Ext.MessageBox.confirm({
                                                                title: 'Видалення приладу обліку в історію',
                                                                msg: 'Ви видаляєте прилад обліку в історію <br> Підтвердіть або скасуйте свої дії.',
                                                                buttons: Ext.MessageBox.OKCANCEL,
                                                                icon: Ext.MessageBox.INFO,
                                                                buttonText:{
                                                                    ok:'підтверджую',
                                                                    cancel:'скасувати'

                                                                },
                                                                fn:function(btn,newValue){
                                                                    if(btn=='ok'){
                                                                        QueryVodomer.spisanVodomer(value,function(results){
                                                                            if(results.success==="1"){
                                                                                store.load({
                                                                                    params: {
                                                                                        login:value.login,
                                                                                        what:'OrgVodomer',
                                                                                        password:value.password,
                                                                                        filial_id: value.filial_id,
                                                                                        what_id: value.filial_id
                                                                                    },
                                                                                    scope:this
                                                                                });
                                                                                stHVodomer.load({
                                                                                    params: {
                                                                                        login:value.login,
                                                                                        password:value.password,
                                                                                        what:'OrgHVodomer',
                                                                                        filial_id: value.filial_id,
                                                                                        what_id: value.filial_id
                                                                                    },
                                                                                    scope:this
                                                                                });
                                                                            } else {
                                                                                Ext.MessageBox.show({
                                                                                    title: 'Видалення приладу обліку в історію',
                                                                                    msg: results.msg,
                                                                                    buttons: Ext.MessageBox.OK,
                                                                                    icon: Ext.MessageBox.ERROR
                                                                                });
                                                                            }
                                                                        });
                                                                    }
                                                                }
                                                            });
                                                        },
                                                        icon: 'resources/css/images/ico/no.png',
                                                        tooltip: 'Видалити прилад обліку в історію'
                                                    }
                                                ]
                                            }
                                        ],
                                        selModel: Ext.create('Ext.selection.CheckboxModel', {
                                            selType: 'checkboxmodel'
                                        })
                                    },
                                    {
                                        xtype: 'button',
                                        x: 0,
                                        y: 5,
                                        id: 'addOrgVodomer',
                                        width: 180,
                                        icon: 'resources/css/images/ico/add.png',
                                        text: 'Додати прилад обліку'
                                    },
                                    {
                                        xtype: 'button',
                                        handler: function(button, e) {
                                            var me = this;
                                            var StUser = Ext.data.StoreManager.get("StUser");
                                            var StReport = Ext.data.StoreManager.get("StReport");
                                            var values =StUser.getAt(0);
                                            var filial_id =values.get('filial_id');

                                            var usertype = 1;

                                            //V
                                            var tabPnCenter =  Ext.getCmp('tabPnCenter');//me.getTabPnCenter();
                                            var grid = Ext.getCmp('grOrgVodomer');
                                            var gridRowSelectedRecords  = grid.getView().getSelectionModel().getSelection();
                                            var size = Ext.Object.getSize(gridRowSelectedRecords) ;
                                            var vodomer =[];
                                            if (size >= 1){

                                                Ext.Object.each(gridRowSelectedRecords, function(key, val, myself) {
                                                    Ext.Object.merge(val.data, vodomer);
                                                    vodomer.push(val.data.vodomer_id);
                                                });

                                            }

                                            //console.log(values);
                                            if (filial_id) {

                                                var report = 'VodoPotreblenieOrg';
                                                var namereport = 'Отчет водоспоживання.';

                                                var value = {
                                                    login:values.get('login'),
                                                    password:values.get('password'),
                                                    report:report,
                                                    what:report,
                                                    filial_id:filial_id,
                                                    vodomer: vodomer
                                                };

                                                var tab = tabPnCenter.child('#'+report);

                                                if (!tab) {
                                                    tab  = tabPnCenter.add({
                                                        xtype:'tabreportorg',
                                                        title:namereport,
                                                        id:''+report+''
                                                    });

                                                    tabPnCenter.setActiveTab(tab);

                                                }else{

                                                    tabPnCenter.setActiveTab(tab);
                                                }

                                                var reppan = tab.getComponent(0);


                                                var myMask= Ext.Msg.show({
                                                    title:'Отчеты...',
                                                    msg: 'Завантаження отчета.Ожідайте...',
                                                    buttons: Ext.Msg.CANCEL,
                                                    wait: true,
                                                    modal: true,
                                                    icon: Ext.Msg.INFO
                                                });

                                                QueryReport.getResults(value,function(data){
                                                    if (data){

                                                        //    reportHead.update(data.head);
                                                        reppan.update(data.content);
                                                        //      reportFoot.update(data.foot);
                                                        Ext.REPORTCONTENT =data.content;
                                                        myMask.close();


                                                    } else {
                                                        Ext.MessageBox.show({
                                                            title: 'Ошибка ',
                                                            msg: 'Документ не створено',
                                                            buttons: Ext.MessageBox.OK,
                                                            icon: Ext.MessageBox.ERROR

                                                        });

                                                    }

                                                });
                                                myMask.close();


                                            }

                                        },
                                        x: 185,
                                        y: 5,
                                        id: 'VodoPotreblenieiOrg',
                                        width: 190,
                                        icon: 'resources/css/images/ico/add.png',
                                        text: 'Отчет водопотребления'
                                    },
                                    {
                                        xtype: 'button',
                                        handler: function(button, e) {
                                            var me = this;
                                            var StUser = Ext.data.StoreManager.get("StUser");
                                            var StReport = Ext.data.StoreManager.get("StReport");
                                            var values =StUser.getAt(0);
                                            var filial_id = values.data.filial_id;

                                            var usertype = 1;

                                            var tabPnCenter =  Ext.getCmp('tabPnCenter');
                                            var grid = Ext.getCmp('grOrgVodomer');
                                            var gridRowSelectedRecords  = grid.getView().getSelectionModel().getSelection();
                                            var size = Ext.Object.getSize(gridRowSelectedRecords) ;
                                            var vodomer =[];
                                            if (size >= 1){

                                                Ext.Object.each(gridRowSelectedRecords, function(key, val, myself) {
                                                    Ext.Object.merge(val.data, vodomer);
                                                    vodomer.push(val.data.vodomer_id);
                                                });

                                            }

                                            //console.log(vodomer);
                                            if (filial_id) {

                                                var report = 'AktOplombirovkiVodomerOrg';
                                                var namereport = 'Акт опломбування.';

                                                var value = {
                                                    login:values.get('login'),
                                                    password:values.get('password'),
                                                    report:report,
                                                    what:report,
                                                    filial_id: filial_id,
                                                    vodomer: vodomer
                                                };

                                                var tab = tabPnCenter.child('#'+report);

                                                if (!tab) {
                                                    tab  = tabPnCenter.add({
                                                        xtype:'tabreportorg',
                                                        title:namereport,
                                                        id:''+report+''
                                                    });

                                                    tabPnCenter.setActiveTab(tab);

                                                }else{

                                                    tabPnCenter.setActiveTab(tab);
                                                }

                                                var reppan = tab.getComponent(0);


                                                var myMask= Ext.Msg.show({
                                                    title:'Отчеты...',
                                                    msg: 'Завантаження отчета.Ожідайте...',
                                                    buttons: Ext.Msg.CANCEL,
                                                    wait: true,
                                                    modal: true,
                                                    icon: Ext.Msg.INFO
                                                });

                                                QueryReport.getResults(value,function(data){
                                                    if (data){

                                                        //    reportHead.update(data.head);
                                                        reppan.update(data.content);
                                                        //      reportFoot.update(data.foot);
                                                        Ext.REPORTCONTENT =data.content;
                                                        myMask.close();


                                                    } else {
                                                        Ext.MessageBox.show({
                                                            title: 'Ошибка ',
                                                            msg: 'Документ не створено',
                                                            buttons: Ext.MessageBox.OK,
                                                            icon: Ext.MessageBox.ERROR

                                                        });

                                                    }

                                                });
                                                myMask.close();


                                            }

                                        },
                                        x: 210,
                                        y: 295,
                                        id: 'aktOplombirovkiOrg',
                                        width: 165,
                                        icon: 'resources/css/images/ico/add.png',
                                        text: 'Акт опломбування'
                                    },
                                    {
                                        xtype: 'button',
                                        handler: function(button, e) {
                                            var me = this;
                                            var StUser = Ext.data.StoreManager.get("StUser");
                                            var StReport = Ext.data.StoreManager.get("StReport");
                                            var values =StUser.getAt(0);
                                            var filial_id = values.data.filial_id;

                                            var usertype = 1;

                                            var tabPnCenter =  Ext.getCmp('tabPnCenter');
                                            var grid = Ext.getCmp('grOrgVodomer');

                                            var gridRowSelectedRecords  = grid.getView().getSelectionModel().getSelection();
                                            var size = Ext.Object.getSize(gridRowSelectedRecords) ;
                                            var vodomer =[];
                                            if (size >= 1){

                                                Ext.Object.each(gridRowSelectedRecords, function(key, val, myself) {
                                                    Ext.Object.merge(val.data, vodomer);
                                                    vodomer.push(val.data.vodomer_id);
                                                });

                                            }

                                            console.log(vodomer);
                                            if (filial_id) {

                                                var report = 'AktRasplombirovkiVodomerOrg';
                                                var namereport = 'Акт розпломбування.';

                                                var value = {
                                                    login:values.get('login'),
                                                    password:values.get('password'),
                                                    report:report,
                                                    what:report,
                                                    filial_id: filial_id,
                                                    vodomer: vodomer
                                                };

                                                var tab = tabPnCenter.child('#'+report);

                                                if (!tab) {
                                                    tab  = tabPnCenter.add({
                                                        xtype:'tabreportorg',
                                                        title:namereport,
                                                        id:''+report+''
                                                    });

                                                    tabPnCenter.setActiveTab(tab);

                                                }else{

                                                    tabPnCenter.setActiveTab(tab);
                                                }

                                                var reppan = tab.getComponent(0);


                                                var myMask= Ext.Msg.show({
                                                    title:'Отчеты...',
                                                    msg: 'Завантаження отчета.Ожідайте...',
                                                    buttons: Ext.Msg.CANCEL,
                                                    wait: true,
                                                    modal: true,
                                                    icon: Ext.Msg.INFO
                                                });

                                                QueryReport.getResults(value,function(data){
                                                    if (data){

                                                        //    reportHead.update(data.head);
                                                        reppan.update(data.content);
                                                        //      reportFoot.update(data.foot);
                                                        Ext.REPORTCONTENT =data.content;
                                                        myMask.close();


                                                    } else {
                                                        Ext.MessageBox.show({
                                                            title: 'Ошибка ',
                                                            msg: 'Документ не створено',
                                                            buttons: Ext.MessageBox.OK,
                                                            icon: Ext.MessageBox.ERROR

                                                        });

                                                    }

                                                });
                                                myMask.close();


                                            }

                                        },
                                        x: 0,
                                        y: 295,
                                        id: 'aktRasplombirovkiOrg',
                                        width: 160,
                                        icon: 'resources/css/images/ico/add.png',
                                        text: 'Акт розпломбування'
                                    },
                                    {
                                        xtype: 'fieldset',
                                        x: 390,
                                        y: 215,
                                        height: 255,
                                        style: 'background-color: #F1EEEE;',
                                        width: 145,
                                        layout: 'absolute',
                                        title: 'Останнє показаня',
                                        items: [
                                            {
                                                xtype: 'datefield',
                                                anchor: '100%',
                                                width: 145,
                                                fieldLabel: 'Дата',
                                                labelWidth: 35,
                                                name: 'data',
                                                readOnly: true,
                                                altFormats: 'd.m.y|d/m/Y|d-m-y|d-m-Y|d/m|d-m|dm|dmy|dmY|d|Y-m-d',
                                                format: 'd-m-Y'
                                            },
                                            {
                                                xtype: 'textfield',
                                                anchor: '100%',
                                                x: 0,
                                                y: 35,
                                                width: 145,
                                                fieldLabel: 'Показ',
                                                labelWidth: 55,
                                                name: 'pok_id',
                                                readOnly: true
                                            },
                                            {
                                                xtype: 'textfield',
                                                anchor: '100%',
                                                x: 0,
                                                y: 70,
                                                width: 145,
                                                fieldLabel: 'Поперед',
                                                labelWidth: 55,
                                                name: 'pred',
                                                readOnly: true
                                            },
                                            {
                                                xtype: 'textfield',
                                                anchor: '100%',
                                                x: 0,
                                                y: 105,
                                                width: 145,
                                                fieldLabel: 'Поточні',
                                                labelWidth: 55,
                                                name: 'tekp',
                                                readOnly: true
                                            },
                                            {
                                                xtype: 'textfield',
                                                anchor: '100%',
                                                x: 0,
                                                y: 140,
                                                width: 145,
                                                fieldLabel: 'кубов',
                                                labelWidth: 55,
                                                name: 'kub',
                                                readOnly: true
                                            },
                                            {
                                                xtype: 'button',
                                                handler: function(button, e) {
                                                    var stUser = Ext.data.StoreManager.get("StUser");
                                                    var stWater = Ext.data.StoreManager.get("StOrgWater");
                                                    var stTekPokVodomera = Ext.data.StoreManager.get("StTekPokOrgVodomera");

                                                    var values =stUser.getAt(0);
                                                    var params = {
                                                        login:values.get('login'),
                                                        password:values.get('password'),
                                                        org_id:values.get('org_id'),
                                                        filial_id:values.get('filial_id'),
                                                        filial:values.get('filial'),
                                                        what:'OVodomer'

                                                    };

                                                    var fmVodomer = Ext.getCmp('fmOrgVodomer');
                                                    var value = fmVodomer.getValues();

                                                    //LOGIKA

                                                    Ext.Object.merge(value, params);
                                                    Ext.MessageBox.confirm({
                                                        title: 'Видалення останніх показань приладу обліку',
                                                        msg: 'Ви видаляєте останнім показання по приладу обліку <br>Показання<b>'+value.tek+
                                                        '</b><br>Підтвердіть або скасуйте свої дії.',
                                                        buttons: Ext.MessageBox.OKCANCEL,
                                                        icon: Ext.MessageBox.ERROR,
                                                        buttonText:{
                                                            ok: 'подтвеждаю',
                                                            cancel: 'скасування'
                                                        },
                                                        fn:function(btn,newValue){
                                                            if(btn=='ok'){
                                                                QueryVodomer.delPokVodomera(value,function(results){
                                                                    if (results.success){
                                                                        Ext.MessageBox.show({title: 'Видалення останніх показань приладу обліку ',
                                                                            msg: results.msg,
                                                                            buttons: Ext.MessageBox.OK,
                                                                            icon: Ext.MessageBox.INFO
                                                                        });
                                                                        fmVodomer.getForm().findField('newValue').setValue(0);
                                                                        stWater.load({
                                                                            params: {
                                                                                what:'AllPokOVodomera',
                                                                                what_id: value.filial_id,
                                                                                filial_id: value.filial_id,
                                                                                vodomer_id: value.vodomer_id,
                                                                                login:value.login,
                                                                                password:value.password
                                                                            },
                                                                            scope:this
                                                                        });

                                                                        stTekPokVodomera.load({
                                                                            params: {
                                                                                what:'TekPokOVodomera',
                                                                                what_id: value.filial_id,
                                                                                filial_id: value.filial_id,
                                                                                vodomer_id: value.vodomer_id,
                                                                                login:value.login,
                                                                                password:value.password
                                                                            },
                                                                            callback: function(records,operation,success){
                                                                                if(success){
                                                                                    fmVodomer.getForm().loadRecord(records[0]);
                                                                                }
                                                                            },
                                                                            scope:this
                                                                        });

                                                                    }else{
                                                                        Ext.MessageBox.show({title: 'Видалення останніх показань приладу обліку',
                                                                            msg: results.msg,
                                                                            buttons: Ext.MessageBox.OK,
                                                                            icon: Ext.MessageBox.ERROR
                                                                        });
                                                                    }
                                                                });
                                                            }
                                                        }
                                                    });

                                                },
                                                anchor: '100%',
                                                x: 0,
                                                y: 175,
                                                disabled: true,
                                                id: 'delTekPokOrgVod',
                                                icon: 'resources/css/images/ico/no.png',
                                                text: 'Удалить  показ'
                                            },
                                            {
                                                xtype: 'checkboxfield',
                                                handler: function(checkbox, checked) {
                                                    var form = checkbox.findParentByType('form');
                                                    if(checked){

                                                        form.down('#delTekPokOrgVod').setDisabled(false);

                                                    }else{

                                                        form.down('#delTekPokOrgVod').setDisabled(true);

                                                    }
                                                },
                                                anchor: '100%',
                                                x: 0,
                                                y: 200,
                                                fieldLabel: 'вкл кнопку',
                                                labelWidth: 80,
                                                name: 'vkl_del'
                                            }
                                        ]
                                    },
                                    {
                                        xtype: 'fieldset',
                                        x: 385,
                                        y: 0,
                                        height: 210,
                                        style: 'background-color: #F1EEEE;',
                                        width: 630,
                                        layout: 'absolute',
                                        title: 'Технічна характеристика',
                                        items: [
                                            {
                                                xtype: 'displayfield',
                                                renderer: function(value, displayField) {
                                                    var retValue = '';
                                                    switch (value) {
                                                        case 'Хвода':
                                                        retValue ='<span><img clas="icon" src="resources/css/images/ico/pipeX.png"/></span>';
                                                        break;
                                                        case 'Гвода':
                                                        retValue ='<span><img clas="icon" src="resources/css/images/ico/pipeGv.png"/></span>';
                                                        break;

                                                    }
                                                    return retValue;
                                                },
                                                x: 0,
                                                y: 0,
                                                height: 42,
                                                width: 50,
                                                fieldLabel: '',
                                                labelSeparator: ' ',
                                                name: 'voda'
                                            },
                                            {
                                                xtype: 'textfield',
                                                x: 55,
                                                y: 10,
                                                width: 95,
                                                fieldLabel: '',
                                                labelWidth: 50,
                                                name: 'vodomer_id',
                                                readOnly: true
                                            },
                                            {
                                                xtype: 'textfield',
                                                x: 150,
                                                y: 10,
                                                padding: '0 5 0 5',
                                                style: '{color: #378005; text-shadow: -1px -1px white, 1px 1px #333;font-size:14pt;}',
                                                width: 245,
                                                fieldLabel: '',
                                                name: 'model',
                                                readOnly: true
                                            },
                                            {
                                                xtype: 'textfield',
                                                x: 410,
                                                y: 10,
                                                padding: '0 5 0 5',
                                                width: 190,
                                                fieldLabel: 'Номер',
                                                labelWidth: 50,
                                                name: 'nomer',
                                                readOnly: true
                                            },
                                            {
                                                xtype: 'textfield',
                                                x: 0,
                                                y: 45,
                                                width: 150,
                                                fieldLabel: 'Место',
                                                labelWidth: 50,
                                                name: 'place',
                                                readOnly: true
                                            },
                                            {
                                                xtype: 'textfield',
                                                x: 375,
                                                y: 80,
                                                padding: '0 5 0 5',
                                                width: 130,
                                                fieldLabel: 'Дводомер',
                                                labelWidth: 70,
                                                name: 'dvodomer_id',
                                                readOnly: true
                                            },
                                            {
                                                xtype: 'datefield',
                                                x: 0,
                                                y: 80,
                                                width: 180,
                                                fieldLabel: 'дата випуску',
                                                labelWidth: 90,
                                                name: 'zdate',
                                                readOnly: true,
                                                altFormats: 'd-m-Y|m/d/Y|n/j/Y|n/j/y|m/j/y|n/d/y|m/j/Y|n/d/Y|m-d-y|m-d-Y|m/d|m-d|md|mdy|mdY|d|Y-m-d|n-j|n/j',
                                                format: 'd-m-Y'
                                            },
                                            {
                                                xtype: 'datefield',
                                                x: 180,
                                                y: 80,
                                                padding: '0 5 0 5',
                                                width: 190,
                                                fieldLabel: 'Дата введення',
                                                name: 'sdate',
                                                readOnly: true,
                                                altFormats: 'd-m-Y|m/d/Y|n/j/Y|n/j/y|m/j/y|n/d/y|m/j/Y|n/d/Y|m-d-y|m-d-Y|m/d|m-d|md|mdy|mdY|d|Y-m-d|n-j|n/j',
                                                format: 'd-m-Y',
                                                submitFormat: 'Ymd'
                                            },
                                            {
                                                xtype: 'textfield',
                                                x: 160,
                                                y: 45,
                                                width: 135,
                                                fieldLabel: 'Позиция',
                                                labelWidth: 60,
                                                name: 'position',
                                                readOnly: true
                                            },
                                            {
                                                xtype: 'displayfield',
                                                renderer: function(value, displayField) {
                                                    var retValue = '';
                                                    //console.log(value);

                                                    switch (value) {
                                                        case 1:
                                                        retValue ='<span><img class="icon" src="resources/css/images/ico/yes.png"/></span>';
                                                        break;
                                                        case 0:
                                                        retValue ='<span><img class="icon" src="resources/css/images/ico/no.png"/></span>';
                                                        break;
                                                    }
                                                    return retValue;
                                                },
                                                x: 510,
                                                y: 45,
                                                width: 90,
                                                fieldLabel: 'Обратка',
                                                labelSeparator: ' ',
                                                labelWidth: 70,
                                                name: 'obr'
                                            },
                                            {
                                                xtype: 'displayfield',
                                                renderer: function(value, displayField) {
                                                    var retValue = '';
                                                    //console.log(value);

                                                    switch (value) {
                                                        case 1:
                                                        retValue ='<span><img class="icon" src="resources/css/images/ico/yes.png"/></span>';
                                                        break;
                                                        case 0:
                                                        retValue ='<span><img class="icon" src="resources/css/images/ico/no.png"/></span>';
                                                        break;
                                                    }
                                                    return retValue;
                                                },
                                                x: 520,
                                                y: 80,
                                                width: 80,
                                                fieldLabel: 'Общий',
                                                labelSeparator: ' ',
                                                labelWidth: 60,
                                                name: 'joint'
                                            },
                                            {
                                                xtype: 'displayfield',
                                                renderer: function(value, displayField) {
                                                    var retValue = '';
                                                    //console.log(value);

                                                    switch (value) {
                                                        case 1:
                                                        retValue ='<span><img class="icon" src="resources/css/images/ico/yes.png"/></span>';
                                                        break;
                                                        case 0:
                                                        retValue ='<span><img class="icon" src="resources/css/images/ico/no.png"/></span>';
                                                        break;
                                                    }
                                                    return retValue;
                                                },
                                                x: 405,
                                                y: 45,
                                                width: 80,
                                                fieldLabel: 'Стоки',
                                                labelSeparator: ' ',
                                                labelWidth: 60,
                                                name: 'st'
                                            },
                                            {
                                                xtype: 'displayfield',
                                                renderer: function(value, displayField) {
                                                    var retValue = '';
                                                    //console.log(value);

                                                    switch (value) {
                                                        case 1:
                                                        retValue ='<span><img class="icon" src="resources/css/images/ico/yes.png"/></span>';
                                                        break;
                                                        case 0:
                                                        retValue ='<span><img class="icon" src="resources/css/images/ico/no.png"/></span>';
                                                        break;
                                                    }
                                                    return retValue;
                                                },
                                                x: 310,
                                                y: 45,
                                                width: 80,
                                                fieldLabel: 'Вода',
                                                labelSeparator: ' ',
                                                labelWidth: 60,
                                                name: 'vd'
                                            },
                                            {
                                                xtype: 'hiddenfield',
                                                x: 565,
                                                y: 115,
                                                width: 120,
                                                fieldLabel: '',
                                                labelWidth: 75,
                                                name: 'type'
                                            },
                                            {
                                                xtype: 'hiddenfield',
                                                x: 559,
                                                y: 106,
                                                width: 160,
                                                fieldLabel: 'Место',
                                                labelWidth: 60,
                                                name: 'house_id'
                                            },
                                            {
                                                xtype: 'fieldset',
                                                x: 5,
                                                y: 115,
                                                height: 60,
                                                style: 'background-color: #f3f3f3;',
                                                width: 595,
                                                layout: 'absolute',
                                                title: 'Поверка',
                                                items: [
                                                    {
                                                        xtype: 'datefield',
                                                        width: 125,
                                                        fieldLabel: 'Попер',
                                                        labelWidth: 45,
                                                        name: 'pdate',
                                                        readOnly: true,
                                                        altFormats: 'd.m.y|d/m/Y|d-m-y|d-m-Y|d/m|d-m|dm|dmy|dmY|d|Y-m-d',
                                                        format: 'd-m-Y'
                                                    },
                                                    {
                                                        xtype: 'datefield',
                                                        x: 135,
                                                        y: 0,
                                                        width: 125,
                                                        fieldLabel: 'Наступ',
                                                        labelWidth: 45,
                                                        name: 'fpdate',
                                                        readOnly: true,
                                                        altFormats: 'd-m-Y|m/d/Y|n/j/Y|n/j/y|m/j/y|n/d/y|m/j/Y|n/d/Y|m-d-y|m-d-Y|m/d|m-d|md|mdy|mdY|d|Y-m-d|n-j|n/j',
                                                        format: 'd-m-Y'
                                                    },
                                                    {
                                                        xtype: 'textfield',
                                                        x: 270,
                                                        y: 0,
                                                        width: 155,
                                                        fieldLabel: 'Пломба',
                                                        labelWidth: 50,
                                                        name: 'plomba'
                                                    },
                                                    {
                                                        xtype: 'displayfield',
                                                        renderer: function(value, displayField) {
                                                            var retValue = '';
                                                            //console.log(value);

                                                            switch (value) {
                                                                case 1:
                                                                retValue ='<span><img class="icon" src="resources/css/images/ico/yes.png"/></span>';
                                                                break;
                                                                case 0:
                                                                retValue ='<span><img class="icon" src="resources/css/images/ico/no.png"/></span>';
                                                                break;
                                                            }
                                                            return retValue;
                                                        },
                                                        x: 440,
                                                        y: 0,
                                                        width: 130,
                                                        fieldLabel: 'Призупинено',
                                                        labelSeparator: ' ',
                                                        labelWidth: 80,
                                                        name: 'paused'
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        xtype: 'datefield',
                                        x: 540,
                                        y: 225,
                                        disabled: true,
                                        width: 180,
                                        fieldLabel: 'Акт розпл',
                                        labelWidth: 65,
                                        name: 'date_ar',
                                        format: 'd-m-Y',
                                        submitFormat: 'Ymd',
                                        listeners: {
                                            select: 'onDatefieldSelect111'
                                        }
                                    },
                                    {
                                        xtype: 'fieldset',
                                        x: 550,
                                        y: 265,
                                        height: 205,
                                        style: 'background-color: #F1EEEE;',
                                        width: 455,
                                        layout: 'absolute',
                                        title: 'Період за середнім',
                                        items: [
                                            {
                                                xtype: 'datefield',
                                                x: 200,
                                                y: 5,
                                                disabled: true,
                                                width: 190,
                                                fieldLabel: 'Дата закінч',
                                                labelWidth: 80,
                                                name: 'data_do',
                                                format: 'd-m-Y',
                                                submitFormat: 'Ymd'
                                            },
                                            {
                                                xtype: 'datefield',
                                                x: 0,
                                                y: 5,
                                                disabled: true,
                                                width: 195,
                                                fieldLabel: 'дата початку',
                                                labelWidth: 85,
                                                name: 'data_ot',
                                                format: 'd-m-Y',
                                                submitFormat: 'Ymd'
                                            },
                                            {
                                                xtype: 'fieldset',
                                                x: 0,
                                                y: 35,
                                                height: 135,
                                                style: 'background-color: #e0e0e0;',
                                                width: 428,
                                                layout: 'absolute',
                                                title: 'Розрахувати за середнім',
                                                items: [
                                                    {
                                                        xtype: 'button',
                                                        handler: function(button, e) {
                                                            // in use
                                                            var me = this;
                                                            //STORE

                                                            var stUser = Ext.data.StoreManager.get("StUser");
                                                            var stWater = Ext.data.StoreManager.get("StOrgWater");
                                                            var stTekPokVodomera = Ext.data.StoreManager.get("StTekPokOrgVodomera");

                                                            var values =stUser.getAt(0);
                                                            var params = {
                                                                login:values.get('login'),
                                                                password:values.get('password'),
                                                                filial_id:values.get('filial_id'),
                                                                house_id:values.get('house_id'),
                                                                what:'insMeedlePokVodOrg'

                                                            };
                                                            //GRID


                                                            //FORMA

                                                            var fmVodomer = Ext.getCmp('fmOrgVodomer');
                                                            var value = fmVodomer.getValues();

                                                            //LOGIKA

                                                            Ext.Object.merge(value, params);
                                                            var newValue = value.newKubov;
                                                            var max = newValue;
                                                            if (isNaN(newValue) || (max.length ===0)){
                                                                Ext.MessageBox.show({
                                                                    title: 'Перевірка даних, що вводяться',
                                                                    msg: 'Введіть число',
                                                                    buttons: Ext.MessageBox.OK,
                                                                    icon: Ext.MessageBox.ERROR
                                                                });
                                                                fmVodomer.getForm().findField('newKubov').focus();

                                                                return false;
                                                            } else if (max <= 0){
                                                                Ext.MessageBox.show({
                                                                    title: 'Перевірка даних, що вводяться',
                                                                    msg: 'Введені свідчення менше або дорівнюють нулю <b>' + max + '</ b> <br> Введіть правильні показяння!.',
                                                                    buttons: Ext.MessageBox.CANCEL,
                                                                    icon: Ext.MessageBox.ERROR,
                                                                    buttonText:{
                                                                        cancel:'скасувати'
                                                                    },
                                                                    fn:function(btn,newValue){
                                                                        if(btn=='cancel'){
                                                                            fmVodomer.getForm().findField('newKubov').focus();
                                                                            return false;
                                                                        }
                                                                    }
                                                                });
                                                            }else if(max > 5) {
                                                                Ext.MessageBox.confirm({
                                                                    title: 'Перевірка даних, що вводяться',
                                                                    msg: 'Введені показання  дуже великі <b>'+ max +'</b> <br>Підтвердіть або скасуйте вводяться свідчення..',
                                                                    buttons: Ext.MessageBox.OKCANCEL,
                                                                    icon: Ext.MessageBox.ERROR,
                                                                    buttonText:{
                                                                        ok:'підтверджую',
                                                                        cancel:'скасувати'
                                                                    },
                                                                    fn:function(btn,newValue){
                                                                        if(btn=='cancel'){
                                                                            fmVodomer.getForm().findField('newKubov').focus();
                                                                            return false;
                                                                        }else{
                                                                            QueryVodomer.newPokVodomera(value,function(results){
                                                                                if (results.success){
                                                                                    fmVodomer.getForm().findField('newKubov').setValue(0);
                                                                                    stWater.load({
                                                                                        params: {
                                                                                            what:'AllPokOVodomera',
                                                                                            what_id: value.filial_id,
                                                                                            filial_id: value.filial_id,
                                                                                            vodomer_id: value.vodomer_id,
                                                                                            login:value.login,
                                                                                            password:value.password
                                                                                        },
                                                                                        scope:this
                                                                                    });
                                                                                    stTekPokTeplomera.load({
                                                                                        params: {
                                                                                            what:'TekPokOVodomera',
                                                                                            what_id: value.filial_id,
                                                                                            filial_id: value.filial_id,
                                                                                            vodomer_id: value.vodomer_id,
                                                                                            login:value.login,
                                                                                            password:value.password
                                                                                        },
                                                                                        callback: function(records,operation,success){
                                                                                            if(success){
                                                                                                fmVodomer.getForm().loadRecord(records[0]);
                                                                                            }
                                                                                        },
                                                                                        scope:this
                                                                                    });
                                                                                }
                                                                            });
                                                                        }
                                                                    }
                                                                });


                                                            } else {
                                                                QueryVodomer.newPokVodomera(value,function(results){
                                                                    if (results.success){

                                                                        fmVodomer.getForm().findField('newKubov').setValue(0);
                                                                        stWater.load({
                                                                            params: {
                                                                                what:'AllPokOVodomera',
                                                                                what_id: value.filial_id,
                                                                                filial_id: value.filial_id,
                                                                                vodomer_id: value.vodomer_id,
                                                                                login:value.login,
                                                                                password:value.password
                                                                            },
                                                                            scope:this
                                                                        });
                                                                        stTekPokTeplomera.load({
                                                                            params: {
                                                                                what:'TekPokOVodomera',
                                                                                what_id: value.filial_id,
                                                                                filial_id: value.filial_id,
                                                                                vodomer_id: value.vodomer_id,
                                                                                login:value.login,
                                                                                password:value.password
                                                                            },
                                                                            callback: function(records,operation,success){
                                                                                if(success){
                                                                                    fmVodomer.getForm().loadRecord(records[0]);
                                                                                }
                                                                            },
                                                                            scope:this
                                                                        });

                                                                    }
                                                                });
                                                            }

                                                        },
                                                        x: 305,
                                                        y: 70,
                                                        shadowOffset: 2,
                                                        border: '2px',
                                                        disabled: true,
                                                        id: 'insMeedlePokVodOrg',
                                                        width: 100,
                                                        icon: 'resources/css/images/ico/yes22.png',
                                                        text: 'Записати'
                                                    },
                                                    {
                                                        xtype: 'numberfield',
                                                        x: 135,
                                                        y: 70,
                                                        shadowOffset: 1,
                                                        disabled: true,
                                                        width: 165,
                                                        fieldLabel: 'Кубів за серед',
                                                        labelWidth: 95,
                                                        name: 'newKubov',
                                                        value: 0,
                                                        allowBlank: false,
                                                        hideTrigger: true,
                                                        selectOnFocus: true,
                                                        autoStripChars: true,
                                                        minValue: 0,
                                                        negativeText: 'Значение должно быть больше 1'
                                                    },
                                                    {
                                                        xtype: 'numberfield',
                                                        x: 0,
                                                        y: 70,
                                                        shadowOffset: 1,
                                                        disabled: true,
                                                        width: 130,
                                                        fieldLabel: 'Днів за серед',
                                                        labelWidth: 90,
                                                        name: 'days',
                                                        value: 0,
                                                        allowBlank: false,
                                                        hideTrigger: true,
                                                        selectOnFocus: true,
                                                        allowDecimals: false,
                                                        autoStripChars: true,
                                                        decimalPrecision: 0,
                                                        minValue: 0,
                                                        negativeText: 'Значение должно быть больше 1'
                                                    },
                                                    {
                                                        xtype: 'numberfield',
                                                        x: 0,
                                                        y: 5,
                                                        shadowOffset: 1,
                                                        disabled: true,
                                                        width: 190,
                                                        fieldLabel: 'показання від',
                                                        labelWidth: 90,
                                                        name: 'pok_ot',
                                                        value: 0,
                                                        allowBlank: false,
                                                        hideTrigger: true,
                                                        selectOnFocus: true,
                                                        autoStripChars: true,
                                                        decimalPrecision: 3,
                                                        minValue: 0,
                                                        negativeText: 'Значение должно быть больше 1'
                                                    },
                                                    {
                                                        xtype: 'numberfield',
                                                        x: 205,
                                                        y: 5,
                                                        shadowOffset: 1,
                                                        disabled: true,
                                                        width: 200,
                                                        fieldLabel: 'показання до',
                                                        labelWidth: 90,
                                                        name: 'pok_do',
                                                        value: 0,
                                                        allowBlank: false,
                                                        hideTrigger: true,
                                                        selectOnFocus: true,
                                                        autoStripChars: true,
                                                        decimalPrecision: 3,
                                                        minValue: 0,
                                                        negativeText: 'Значение должно быть больше 1'
                                                    },
                                                    {
                                                        xtype: 'numberfield',
                                                        x: 0,
                                                        y: 35,
                                                        shadowOffset: 1,
                                                        disabled: true,
                                                        width: 115,
                                                        fieldLabel: 'Кільк днів',
                                                        labelWidth: 70,
                                                        name: 'rday',
                                                        value: 0,
                                                        allowBlank: false,
                                                        hideTrigger: true,
                                                        selectOnFocus: true,
                                                        allowDecimals: false,
                                                        autoStripChars: true,
                                                        decimalPrecision: 0,
                                                        minValue: 0,
                                                        negativeText: 'Значение должно быть больше 1'
                                                    },
                                                    {
                                                        xtype: 'numberfield',
                                                        x: 120,
                                                        y: 35,
                                                        shadowOffset: 1,
                                                        disabled: true,
                                                        width: 135,
                                                        fieldLabel: 'Куб разр',
                                                        labelWidth: 70,
                                                        name: 'qty_kub',
                                                        value: 0,
                                                        allowBlank: false,
                                                        hideTrigger: true,
                                                        selectOnFocus: true,
                                                        autoStripChars: true,
                                                        minValue: 0
                                                    },
                                                    {
                                                        xtype: 'numberfield',
                                                        x: 265,
                                                        y: 35,
                                                        shadowOffset: 1,
                                                        disabled: true,
                                                        width: 140,
                                                        fieldLabel: 'Кубів/Дн',
                                                        labelWidth: 60,
                                                        name: 'kub_day',
                                                        value: 0,
                                                        allowBlank: false,
                                                        hideTrigger: true,
                                                        selectOnFocus: true,
                                                        autoStripChars: true,
                                                        decimalPrecision: 3
                                                    }
                                                ]
                                            },
                                            {
                                                xtype: 'button',
                                                handler: function(button, e) {
                                                    // in use
                                                    //var me = this;
                                                    //STORE

                                                    var stUser = Ext.data.StoreManager.get("StUser");
                                                    //LOGIN & PASSWORD
                                                    var fmVodomer = Ext.getCmp('fmOrgVodomer');
                                                    var vodomer_id = fmVodomer.getForm().findField('vodomer_id');
                                                    var insMeedlePokVod = fmVodomer.down('#insMeedlePokVodOrg');
                                                    var date_ot = fmVodomer.getForm().findField('data_ot');
                                                    var date_do = fmVodomer.getForm().findField('data_do');
                                                    var days = fmVodomer.getForm().findField('days');
                                                    var pok_ot = fmVodomer.getForm().findField('pok_ot');
                                                    var pok_do = fmVodomer.getForm().findField('pok_do');
                                                    var rday = fmVodomer.getForm().findField('rday');
                                                    var kub_day = fmVodomer.getForm().findField('kub_day');
                                                    var newKubov = fmVodomer.getForm().findField('newKubov');
                                                    var qty_kub = fmVodomer.getForm().findField('qty_kub');

                                                    var value = fmVodomer.getValues();


                                                    var values =stUser.getAt(0);
                                                    var params = {
                                                        login:values.get('login'),
                                                        password:values.get('password'),
                                                        address_id:values.get('address_id'),
                                                        address:values.get('address'),
                                                        what:"AddMeedlePokVodOrg"
                                                    };
                                                    Ext.Object.merge(value, params);
                                                    QueryVodomer.updateVodomer(value,function(results){
                                                        if (results.success){

                                                            date_ot.setDisabled(false);
                                                            date_do.setDisabled(false);
                                                            pok_do.setDisabled(false);
                                                            pok_ot.setDisabled(false);
                                                            days.setDisabled(false);
                                                            rday.setDisabled(false);
                                                            kub_day.setDisabled(false);
                                                            newKubov.setDisabled(false);
                                                            qty_kub.setDisabled(false);

                                                            insMeedlePokVod.setDisabled(false);
                                                            date_ot.setValue(results.data_ot);
                                                            date_do.setValue(results.data_do);
                                                            pok_ot.setValue(results.pok_ot);
                                                            pok_do.setValue(results.pok_do);
                                                            rday.setValue(results.rday);
                                                            kub_day.setValue(results.kub_day);
                                                            days.setValue(results.days);
                                                            qty_kub.setValue(results.qty_kub);
                                                            newKubov.setValue(results.kubov);
                                                        } else {
                                                            Ext.MessageBox.show({
                                                                title: 'Розрахунок за середнім',
                                                                msg: results.msg,
                                                                buttons: Ext.MessageBox.OK,
                                                                icon: Ext.MessageBox.INFO
                                                            });
                                                        }
                                                    });

                                                },
                                                x: 400,
                                                y: 0,
                                                shadowOffset: 2,
                                                id: 'AddMeedlePokVodOrg',
                                                icon: 'resources/css/images/ico/schet.png',
                                                scale: 'medium',
                                                text: '',
                                                tooltip: 'Нарахувати за середнім',
                                                tooltipType: 'title'
                                            }
                                        ]
                                    },
                                    {
                                        xtype: 'fieldset',
                                        x: 5,
                                        y: 325,
                                        height: 145,
                                        style: 'background-color: #F1EEEE;',
                                        width: 375,
                                        layout: 'absolute',
                                        title: 'Введення нових показань',
                                        items: [
                                            {
                                                xtype: 'fieldset',
                                                x: 5,
                                                y: 10,
                                                height: 85,
                                                style: 'background-color: #f3f3f3;',
                                                width: 160,
                                                title: 'Попередні',
                                                items: [
                                                    {
                                                        xtype: 'datefield',
                                                        anchor: '100%',
                                                        fieldLabel: 'Дата',
                                                        labelWidth: 50,
                                                        name: 'date_old',
                                                        readOnly: true,
                                                        format: 'd-m-Y',
                                                        submitFormat: 'Ymd'
                                                    },
                                                    {
                                                        xtype: 'numberfield',
                                                        anchor: '100%',
                                                        fieldLabel: 'Показ',
                                                        labelWidth: 50,
                                                        name: 'tek',
                                                        readOnly: true,
                                                        hideTrigger: true,
                                                        autoStripChars: true,
                                                        decimalPrecision: 3
                                                    }
                                                ]
                                            },
                                            {
                                                xtype: 'fieldset',
                                                x: 170,
                                                y: 0,
                                                height: 115,
                                                style: 'background-color: #f3f3f3;',
                                                width: 180,
                                                title: 'Нове',
                                                items: [
                                                    {
                                                        xtype: 'datefield',
                                                        anchor: '100%',
                                                        fieldLabel: 'Дата',
                                                        labelWidth: 50,
                                                        name: 'date_new',
                                                        allowBlank: false,
                                                        format: 'd-m-Y',
                                                        submitFormat: 'Ymd'
                                                    },
                                                    {
                                                        xtype: 'numberfield',
                                                        anchor: '100%',
                                                        formBind: false,
                                                        shadowOffset: 1,
                                                        id: 'newPokOrgVod',
                                                        fieldLabel: 'Показ',
                                                        labelWidth: 50,
                                                        name: 'newValue',
                                                        value: 0,
                                                        allowBlank: false,
                                                        hideTrigger: true,
                                                        selectOnFocus: true,
                                                        autoStripChars: true,
                                                        decimalPrecision: 3,
                                                        minValue: 0,
                                                        negativeText: 'Значение должно быть больше 1'
                                                    },
                                                    {
                                                        xtype: 'button',
                                                        handler: function(button, e) {
                                                            // in use
                                                            var me = this;
                                                            //STORE

                                                            var stUser = Ext.data.StoreManager.get("StUser");
                                                            var stWater = Ext.data.StoreManager.get("StOrgWater");
                                                            var stTekPokVodomera = Ext.data.StoreManager.get("StTekPokOrgVodomera");


                                                            //LOGIN & PASSWORD

                                                            var values =stUser.getAt(0);
                                                            var params = {
                                                                login:values.get('login'),
                                                                password:values.get('password'),
                                                                filial_id:values.get('filial_id'),
                                                                house_id:values.get('house_id'),
                                                                what:'OVodomer'
                                                            };
                                                            //FORMA
                                                            var fmVodomer = Ext.getCmp('fmOrgVodomer');
                                                            var value = fmVodomer.getValues();
                                                            //LOGIKA


                                                            Ext.Object.merge(value, params);
                                                            var newValue = value.newValue;
                                                            var max =newValue - value.tek;
                                                            if (isNaN(newValue) || (max.length ===0)){
                                                                Ext.MessageBox.show({
                                                                    title: 'Перевірка даних, що вводяться',
                                                                    msg: 'Введіть число',
                                                                    buttons: Ext.MessageBox.OK,
                                                                    icon: Ext.MessageBox.ERROR
                                                                });
                                                                fmVodomer.down('#newPokOrgVod').focus();

                                                                return false;
                                                            }else if (max<=0){
                                                                Ext.MessageBox.show({
                                                                    title: 'Перевірка даних, що вводяться',
                                                                    msg: 'Введені свідчення менше або дорівнюють нулю <b>' + max + '</ b> <br> Введіть правильні показяння!.',
                                                                    buttons: Ext.MessageBox.CANCEL,
                                                                    icon: Ext.MessageBox.ERROR,
                                                                    buttonText:{
                                                                        cancel:'скасувати'
                                                                    },
                                                                    fn:function(btn,newValue){
                                                                        if(btn=='cancel'){
                                                                            fmVodomer.down('#newPokOrgVod').focus();
                                                                            return false;
                                                                        }
                                                                    }
                                                                });
                                                            } else if(max > 5) {
                                                                Ext.MessageBox.confirm({
                                                                    title: 'Перевірка даних, що вводяться',
                                                                    msg: 'Введені показання  дуже великі <b>'+ max +'</b> <br>Підтвердіть або скасуйте вводяться свідчення..',
                                                                    buttons: Ext.MessageBox.OKCANCEL,
                                                                    icon: Ext.MessageBox.ERROR,
                                                                    buttonText:{
                                                                        ok:'підтверджую',
                                                                        cancel:'скасувати'
                                                                    },
                                                                    fn:function(btn,newValue){
                                                                        if(btn=='cancel'){
                                                                            fmVodomer.down('#newPokOrgVod').focus();
                                                                            return false;
                                                                        } else {
                                                                            QueryVodomer.newPokVodomera(value,function(data){
                                                                                if (data.success){
                                                                                    Ext.MessageBox.confirm({
                                                                                        title: 'Перевірка даних, що вводяться',
                                                                                        msg: 'Нові показання введені',
                                                                                        buttons: Ext.MessageBox.OK,
                                                                                        icon: Ext.MessageBox.INFO
                                                                                    });
                                                                                    fmVodomer.down('#newPokOrgVod').setValue(0);

                                                                                    stTekPokVodomera.load({
                                                                                        params: {
                                                                                            what:'TekPokOVodomera',
                                                                                            what_id: value.filial_id,
                                                                                            filial_id: value.filial_id,
                                                                                            vodomer_id: value.vodomer_id,
                                                                                            login:value.login,
                                                                                            password:value.password
                                                                                        },
                                                                                        callback: function(records,operation,success){
                                                                                            if(success){
                                                                                                fmVodomer.getForm().loadRecord(records[0]);
                                                                                            }
                                                                                        },
                                                                                        scope:this
                                                                                    });
                                                                                    stWater.load({
                                                                                        params: {
                                                                                            login:value.login,
                                                                                            password:value.password,
                                                                                            filial_id: value.filial_id,
                                                                                            what:'AllPokOVodomera',
                                                                                            what_id: value.vodomer_id,
                                                                                            vodomer_id: value.vodomer_id
                                                                                        },
                                                                                        scope:this
                                                                                    });

                                                                                }
                                                                            });
                                                                        }
                                                                    }
                                                                });
                                                            } else {
                                                                QueryVodomer.newPokVodomera(value,function(data){
                                                                    if (data.success){
                                                                        Ext.MessageBox.confirm({
                                                                            title: 'Перевірка даних, що вводяться',
                                                                            msg: 'Нові показання введені',
                                                                            buttons: Ext.MessageBox.OK,
                                                                            icon: Ext.MessageBox.INFO
                                                                        });
                                                                        fmVodomer.down('#newPokOrgVod').setValue(0);

                                                                        stTekPokVodomera.load({
                                                                            params: {
                                                                                what:'TekPokOVodomera',
                                                                                what_id: value.filial_id,
                                                                                filial_id: value.filial_id,
                                                                                vodomer_id: value.vodomer_id,
                                                                                login:value.login,
                                                                                password:value.password
                                                                            },
                                                                            callback: function(records,operation,success){
                                                                                if(success){
                                                                                    fmVodomer.getForm().loadRecord(records[0]);
                                                                                }
                                                                            },
                                                                            scope:this
                                                                        });
                                                                        stWater.load({
                                                                            params: {
                                                                                login:value.login,
                                                                                password:value.password,
                                                                                filial_id: value.filial_id,
                                                                                what:'AllPokOVodomera',
                                                                                what_id: value.vodomer_id,
                                                                                vodomer_id: value.vodomer_id
                                                                            },
                                                                            scope:this
                                                                        });

                                                                    }
                                                                });
                                                            }


                                                        },
                                                        anchor: '100%',
                                                        shadowOffset: 2,
                                                        disabled: true,
                                                        id: 'insTekPokOrgVod',
                                                        width: 115,
                                                        icon: 'resources/css/images/ico/yes22.png',
                                                        text: 'Записати'
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        xtype: 'datefield',
                                        x: 725,
                                        y: 225,
                                        disabled: true,
                                        width: 180,
                                        fieldLabel: 'Акт оплом',
                                        labelWidth: 70,
                                        name: 'date_ao',
                                        format: 'd-m-Y',
                                        submitFormat: 'Ymd',
                                        listeners: {
                                            select: 'onDatefieldSelect21'
                                        }
                                    },
                                    {
                                        xtype: 'button',
                                        handler: function(button, e) {
                                            var form = button.findParentByType('form');
                                            var value = form.getValues();
                                            var stUser = Ext.data.StoreManager.get("StUser");

                                            //LOGIN & PASSWORD

                                            var values =stUser.getAt(0);
                                            var params = {
                                                login:values.get('login'),
                                                password:values.get('password'),
                                                what:"insPoverkaOrg"
                                            };

                                            Ext.Object.merge(value, params);

                                            var myMask= Ext.Msg.show({
                                                title:'Оновлення приладу обліку...',
                                                msg: 'Введення дати розпломбування приладу обліку.Чекайте...',
                                                buttons: Ext.Msg.CANCEL,
                                                wait: true,
                                                modal: true,
                                                icon: Ext.Msg.INFO
                                            });
                                            QueryVodomer.updateVodomer(value,function(results){
                                                if (results.success){
                                                    Ext.MessageBox.show({
                                                        title: 'Оновлення приладу обліку',
                                                        msg: results.msg,
                                                        buttons: Ext.MessageBox.OK,
                                                        icon: Ext.MessageBox.INFO
                                                    });

                                                }else{
                                                    Ext.MessageBox.show({
                                                        title: 'Оновлення приладу обліку',
                                                        msg: results.msg,
                                                        buttons: Ext.MessageBox.OK,
                                                        icon: Ext.MessageBox.ERROR
                                                    });
                                                }
                                                //myMask.close();

                                            });

                                        },
                                        x: 915,
                                        y: 225,
                                        shadowOffset: 2,
                                        border: '2px',
                                        disabled: true,
                                        id: 'InsPoverkaOrg',
                                        width: 95,
                                        icon: 'resources/css/images/ico/yes22.png',
                                        text: 'Записати'
                                    }
                                ]
                            },
                            {
                                xtype: 'gridpanel',
                                id: 'grAllPokOrgVod',
                                margin: '5 0 0 0',
                                width: 1030,
                                title: 'Історія показань приладів обліку води',
                                emptyText: 'Нет показаний по прибору учета',
                                store: 'StOrgWater',
                                viewConfig: {
                                    getRowClass: function(record, rowIndex, rowParams, store) {
                                        if(record.get('avg') === 5 ){
                                            return  'change_color';
                                        }
                                        else if(record.get('avg') === 1 ){
                                            return  'change_color_yellow';
                                        }
                                        else if(record.get('avg') === 2 ){
                                            return  'change_color_yellow';
                                        }
                                        else if(record.get('avg') === 3 ){
                                            return  'change_color_yellow';
                                        }
                                        else if(record.get('avg') === 4 ){
                                            return  'change_color_red';
                                        }

                                    }
                                },
                                columns: [
                                    {
                                        xtype: 'numbercolumn',
                                        hidden: true,
                                        dataIndex: 'address_id',
                                        text: 'Address_id'
                                    },
                                    {
                                        xtype: 'gridcolumn',
                                        hidden: true,
                                        dataIndex: 'period',
                                        text: 'Address'
                                    },
                                    {
                                        xtype: 'numbercolumn',
                                        hidden: true,
                                        dataIndex: 'nomer',
                                        text: 'Nomer'
                                    },
                                    {
                                        xtype: 'datecolumn',
                                        hidden: true,
                                        dataIndex: 'data',
                                        text: 'Data',
                                        format: 'd-m-y'
                                    },
                                    {
                                        xtype: 'numbercolumn',
                                        width: 76,
                                        dataIndex: 'pok_id',
                                        menuDisabled: true,
                                        text: 'Ид пок',
                                        format: '0'
                                    },
                                    {
                                        xtype: 'gridcolumn',
                                        menuDisabled: true,
                                        text: 'Период',
                                        columns: [
                                            {
                                                xtype: 'datecolumn',
                                                width: 90,
                                                dataIndex: 'date_ot',
                                                menuDisabled: true,
                                                text: 'Поперед',
                                                format: 'd-m-Y'
                                            },
                                            {
                                                xtype: 'datecolumn',
                                                width: 90,
                                                dataIndex: 'date_do',
                                                menuDisabled: true,
                                                text: 'Поточне',
                                                format: 'd-m-Y'
                                            },
                                            {
                                                xtype: 'numbercolumn',
                                                width: 53,
                                                dataIndex: 'days',
                                                menuDisabled: true,
                                                text: 'дней',
                                                format: '0'
                                            }
                                        ]
                                    },
                                    {
                                        xtype: 'gridcolumn',
                                        menuDisabled: true,
                                        text: 'Показання по приладу обліку',
                                        columns: [
                                            {
                                                xtype: 'numbercolumn',
                                                width: 80,
                                                dataIndex: 'pred',
                                                menuDisabled: true,
                                                text: 'Поперед',
                                                format: '0'
                                            },
                                            {
                                                xtype: 'numbercolumn',
                                                width: 80,
                                                dataIndex: 'tek',
                                                menuDisabled: true,
                                                text: 'Поточне',
                                                format: '0'
                                            },
                                            {
                                                xtype: 'numbercolumn',
                                                width: 65,
                                                dataIndex: 'kub',
                                                menuDisabled: true,
                                                text: 'Кубов',
                                                format: '0'
                                            }
                                        ]
                                    },
                                    {
                                        xtype: 'gridcolumn',
                                        menuDisabled: true,
                                        text: 'За середнім',
                                        columns: [
                                            {
                                                xtype: 'numbercolumn',
                                                width: 80,
                                                dataIndex: 'pok_ot',
                                                menuDisabled: true,
                                                text: 'Поперед',
                                                format: '0'
                                            },
                                            {
                                                xtype: 'numbercolumn',
                                                width: 80,
                                                dataIndex: 'pok_do',
                                                menuDisabled: true,
                                                text: 'Поточне',
                                                format: '0'
                                            },
                                            {
                                                xtype: 'numbercolumn',
                                                width: 70,
                                                dataIndex: 'qty_kub',
                                                menuDisabled: true,
                                                text: 'Куб раз',
                                                format: '0'
                                            },
                                            {
                                                xtype: 'numbercolumn',
                                                width: 65,
                                                dataIndex: 'rday',
                                                menuDisabled: true,
                                                text: 'Дней',
                                                format: '0'
                                            },
                                            {
                                                xtype: 'numbercolumn',
                                                width: 88,
                                                dataIndex: 'kub_day',
                                                menuDisabled: true,
                                                text: 'Куб/день',
                                                format: '0.0000'
                                            }
                                        ]
                                    },
                                    {
                                        xtype: 'gridcolumn',
                                        width: 99,
                                        dataIndex: 'operator',
                                        menuDisabled: true,
                                        text: 'оператор'
                                    }
                                ],
                                tools: [
                                    {
                                        xtype: 'tool',
                                        callback: function(owner, tool, event) {
                                            //in use
                                            var grid = tool.findParentByType('grid');
                                            var fmVodomer = Ext.getCmp('fmOrgVodomer');
                                            var vodomer_id = fmVodomer.getForm().findField('vodomer_id').getValue();
                                            //STORE
                                            var stUser = Ext.data.StoreManager.get("StUser");
                                            var stWater = Ext.data.StoreManager.get("StOrgWater");
                                            //LOGIN & PASSWORD
                                            var values =stUser.getAt(0);

                                            //LOGIKA
                                            if(!Ext.isEmpty(vodomer_id)){
                                                stWater.removeAll();
                                                stWater.load({
                                                    params: {
                                                        login:values.get('login'),
                                                        password:values.get('password'),
                                                        filial_id:values.get('filial_id'),
                                                        what:'AllPokOVodomeraAll',
                                                        what_id: values.get('filial_id'),
                                                        vodomer_id: vodomer_id
                                                    },
                                                    callback: function(records,operation,success){
                                                        if(success){
                                                            //console.log(grid);
                                                            grid.getView().refresh();
                                                        }
                                                    },
                                                    scope:this
                                                });
                                            }else{
                                                Ext.MessageBox.show({
                                                    title: 'Просмотр истории показаний cчетчика воды',
                                                    msg: "Выберите счетчик воды",
                                                    buttons: Ext.MessageBox.OK,
                                                    icon: Ext.MessageBox.INFO
                                                });
                                            }
                                        },
                                        tooltip: 'Завантажити все показання приладу обліку',
                                        tooltipType: 'title',
                                        type: 'search'
                                    }
                                ]
                            }
                        ]
                    }
                ]
            };
        if (instanceConfig) {
            me.getConfigurator().merge(me, config, instanceConfig);
        }
        return me.callParent([config]);
    }

});