/*
 * File: app/view/flat/TabAppTeplomer.js
 * Date: Sat Jan 16 2021 16:47:15 GMT+0200 (EET)
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Ykis.view.flat.TabAppTeplomer', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.tabappteplomer',

    requires: [
        'Ykis.view.flat.TabAppTeplomerViewModel',
        'Ykis.view.flat.TabAppTeplomerViewController',
        'Ext.form.Panel',
        'Ext.grid.Panel',
        'Ext.view.Table',
        'Ext.grid.column.Action',
        'Ext.grid.column.Number',
        'Ext.grid.column.Date',
        'Ext.form.FieldSet',
        'Ext.button.Button',
        'Ext.selection.CheckboxModel',
        'Ext.form.field.Date',
        'Ext.form.field.Number',
        'Ext.panel.Tool'
    ],

    controller: 'tabappteplomer',
    viewModel: {
        type: 'tabappteplomer'
    },
    id: 'tabAppTeplomer',
    layout: 'fit',
    title: 'Тепломір',

    items: [
        {
            xtype: 'form',
            id: 'fmAppTeplomer',
            scrollable: true,
            style: '',
            width: 1040,
            bodyPadding: 5,
            icon: '',
            title: 'Поточне показання квартирного тепломіра',
            items: [
                {
                    xtype: 'gridpanel',
                    id: 'grAppHTeplomer',
                    margin: '0 0 10 0',
                    width: 1046,
                    collapsed: true,
                    collapsible: true,
                    title: 'Прилади обліку теплової енергії зняті з обліку',
                    titleCollapse: true,
                    store: 'StHTeplomer',
                    columns: [
                        {
                            xtype: 'actioncolumn',
                            width: 40,
                            menuDisabled: true,
                            items: [
                                {
                                    handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                        // in use
                                        var me = this;
                                        //STORE

                                        var stUser = Ext.data.StoreManager.get("StUser");
                                        var stTeplomer = Ext.data.StoreManager.get("StTeplomer");

                                        //LOGIN & PASSWORD

                                        var values =stUser.getAt(0);
                                        var params = {
                                            login:values.get('login'),
                                            password:values.get('password'),
                                            address_id:values.get('address_id'),
                                            house_id:values.get('house_id'),
                                            what:'back_spisan_ateplomer'
                                        };
                                        //GRID
                                        var stHTeplomer = view.getStore();
                                        var value = stHTeplomer.getAt(rowIndex).data;
                                        var grAppTeplomer = Ext.getCmp('grAppTeplomer');

                                        //LOGIKA

                                        Ext.Object.merge(value, params);
                                        //console.log(value);

                                        Ext.MessageBox.confirm({
                                            title: 'Повернення приладу обліку з історії',
                                            msg: 'Ви повертаєте прилад обліку з історії <br> Підтвердіть або скасуйте свої дії.',
                                            buttons: Ext.MessageBox.OKCANCEL,
                                            icon: Ext.MessageBox.INFO,
                                            buttonText:{
                                                ok:'підтверджую',
                                                cancel:'скасувати'
                                            },
                                            fn:function(btn,newValue){
                                                if(btn=='ok'){
                                                    QueryTeplomer.outTeplomerHistory(value,function(results){
                                                        if (results.success==="1"){

                                                            stHTeplomer.load({
                                                                params: {
                                                                    what:'AppHTeplomer',
                                                                    address_id: value.address_id,
                                                                    login:value.login,
                                                                    password:value.password
                                                                },
                                                                scope:this
                                                            });
                                                            stTeplomer.load({
                                                                params: {
                                                                    what:'AppTeplomer',
                                                                    address_id: value.address_id,
                                                                    teplomer_id: value.teplomer_id,
                                                                    login:value.login,
                                                                    password:value.password
                                                                },
                                                                scope:this
                                                            });
                                                            grAppTeplomer.getView().getSelectionModel().deselectAll();

                                                            Ext.MessageBox.show({
                                                                title: 'Повернення приладу обліку з історії',
                                                                msg: results.msg,
                                                                buttons: Ext.MessageBox.OK,
                                                                icon: Ext.MessageBox.INFO
                                                            });

                                                        } else {
                                                            Ext.MessageBox.show({
                                                                title: 'Повернення приладу обліку з історії',
                                                                msg: results.msg,
                                                                buttons: Ext.MessageBox.OK,
                                                                icon: Ext.MessageBox.ERROR
                                                            });
                                                        }
                                                    });
                                                }
                                            }
                                        });
                                    },
                                    getClass: function(v, metadata, r, rowIndex, colIndex, store) {
                                        metaData = 'x-grid-center-icon';
                                        return metaData;
                                    },
                                    icon: 'resources/css/images/ico/door_out.png',
                                    tooltip: 'Повернення приладу обліку з історії'
                                }
                            ]
                        },
                        {
                            xtype: 'gridcolumn',
                            menuDisabled: true,
                            text: 'Характеристика приладу обліку',
                            columns: [
                                {
                                    xtype: 'numbercolumn',
                                    width: 70,
                                    align: 'center',
                                    dataIndex: 'teplomer_id',
                                    menuDisabled: true,
                                    text: 'Ид',
                                    format: '0'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    width: 148,
                                    align: 'center',
                                    dataIndex: 'model',
                                    menuDisabled: true,
                                    text: 'Модель'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    width: 98,
                                    align: 'center',
                                    dataIndex: 'nomer',
                                    menuDisabled: true,
                                    text: 'Номер'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    width: 82,
                                    align: 'center',
                                    dataIndex: 'edizm',
                                    menuDisabled: true,
                                    text: 'Од. вим.'
                                },
                                {
                                    xtype: 'numbercolumn',
                                    width: 68,
                                    align: 'center',
                                    dataIndex: 'koef',
                                    menuDisabled: true,
                                    text: 'Коеф',
                                    format: '0,000.000'
                                }
                            ]
                        },
                        {
                            xtype: 'gridcolumn',
                            menuDisabled: true,
                            text: 'Дата',
                            columns: [
                                {
                                    xtype: 'datecolumn',
                                    width: 85,
                                    align: 'center',
                                    dataIndex: 'zdate',
                                    menuDisabled: true,
                                    text: 'Випуску',
                                    format: 'd-m-Y'
                                },
                                {
                                    xtype: 'datecolumn',
                                    width: 85,
                                    align: 'center',
                                    dataIndex: 'sdate',
                                    menuDisabled: true,
                                    text: 'Введен',
                                    format: 'd-m-Y'
                                },
                                {
                                    xtype: 'datecolumn',
                                    width: 85,
                                    align: 'center',
                                    dataIndex: 'data_spis',
                                    menuDisabled: true,
                                    text: 'Списан',
                                    format: 'd-m-Y'
                                }
                            ]
                        },
                        {
                            xtype: 'gridcolumn',
                            menuDisabled: true,
                            text: 'Поверка',
                            columns: [
                                {
                                    xtype: 'datecolumn',
                                    width: 90,
                                    align: 'center',
                                    dataIndex: 'pdate',
                                    menuDisabled: true,
                                    text: 'Остання',
                                    format: 'd-m-Y'
                                },
                                {
                                    xtype: 'datecolumn',
                                    width: 85,
                                    align: 'center',
                                    dataIndex: 'fpdate',
                                    menuDisabled: true,
                                    text: 'Наступна',
                                    format: 'd-m-Y'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    width: 82,
                                    align: 'center',
                                    dataIndex: 'plomba',
                                    menuDisabled: true,
                                    text: 'Пломба'
                                }
                            ]
                        },
                        {
                            xtype: 'gridcolumn',
                            width: 90,
                            align: 'center',
                            dataIndex: 'operator',
                            menuDisabled: true,
                            text: 'Оператор'
                        },
                        {
                            xtype: 'actioncolumn',
                            width: 40,
                            menuDisabled: true,
                            items: [
                                {
                                    getClass: function(v, metadata, r, rowIndex, colIndex, store) {
                                        metaData = 'x-grid-center-icon';
                                        return metaData;
                                    },
                                    handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                        // in use
                                        var me = this;
                                        //STORE

                                        var stUser = Ext.data.StoreManager.get("StUser");
                                        //LOGIN & PASSWORD

                                        var values =stUser.getAt(0);
                                        var params = {
                                            login:values.get('login'),
                                            password:values.get('password'),
                                            address_id:values.get('address_id'),
                                            house_id:values.get('house_id'),
                                            what:'delete_ateplomer'
                                        };
                                        //GRID
                                        var stHTeplomer = view.getStore();
                                        var value = stHTeplomer.getAt(rowIndex).data;

                                        //LOGIKA

                                        Ext.Object.merge(value, params);
                                        //console.log(value);

                                        Ext.MessageBox.confirm({
                                            title: 'Видалення приладу обліку безповоротно',
                                            msg: 'Ви безповоротно видаляєте прилад обліку<br>Підтвердіть або скасуйте свої дії.',
                                            buttons: Ext.MessageBox.OKCANCEL,
                                            icon: Ext.MessageBox.ERROR,
                                            buttonText:{
                                                ok:'підтверджую',
                                                cancel:'скасувати'
                                            },
                                            fn:function(btn,newValue){
                                                if(btn=='ok'){
                                                    QueryTeplomer.delTeplomer(value,function(results){
                                                        if (results.success==="1"){

                                                            stHTeplomer.load({
                                                                params: {
                                                                    what:'AppHTeplomer',
                                                                    address_id: value.address_id,
                                                                    login:value.login,
                                                                    password:value.password
                                                                },
                                                                scope:this
                                                            });
                                                            // view.refresh();
                                                            Ext.MessageBox.show({
                                                                title: 'Видалення приладу обліку безповоротно',
                                                                msg: results.msg,
                                                                buttons: Ext.MessageBox.OK,
                                                                icon: Ext.MessageBox.INFO
                                                            });
                                                        }
                                                    });
                                                }
                                            }
                                        });
                                    },
                                    icon: 'resources/css/images/ico/no.png',
                                    tooltip: 'Видалити прилад обліку безповоротно'
                                }
                            ]
                        }
                    ]
                },
                {
                    xtype: 'fieldset',
                    height: 455,
                    style: 'background-color: #DCDCDC;',
                    width: 1040,
                    layout: 'absolute',
                    title: '',
                    items: [
                        {
                            xtype: 'button',
                            x: 35,
                            y: 185,
                            formBind: false,
                            height: 25,
                            id: 'addAppTeplomer',
                            width: 320,
                            icon: 'resources/css/images/ico/add.png',
                            text: 'Додати прилад обліку теплової енергії'
                        },
                        {
                            xtype: 'gridpanel',
                            x: 5,
                            y: 5,
                            height: 165,
                            id: 'grAppTeplomer',
                            width: 405,
                            title: 'Пилади обліку теплової енергії',
                            store: 'StTeplomer',
                            listeners: {
                                select: 'onGrAppTeplomerSelect'
                            },
                            viewConfig: {
                                getRowClass: function(record, rowIndex, rowParams, store) {
                                    return record.get('out') === 0 ? "" : 'change_color';
                                },
                                height: 73
                            },
                            columns: [
                                {
                                    xtype: 'gridcolumn',
                                    renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                        if (record.get('out')===1){
                                            metaData.tdCls = 'line-through';
                                        }
                                        return value;
                                    },
                                    width: 161,
                                    dataIndex: 'model',
                                    menuDisabled: true,
                                    text: 'Модель'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                        if (record.get('out')===1){
                                            metaData.tdCls = 'line-through';
                                        }
                                        return value;
                                    },
                                    width: 100,
                                    dataIndex: 'nomer',
                                    menuDisabled: true,
                                    text: 'Номер'
                                },
                                {
                                    xtype: 'actioncolumn',
                                    width: 30,
                                    menuDisabled: true,
                                    items: [
                                        {
                                            getClass: function(v, metadata, r, rowIndex, colIndex, store) {
                                                metaData = 'x-grid-center-icon';
                                                return metaData;
                                            },
                                            handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                                Ext.MessageBox.confirm({
                                                    title: 'Редагування приладу обліку',
                                                    msg: 'Ви редагуєте дані по приладу обліку <br> Підтвердіть або скасуйте свої дії.',
                                                    buttons: Ext.MessageBox.OKCANCEL,
                                                    icon: Ext.MessageBox.ERROR,
                                                    buttonText:{
                                                        ok:'підтверджую',
                                                        cancel:'скасувати'
                                                    },
                                                    fn:function(btn,newValue){
                                                        if(btn=='ok'){
                                                            var fmAppTeplomer = Ext.getCmp('fmAppTeplomer');
                                                            var tek = fmAppTeplomer.getForm().findField('tek').getValue();
                                                            //     var pdate = fmAppTeplomer.getForm().findField('pdate').getValue();
                                                            //     var sdate = fmAppTeplomer.getForm().findField('sdate').getValue();

                                                            var winAddTeplomer = Ext.ClassManager.instantiateByAlias('widget.winaddteplomer');
                                                            var form = winAddTeplomer.down('#fmAddTeplomer');
                                                            //    var check = form.down('#chkExistentVod');
                                                            var stUser = Ext.data.StoreManager.get("StUser");
                                                            var values =stUser.getAt(0);
                                                            var value = record;
                                                            //LOGIKA'
                                                            view.getSelectionModel().select(rowIndex);
                                                            values.set({'vibor':'editAppTeplomer','rowind':rowIndex});
                                                            stUser.sync();
                                                            form.down('#btAddTeplomer').setText('Оновити');
                                                            form.getForm().findField('tek').setFieldLabel('Поточні показання');

                                                            //  check.hide();
                                                            form.loadRecord(value);
                                                            form.getForm().findField('tek').setValue(tek);
                                                            //    form.getForm().findField('pdate').setValue(pdate);
                                                            //    form.getForm().findField('sdate').setValue(sdate);

                                                            winAddTeplomer.setTitle('Редагування приладу обліку');
                                                            winAddTeplomer.show();
                                                        }
                                                    }
                                                });
                                            },
                                            icon: 'resources/css/images/ico/edit.png',
                                            tooltip: 'Обновить данные по водомеру'
                                        }
                                    ]
                                },
                                {
                                    xtype: 'actioncolumn',
                                    width: 30,
                                    menuDisabled: true,
                                    tooltip: 'в ремонт или поверку',
                                    icon: 'resources/css/images/ico/no.png',
                                    items: [
                                        {
                                            getClass: function(v, metadata, r, rowIndex, colIndex, store) {
                                                var out = r.get('out');
                                                if (out === 0 ) {
                                                    metaData = 'x-hide-display';
                                                } else if (out === 1   ){
                                                    metaData = 'x-grid-center-icon';
                                                }
                                                return metaData;
                                            },
                                            handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                                // in use
                                                var me = this;
                                                //STORE
                                                var stUser = Ext.data.StoreManager.get("StUser");
                                                var StAllPokTeplomera = Ext.data.StoreManager.get("StAllPokTeplomera");//QueryTeplomer.getResults  <AllPokDTeplomera>
                                                var StTekPokTeplomera = Ext.data.StoreManager.get("StTekPokTeplomera");//QueryTeplomer.getResults <TekPokDTeplomera>
                                                var StTeplomer = view.getStore();
                                                //LOGIN & PASSWORD

                                                var values =stUser.getAt(0);
                                                var params = {
                                                    login:values.get('login'),
                                                    password:values.get('password'),
                                                    house_id:values.get('house_id'),
                                                    address_id:values.get('address_id'),
                                                    what:"ATeplomer"
                                                };
                                                //GRID

                                                var value = StTeplomer.getAt(rowIndex).data;

                                                //FORMA

                                                var fmAppteplomers = Ext.getCmp('fmAppTeplomer');

                                                //LOGIKA

                                                Ext.Object.merge(value, params);
                                                //console.log(value);

                                                Ext.MessageBox.confirm({
                                                    title: 'Повернення приладу обліку з повірки',
                                                    msg: 'Ви повертаєте прилад обліку з повірки <br> Підтвердіть або скасуйте свої дії.',
                                                    buttons: Ext.MessageBox.OKCANCEL,
                                                    icon: Ext.MessageBox.ERROR,
                                                    buttonText:{
                                                        ok:'підтверджую',
                                                        cancel:'скасувати'
                                                    },
                                                    fn:function(btn,newValue){
                                                        if(btn=='ok'){
                                                            QueryTeplomer.outTeplomerHistory(value,function(results){
                                                                if (results.success){
                                                                    StAllPokTeplomera.removeAll();
                                                                    StTeplomer.removeAll();
                                                                    StTekPokTeplomera.removeAll();
                                                                    StTeplomer.load({
                                                                        params: {
                                                                            what:'AppTeplomer',
                                                                            address_id: value.address_id,
                                                                            login:value.login,
                                                                            password:value.password
                                                                        },
                                                                        scope:this
                                                                    });
                                                                    //StTeplomer.sync();
                                                                    view.refresh();
                                                                    fmAppteplomers.getForm().reset();

                                                                    setTimeout(function(){
                                                                        Ext.MessageBox.show({
                                                                            title: 'Повернення приладу обліку з повірки',
                                                                            msg: results.msg,
                                                                            buttons: Ext.MessageBox.OK,
                                                                            icon: Ext.MessageBox.INFO
                                                                        });
                                                                    }, 500);

                                                                }
                                                            });
                                                        }
                                                    }
                                                });
                                            },
                                            icon: 'resources/css/images/ico/door_out.png',
                                            tooltip: 'Повернути прилад обліку з повірки'
                                        },
                                        {
                                            getClass: function(v, metadata, r, rowIndex, colIndex, store) {
                                                //console.log(r);
                                                var out = r.get('out');
                                                //console.log(out);
                                                if (out === 1 ) {
                                                    metaData = 'x-hide-display';
                                                    //console.log(1);
                                                } else if (out === 0   ){
                                                    metaData = 'x-grid-center-icon';
                                                    // console.log(0);
                                                }
                                                return metaData;
                                            },
                                            handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                                // in use
                                                var me = this;
                                                //STORE
                                                var stUser = Ext.data.StoreManager.get("StUser");
                                                var StTeplomer = view.getStore();
                                                //LOGIN & PASSWORD

                                                var values =stUser.getAt(0);
                                                var params = {
                                                    login:values.get('login'),
                                                    password:values.get('password'),
                                                    house_id:values.get('house_id'),
                                                    address_id:values.get('address_id'),
                                                    what:"ATeplomer"
                                                };
                                                //GRID

                                                var value = StTeplomer.getAt(rowIndex).data;

                                                //FORMA
                                                var fmTeplomer = Ext.getCmp('fmAppTeplomer');
                                                var insTekPokAppTeplomer = fmTeplomer.down('#insTekPokAppTeplomer');
                                                var aktOplombirovkiTeplomer = fmTeplomer.down('#aktOplombirovkiTeplomer');
                                                var aktRasplombirovkiTeplomer = fmTeplomer.down('#aktRasplombirovkiTeplomer');
                                                var AddMeedlePokVod = fmTeplomer.down('#AddMeedlePokTeplomer');
                                                var insMeedlePokVod = fmTeplomer.down('#insMeedlePokTeplomer');
                                                var date_ot = fmTeplomer.getForm().findField('date_ot');
                                                var date_do = fmTeplomer.getForm().findField('date_do');
                                                var date_ao = fmTeplomer.getForm().findField('date_ao');
                                                var date_ar = fmTeplomer.getForm().findField('date_ar');
                                                var pok_ot = fmTeplomer.getForm().findField('pok_ot');
                                                var pok_do = fmTeplomer.getForm().findField('pok_do');
                                                var rday = fmTeplomer.getForm().findField('rday');
                                                var days = fmTeplomer.getForm().findField('days');
                                                var kub_day = fmTeplomer.getForm().findField('kub_day');
                                                var qty_kub = fmTeplomer.getForm().findField('qty_kub');
                                                var newKubov = fmTeplomer.getForm().findField('newKubov');
                                                //LOGIKA
                                                Ext.Object.merge(value, params);
                                                //console.log(value);

                                                Ext.MessageBox.confirm({
                                                    title: 'Виведення приладу обліку в повірку',
                                                    msg: 'Ви виводите прилад обліку в повірку <br> Підтвердіть або скасуйте свої дії.',
                                                    buttons: Ext.MessageBox.OKCANCEL,
                                                    icon: Ext.MessageBox.ERROR,
                                                    buttonText:{
                                                        ok:'підтверджую',
                                                        cancel:'скасувати'
                                                    },
                                                    fn:function(btn,newValue){
                                                        if(btn=='ok'){


                                                            QueryTeplomer.inTeplomerHistory(value,function(results){
                                                                if (results.success){
                                                                    StTeplomer.removeAll();
                                                                    StTeplomer.load({
                                                                        params: {
                                                                            what:'AppTeplomer',
                                                                            house_id: value.house_id,
                                                                            login:value.login,
                                                                            password:value.password,
                                                                            address_id:value.address_id
                                                                        },
                                                                        scope:this
                                                                    });
                                                                    //StTeplomer.sync();
                                                                    view.refresh();
                                                                    fmTeplomer.getForm().reset();
                                                                    AddMeedlePokVod.setDisabled(true);
                                                                    insMeedlePokVod.setDisabled(true);
                                                                    insTekPokAppTeplomer.setDisabled(true);
                                                                    aktRasplombirovkiTeplomer.setDisabled(true);
                                                                    aktOplombirovkiTeplomer.setDisabled(true);

                                                                    date_ao.setDisabled(false);
                                                                    date_ar.setDisabled(false);
                                                                    date_ot.setDisabled(true);
                                                                    date_do.setDisabled(true);
                                                                    qty_kub.setDisabled(true);
                                                                    pok_do.setDisabled(true);
                                                                    pok_ot.setDisabled(true);
                                                                    rday.setDisabled(true);
                                                                    days.setDisabled(true);
                                                                    qty_kub.setDisabled(true);
                                                                    kub_day.setDisabled(true);
                                                                    newKubov.setDisabled(true);


                                                                    Ext.MessageBox.show({
                                                                        title: 'Виведення приладу обліку в повірку',
                                                                        msg: results.msg,
                                                                        buttons: Ext.MessageBox.OK,
                                                                        icon: Ext.MessageBox.INFO
                                                                    });
                                                                }
                                                            });
                                                        }
                                                    }
                                                });


                                            },
                                            icon: 'resources/css/images/ico/maintenance_16.png',
                                            tooltip: 'Висновок прилад обліку в повірку'
                                        }
                                    ]
                                },
                                {
                                    xtype: 'actioncolumn',
                                    width: 30,
                                    menuDisabled: true,
                                    items: [
                                        {
                                            handler: function(view, rowIndex, colIndex, item, e, record, row) {
                                                var stUser = Ext.data.StoreManager.get("StUser");
                                                var StHTeplomer = Ext.data.StoreManager.get("StHTeplomer");

                                                var values =stUser.getAt(0);
                                                var params = {
                                                    login:values.get('login'),
                                                    password:values.get('password'),
                                                    address_id:values.get('address_id'),
                                                    what:'ATeplomer'
                                                };
                                                var store = view.getStore();
                                                var value = store.getAt(rowIndex).data;

                                                Ext.Object.merge(value, params);

                                                Ext.MessageBox.confirm({
                                                    title: 'Видалення приладу обліку в історію',
                                                    msg: 'Ви видаляєте прилад обліку в історію <br> Підтвердіть або скасуйте свої дії.',
                                                    buttons: Ext.MessageBox.OKCANCEL,
                                                    icon: Ext.MessageBox.INFO,
                                                    buttonText:{
                                                        ok:'підтверджую',
                                                        cancel:'скасувати'

                                                    },
                                                    fn:function(btn,newValue){
                                                        if(btn=='ok'){
                                                            QueryTeplomer.delTeplomer(value,function(results){
                                                                if(results.success==="1"){
                                                                    store.load({
                                                                        params: {
                                                                            login:value.login,
                                                                            what:'AppTeplomer',
                                                                            password:value.password,
                                                                            address_id: value.address_id,
                                                                            what_id: value.address_id
                                                                        },
                                                                        scope:this
                                                                    });
                                                                    StHTeplomer.load({
                                                                        params: {
                                                                            login:value.login,
                                                                            password:value.password,
                                                                            what:'AppHTeplomer',
                                                                            address_id: value.address_id,
                                                                            what_id: value.address_id
                                                                        },
                                                                        scope:this
                                                                    });
                                                                } else {
                                                                    Ext.MessageBox.show({
                                                                        title: 'Видалення приладу обліку в історію',
                                                                        msg: results.msg,
                                                                        buttons: Ext.MessageBox.OK,
                                                                        icon: Ext.MessageBox.ERROR
                                                                    });
                                                                }
                                                            });
                                                        }
                                                    }
                                                });
                                            },
                                            getClass: function(v, metadata, r, rowIndex, colIndex, store) {
                                                metaData = 'x-grid-center-icon';
                                                return metaData;
                                            },
                                            icon: 'resources/css/images/ico/no.png',
                                            tooltip: 'Видалити прилад обліку в історію'
                                        }
                                    ]
                                }
                            ],
                            selModel: {
                                selType: 'checkboxmodel'
                            }
                        },
                        {
                            xtype: 'fieldset',
                            x: 385,
                            y: 180,
                            height: 235,
                            margin: 5,
                            style: 'background-color: #F1EEEE;',
                            width: 170,
                            title: 'Останнє показаня',
                            items: [
                                {
                                    xtype: 'datefield',
                                    anchor: '100%',
                                    padding: '0 5 0 5',
                                    width: 140,
                                    fieldLabel: 'Дата',
                                    labelWidth: 50,
                                    name: 'fdate',
                                    readOnly: true,
                                    altFormats: 'd-m-Y|m/d/Y|n/j/Y|n/j/y|m/j/y|n/d/y|m/j/Y|n/d/Y|m-d-y|m-d-Y|m/d|m-d|md|mdy|mdY|d|Y-m-d|n-j|n/j',
                                    format: 'd-m-Y'
                                },
                                {
                                    xtype: 'numberfield',
                                    anchor: '100%',
                                    padding: '0 5 0 5',
                                    width: 140,
                                    fieldLabel: 'попер',
                                    labelWidth: 50,
                                    name: 'pred',
                                    readOnly: true,
                                    decimalPrecision: 6
                                },
                                {
                                    xtype: 'numberfield',
                                    anchor: '100%',
                                    padding: '0 5 0 5',
                                    width: 140,
                                    fieldLabel: 'К-сть',
                                    labelWidth: 50,
                                    name: 'qty',
                                    readOnly: true,
                                    decimalPrecision: 6
                                },
                                {
                                    xtype: 'numberfield',
                                    anchor: '100%',
                                    id: 'AppT_pok_id',
                                    padding: '0 5 0 5',
                                    width: 140,
                                    fieldLabel: 'Показ',
                                    labelWidth: 50,
                                    name: 'pok_id',
                                    readOnly: true,
                                    decimalPrecision: 6
                                },
                                {
                                    xtype: 'numberfield',
                                    anchor: '100%',
                                    padding: '0 5 0 5',
                                    width: 140,
                                    fieldLabel: 'Гкал',
                                    labelWidth: 50,
                                    name: 'gkal',
                                    readOnly: true,
                                    decimalPrecision: 6
                                },
                                {
                                    xtype: 'numberfield',
                                    anchor: '100%',
                                    padding: '0 5 0 5',
                                    width: 140,
                                    fieldLabel: 'Поточні',
                                    labelWidth: 50,
                                    name: 'tekp',
                                    hideTrigger: true,
                                    decimalPrecision: 6
                                },
                                {
                                    xtype: 'button',
                                    handler: function(button, e) {
                                        var stUser = Ext.data.StoreManager.get("StUser");
                                        var stTekPokTeplomera = Ext.data.StoreManager.get("StTekPokTeplomera");
                                        var stAllPokTeplomera = Ext.data.StoreManager.get("StAllPokTeplomera");

                                        var values =stUser.getAt(0);
                                        var params = {
                                            login:values.get('login'),
                                            password:values.get('password'),
                                            address_id:values.get('address_id'),
                                            house_id:values.get('house_id'),
                                            what:'ATeplomer'
                                        };

                                        var fmTeplomer = Ext.getCmp('fmAppTeplomer');
                                        var value = fmTeplomer.getValues();

                                        Ext.Object.merge(value, params);
                                        Ext.MessageBox.confirm({
                                            title: 'Видалення останніх показань приладу обліку',
                                            msg: 'Ви видаляєте останнім показання по приладу обліку <br>Показання<b>'+value.tek+
                                            '</b><br>Підтвердіть або скасуйте свої дії.',
                                            buttons: Ext.MessageBox.OKCANCEL,
                                            icon: Ext.MessageBox.ERROR,
                                            buttonText:{
                                                ok: 'подтвеждаю',
                                                cancel: 'скасування'
                                            },
                                            fn:function(btn,newValue){
                                                if(btn=='ok'){
                                                    QueryTeplomer.delPokTeplomera(value,function(results){
                                                        if (results.success){
                                                            Ext.MessageBox.show({title: 'Видалення останніх показань приладу обліку',
                                                                msg: results.msg,
                                                                buttons: Ext.MessageBox.OK,
                                                                icon: Ext.MessageBox.INFO
                                                            });
                                                            fmTeplomer.down('#newPokAppTepl').setValue(0);

                                                            stAllPokTeplomera.load({
                                                                params: {
                                                                    login:value.login,
                                                                    password:value.password,
                                                                    address_id: value.address_id,
                                                                    what:'AllPokTeplomera',
                                                                    what_id: value.teplomer_id,
                                                                    teplomer_id: value.teplomer_id
                                                                },
                                                                scope:this
                                                            });
                                                            stTekPokTeplomera.load({
                                                                params: {
                                                                    what:'TekPokTeplomera',
                                                                    what_id: value.address_id,
                                                                    address_id: value.address_id,
                                                                    teplomer_id: value.teplomer_id,
                                                                    login:value.login,
                                                                    password:value.password
                                                                },
                                                                callback: function(records,operation,success){

                                                                    if((success)){
                                                                        fmTeplomer.getForm().loadRecord(records[0]);
                                                                    }
                                                                },
                                                                scope:this
                                                            });
                                                        }else{
                                                            Ext.MessageBox.show({title: 'Видалення останніх показань приладу обліку',
                                                                msg: msg,
                                                                buttons: Ext.MessageBox.OK,
                                                                icon: Ext.MessageBox.ERROR
                                                            });
                                                        }
                                                    });
                                                }
                                            }
                                        });

                                    },
                                    anchor: '100%',
                                    formBind: true,
                                    id: 'delTekPokAppTeplomera',
                                    width: 163,
                                    icon: 'resources/css/images/ico/no.png',
                                    text: 'Удалить показ'
                                }
                            ]
                        },
                        {
                            xtype: 'fieldset',
                            x: 420,
                            y: 5,
                            height: 165,
                            style: 'background-color: #F1EEEE;',
                            width: 595,
                            layout: 'absolute',
                            title: 'Технічна характеристика',
                            items: [
                                {
                                    xtype: 'textfield',
                                    x: 0,
                                    y: 5,
                                    id: 'fmAppTeplomer_id',
                                    padding: '0 5 0 5',
                                    width: 160,
                                    fieldLabel: 'Тепломер_ид',
                                    labelWidth: 90,
                                    name: 'teplomer_id',
                                    readOnly: true,
                                    allowBlank: false
                                },
                                {
                                    xtype: 'textfield',
                                    x: 170,
                                    y: 5,
                                    padding: '0 5 0 5',
                                    style: '{color: #378005; text-shadow: -1px -1px white, 1px 1px #333;font-size:14pt;}',
                                    width: 195,
                                    fieldLabel: '',
                                    name: 'model',
                                    readOnly: true
                                },
                                {
                                    xtype: 'textfield',
                                    x: 375,
                                    y: 5,
                                    padding: '0 5 0 5',
                                    width: 180,
                                    fieldLabel: 'Номер',
                                    labelWidth: 50,
                                    name: 'nomer',
                                    readOnly: true
                                },
                                {
                                    xtype: 'textfield',
                                    x: 0,
                                    y: 40,
                                    padding: '0 5 0 5',
                                    width: 80,
                                    fieldLabel: 'Дт',
                                    labelWidth: 20,
                                    name: 'dteplomer_id',
                                    readOnly: true
                                },
                                {
                                    xtype: 'textfield',
                                    x: 285,
                                    y: 40,
                                    height: 20,
                                    padding: '0 5 0 5',
                                    width: 145,
                                    fieldLabel: 'Один. вим.',
                                    labelWidth: 80,
                                    name: 'edizm',
                                    readOnly: true
                                },
                                {
                                    xtype: 'textfield',
                                    x: 440,
                                    y: 40,
                                    padding: '0 5 0 5',
                                    width: 115,
                                    fieldLabel: 'Коеф',
                                    labelWidth: 45,
                                    name: 'koef',
                                    readOnly: true
                                },
                                {
                                    xtype: 'datefield',
                                    x: 85,
                                    y: 40,
                                    padding: '0 5 0 5',
                                    width: 195,
                                    fieldLabel: 'Дата введення',
                                    name: 'sdate',
                                    readOnly: true,
                                    altFormats: 'd-m-Y|m/d/Y|n/j/Y|n/j/y|m/j/y|n/d/y|m/j/Y|n/d/Y|m-d-y|m-d-Y|m/d|m-d|md|mdy|mdY|d|Y-m-d|n-j|n/j',
                                    format: 'd-m-Y',
                                    submitFormat: 'Ymd'
                                },
                                {
                                    xtype: 'fieldset',
                                    x: 5,
                                    y: 75,
                                    height: 60,
                                    width: 555,
                                    layout: 'absolute',
                                    title: 'Поверка',
                                    items: [
                                        {
                                            xtype: 'datefield',
                                            width: 170,
                                            fieldLabel: 'Попередня',
                                            labelWidth: 80,
                                            name: 'pdate',
                                            readOnly: true,
                                            altFormats: 'd.m.y|d/m/Y|d-m-y|d-m-Y|d/m|d-m|dm|dmy|dmY|d|Y-m-d',
                                            format: 'd-m-Y'
                                        },
                                        {
                                            xtype: 'datefield',
                                            x: 185,
                                            y: 0,
                                            width: 165,
                                            fieldLabel: 'Наступна',
                                            labelWidth: 70,
                                            name: 'fpdate',
                                            readOnly: true,
                                            altFormats: 'd-m-Y|m/d/Y|n/j/Y|n/j/y|m/j/y|n/d/y|m/j/Y|n/d/Y|m-d-y|m-d-Y|m/d|m-d|md|mdy|mdY|d|Y-m-d|n-j|n/j',
                                            format: 'd-m-y'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 355,
                                            y: 0,
                                            width: 165,
                                            fieldLabel: 'Пломба',
                                            labelWidth: 50,
                                            name: 'plomba'
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            xtype: 'fieldset',
                            x: 0,
                            y: 275,
                            height: 145,
                            style: 'background-color: #F1EEEE;',
                            width: 390,
                            layout: 'absolute',
                            title: 'Введення нових показань',
                            items: [
                                {
                                    xtype: 'fieldset',
                                    x: 5,
                                    y: 10,
                                    height: 85,
                                    style: 'background-color: #f3f3f3;',
                                    width: 180,
                                    title: 'Попередні',
                                    items: [
                                        {
                                            xtype: 'datefield',
                                            anchor: '100%',
                                            fieldLabel: 'Дата',
                                            labelWidth: 40,
                                            name: 'date_old',
                                            format: 'd-m-Y',
                                            submitFormat: 'Ymd'
                                        },
                                        {
                                            xtype: 'numberfield',
                                            anchor: '100%',
                                            fieldLabel: 'Показ',
                                            labelWidth: 40,
                                            name: 'tek',
                                            readOnly: true,
                                            hideTrigger: true,
                                            autoStripChars: true,
                                            decimalPrecision: 3
                                        }
                                    ]
                                },
                                {
                                    xtype: 'fieldset',
                                    x: 190,
                                    y: 0,
                                    height: 115,
                                    style: 'background-color: #f3f3f3;',
                                    width: 175,
                                    title: 'Нове',
                                    items: [
                                        {
                                            xtype: 'datefield',
                                            anchor: '100%',
                                            fieldLabel: 'Дата',
                                            labelWidth: 40,
                                            name: 'date_new',
                                            allowBlank: false,
                                            format: 'd-m-Y',
                                            submitFormat: 'Ymd'
                                        },
                                        {
                                            xtype: 'numberfield',
                                            anchor: '100%',
                                            shadowOffset: 1,
                                            id: 'newPokAppTepl',
                                            fieldLabel: 'Показ',
                                            labelWidth: 40,
                                            name: 'newValue',
                                            value: 0,
                                            allowBlank: false,
                                            hideTrigger: true,
                                            selectOnFocus: true,
                                            autoStripChars: true,
                                            decimalPrecision: 3,
                                            minValue: 0,
                                            negativeText: 'Значение должно быть больше 1'
                                        },
                                        {
                                            xtype: 'button',
                                            handler: function(button, e) {
                                                // in use
                                                var me = this;
                                                //STORE

                                                var stUser = Ext.data.StoreManager.get("StUser");
                                                var stTekPokTeplomera = Ext.data.StoreManager.get("StTekPokTeplomera");
                                                var stAllPokTeplomera = Ext.data.StoreManager.get("StAllPokTeplomera");

                                                //LOGIN & PASSWORD

                                                var values =stUser.getAt(0);
                                                var params = {
                                                    login:values.get('login'),
                                                    password:values.get('password'),
                                                    address_id:values.get('address_id'),
                                                    house_id:values.get('house_id'),
                                                    what:'ATeplomer'
                                                };
                                                //FORMA
                                                var fmTeplomer = Ext.getCmp('fmAppTeplomer');
                                                var value = fmTeplomer.getValues();
                                                //LOGIKA


                                                Ext.Object.merge(value, params);
                                                var newValue = value.newValue;
                                                var max =newValue - value.tek;
                                                if (isNaN(newValue) || (max.length ===0)){
                                                    Ext.MessageBox.show({
                                                        title: 'Перевірка даних, що вводяться',
                                                        msg: 'Введіть число',
                                                        buttons: Ext.MessageBox.OK,
                                                        icon: Ext.MessageBox.ERROR
                                                    });
                                                    fmTeplomer.down('#newPokAppTepl').focus();

                                                    return false;
                                                }else if (max< 0){
                                                    Ext.MessageBox.show({
                                                        title: 'Перевірка даних, що вводяться',
                                                        msg: 'Введені свідчення менше або дорівнюють нулю <b>' + max + '</ b> <br> Введіть правильні показяння!.',
                                                        buttons: Ext.MessageBox.CANCEL,
                                                        icon: Ext.MessageBox.ERROR,
                                                        buttonText:{
                                                            cancel:'скасувати'
                                                        },
                                                        fn:function(btn,newValue){
                                                            if(btn=='cancel'){
                                                                fmTeplomer.down('#newPokAppTepl').focus();
                                                                return false;
                                                            }
                                                        }
                                                    });
                                                } else if(max > 5) {
                                                    Ext.MessageBox.confirm({
                                                        title: 'Перевірка даних, що вводяться',
                                                        msg: 'Введені показання  дуже великі <b>'+ max +'</b> <br>Підтвердіть або скасуйте вводяться свідчення..',
                                                        buttons: Ext.MessageBox.OKCANCEL,
                                                        icon: Ext.MessageBox.ERROR,
                                                        buttonText:{
                                                            ok:'підтверджую',
                                                            cancel:'скасувати'
                                                        },
                                                        fn:function(btn,newValue){
                                                            if(btn=='cancel'){
                                                                fmTeplomer.down('#newPokAppTepl').focus();
                                                                return false;
                                                            } else {
                                                                QueryTeplomer.newPokTeplomera(value,function(data){
                                                                    if (data.success==="1"){
                                                                        //console.log(data.success);

                                                                        Ext.MessageBox.confirm({
                                                                            title: 'Перевірка даних, що вводяться',
                                                                            msg:data.msg,
                                                                            buttons: Ext.MessageBox.OK,
                                                                            icon: Ext.MessageBox.INFO
                                                                        });
                                                                        fmTeplomer.down('#newPokAppTepl').setValue(0);

                                                                        stTekPokTeplomera.load({
                                                                            params: {
                                                                                what:'TekPokTeplomera',
                                                                                what_id: value.address_id,
                                                                                address_id: value.address_id,
                                                                                teplomer_id: value.teplomer_id,
                                                                                login:value.login,
                                                                                password:value.password
                                                                            },
                                                                            callback: function(records,operation,success){
                                                                                if(success){
                                                                                    fmTeplomer.getForm().loadRecord(records[0]);
                                                                                }
                                                                            },
                                                                            scope:this
                                                                        });
                                                                        stAllPokTeplomera.load({
                                                                            params: {
                                                                                login:value.login,
                                                                                password:value.password,
                                                                                address_id: value.address_id,
                                                                                what:'AllPokTeplomera',
                                                                                what_id: value.teplomer_id,
                                                                                teplomer_id: value.teplomer_id
                                                                            },
                                                                            scope:this
                                                                        });

                                                                    }else{
                                                                        Ext.MessageBox.confirm({
                                                                            title: 'Перевірка даних, що вводяться',
                                                                            msg: data.msg,
                                                                            buttons: Ext.MessageBox.OK,
                                                                            icon: Ext.MessageBox.INFO
                                                                        });
                                                                    }
                                                                });
                                                            }
                                                        }
                                                    });
                                                } else {
                                                    QueryTeplomer.newPokTeplomera(value,function(data){

                                                        if (data.success==="1"){
                                                            //  console.log(data.success);

                                                            Ext.MessageBox.confirm({
                                                                title: 'Перевірка даних, що вводяться',
                                                                msg: data.msg,
                                                                buttons: Ext.MessageBox.OK,
                                                                icon: Ext.MessageBox.INFO
                                                            });
                                                            fmTeplomer.down('#newPokAppTepl').setValue(0);

                                                            stTekPokTeplomera.load({
                                                                params: {
                                                                    what:'TekPokTeplomera',
                                                                    what_id: value.address_id,
                                                                    address_id: value.address_id,
                                                                    teplomer_id: value.teplomer_id,
                                                                    login:value.login,
                                                                    password:value.password
                                                                },
                                                                callback: function(records,operation,success){
                                                                    if(success){
                                                                        fmTeplomer.getForm().loadRecord(records[0]);
                                                                    }
                                                                },
                                                                scope:this
                                                            });
                                                            stAllPokTeplomera.load({
                                                                params: {
                                                                    login:value.login,
                                                                    password:value.password,
                                                                    address_id: value.address_id,
                                                                    what:'AllPokTeplomera',
                                                                    what_id: value.teplomer_id,
                                                                    teplomer_id: value.teplomer_id
                                                                },
                                                                scope:this
                                                            });

                                                        }else{
                                                            Ext.MessageBox.confirm({
                                                                title: 'Перевірка даних, що вводяться',
                                                                msg: data.msg,
                                                                buttons: Ext.MessageBox.OK,
                                                                icon: Ext.MessageBox.INFO
                                                            });
                                                        }
                                                    });
                                                }


                                            },
                                            anchor: '100%',
                                            shadowOffset: 2,
                                            disabled: true,
                                            id: 'insTekPokAppTeplomer',
                                            width: 115,
                                            icon: 'resources/css/images/ico/yes22.png',
                                            text: 'Записати'
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            xtype: 'fieldset',
                            x: 560,
                            y: 215,
                            height: 205,
                            style: 'background-color: #F1EEEE;',
                            width: 455,
                            layout: 'absolute',
                            title: 'Період за середнім',
                            items: [
                                {
                                    xtype: 'datefield',
                                    x: 200,
                                    y: 5,
                                    disabled: true,
                                    width: 190,
                                    fieldLabel: 'Дата закінч',
                                    labelWidth: 80,
                                    name: 'date_do',
                                    format: 'd-m-Y',
                                    submitFormat: 'Ymd',
                                    listeners: {
                                        change: 'onDatefieldChange'
                                    }
                                },
                                {
                                    xtype: 'datefield',
                                    x: 0,
                                    y: 5,
                                    disabled: true,
                                    width: 195,
                                    fieldLabel: 'дата початку',
                                    labelWidth: 85,
                                    name: 'date_ot',
                                    format: 'd-m-Y',
                                    submitFormat: 'Ymd'
                                },
                                {
                                    xtype: 'fieldset',
                                    x: 0,
                                    y: 35,
                                    height: 135,
                                    width: 428,
                                    layout: 'absolute',
                                    title: 'Розрахувати за середнім',
                                    items: [
                                        {
                                            xtype: 'button',
                                            handler: function(button, e) {
                                                // in use
                                                var me = this;
                                                //STORE

                                                var stUser = Ext.data.StoreManager.get("StUser");
                                                var stAllPokTeplomera = Ext.data.StoreManager.get("StAllPokTeplomera");//QueryTeplomer.getResults <TekPokTeplomera>
                                                var stTekPokTeplomera = Ext.data.StoreManager.get("StTekPokTeplomera");//QueryTeplomer.getResults <TekPokTeplomera>
                                                //LOGIN & PASSWORD

                                                var values =stUser.getAt(0);
                                                var params = {
                                                    login:values.get('login'),
                                                    password:values.get('password'),
                                                    address_id:values.get('address_id'),
                                                    house_id:values.get('house_id'),
                                                    what:'insMeedlePokTeplomera'

                                                };
                                                //GRID


                                                //FORMA

                                                var fmAppTeplomer = Ext.getCmp('fmAppTeplomer');
                                                var value = fmAppTeplomer.getValues();

                                                //LOGIKA

                                                Ext.Object.merge(value, params);
                                                var newValue = value.newKubov;
                                                var max = newValue;
                                                if (isNaN(newValue) || (max.length ===0)){
                                                    Ext.MessageBox.show({
                                                        title: 'Перевірка даних, що вводяться',
                                                        msg: 'Введіть число',
                                                        buttons: Ext.MessageBox.OK,
                                                        icon: Ext.MessageBox.ERROR
                                                    });
                                                    fmAppTeplomer.getForm().findField('newKubov').focus();

                                                    return false;
                                                } else if (max <= 0){
                                                    Ext.MessageBox.show({
                                                        title: 'Перевірка даних, що вводяться',
                                                        msg: 'Введені свідчення менше або дорівнюють нулю <b>' + max + '</ b> <br> Введіть правильні показяння!.',
                                                        buttons: Ext.MessageBox.CANCEL,
                                                        icon: Ext.MessageBox.ERROR,
                                                        buttonText:{
                                                            cancel:'скасувати'
                                                        },
                                                        fn:function(btn,newValue){
                                                            if(btn=='cancel'){
                                                                fmAppTeplomer.getForm().findField('newKubov').focus();
                                                                return false;
                                                            }
                                                        }
                                                    });
                                                }else if(max > 5) {
                                                    Ext.MessageBox.confirm({
                                                        title: 'Перевірка даних, що вводяться',
                                                        msg: 'Введені показання  дуже великі <b>'+ max +'</b> <br>Підтвердіть або скасуйте вводяться свідчення..',
                                                        buttons: Ext.MessageBox.OKCANCEL,
                                                        icon: Ext.MessageBox.ERROR,
                                                        buttonText:{
                                                            ok:'підтверджую',
                                                            cancel:'скасувати'
                                                        },
                                                        fn:function(btn,newValue){
                                                            if(btn=='cancel'){
                                                                fmAppTeplomer.getForm().findField('newKubov').focus();
                                                                return false;
                                                            }else{
                                                                QueryVodomer.newPokVodomera(value,function(results){
                                                                    if (results.success){
                                                                        fmAppTeplomer.getForm().findField('newKubov').setValue(0);
                                                                        stAllPokTeplomera.load({
                                                                            params: {
                                                                                what:'AllPokTeplomera',
                                                                                what_id: value.address_id,
                                                                                address_id: value.address_id,
                                                                                teplomer_id: value.teplomer_id,
                                                                                login:value.login,
                                                                                password:value.password
                                                                            },
                                                                            scope:this
                                                                        });
                                                                        stTekPokTeplomera.load({
                                                                            params: {
                                                                                what:'TekPokTeplomera',
                                                                                what_id: value.address_id,
                                                                                address_id: value.address_id,
                                                                                teplomer_id: value.teplomer_id,
                                                                                login:value.login,
                                                                                password:value.password
                                                                            },
                                                                            callback: function(records,operation,success){
                                                                                if(success){
                                                                                    fmAppTeplomer.getForm().loadRecord(records[0]);
                                                                                }
                                                                            },
                                                                            scope:this
                                                                        });
                                                                    }
                                                                });
                                                            }
                                                        }
                                                    });


                                                } else {
                                                    QueryVodomer.newPokVodomera(value,function(results){
                                                        if (results.success){

                                                            fmAppTeplomer.getForm().findField('newKubov').setValue(0);
                                                            stAllPokTeplomera.load({
                                                                params: {
                                                                    what:'AllPokTeplomera',
                                                                    what_id: value.address_id,
                                                                    address_id: value.address_id,
                                                                    teplomer_id: value.teplomer_id,
                                                                    login:value.login,
                                                                    password:value.password
                                                                },
                                                                scope:this
                                                            });
                                                            stTekPokTeplomera.load({
                                                                params: {
                                                                    what:'TekPokTeplomera',
                                                                    what_id: value.address_id,
                                                                    address_id: value.address_id,
                                                                    teplomer_id: value.teplomer_id,
                                                                    login:value.login,
                                                                    password:value.password
                                                                },
                                                                callback: function(records,operation,success){
                                                                    if(success){
                                                                        fmAppTeplomer.getForm().loadRecord(records[0]);
                                                                    }
                                                                },
                                                                scope:this
                                                            });

                                                        }
                                                    });
                                                }

                                            },
                                            x: 305,
                                            y: 70,
                                            shadowOffset: 2,
                                            border: '2px',
                                            disabled: true,
                                            id: 'insMeedlePokTeplomer',
                                            width: 100,
                                            icon: 'resources/css/images/ico/yes22.png',
                                            text: 'Записати'
                                        },
                                        {
                                            xtype: 'numberfield',
                                            x: 135,
                                            y: 70,
                                            shadowOffset: 1,
                                            disabled: true,
                                            width: 165,
                                            fieldLabel: 'Гкал за серед',
                                            labelWidth: 90,
                                            name: 'newKubov',
                                            value: 0,
                                            allowBlank: false,
                                            hideTrigger: true,
                                            selectOnFocus: true,
                                            autoStripChars: true,
                                            decimalPrecision: 3,
                                            minValue: 0,
                                            negativeText: 'Значение должно быть больше 1'
                                        },
                                        {
                                            xtype: 'numberfield',
                                            x: 0,
                                            y: 70,
                                            shadowOffset: 1,
                                            disabled: true,
                                            width: 130,
                                            fieldLabel: 'Днів за серед',
                                            labelWidth: 90,
                                            name: 'days',
                                            value: 0,
                                            allowBlank: false,
                                            hideTrigger: true,
                                            selectOnFocus: true,
                                            allowDecimals: false,
                                            autoStripChars: true,
                                            decimalPrecision: 0,
                                            minValue: 0,
                                            negativeText: 'Значение должно быть больше 1'
                                        },
                                        {
                                            xtype: 'numberfield',
                                            x: 0,
                                            y: 5,
                                            shadowOffset: 1,
                                            disabled: true,
                                            width: 190,
                                            fieldLabel: 'показання від',
                                            labelWidth: 90,
                                            name: 'pok_ot',
                                            value: 0,
                                            allowBlank: false,
                                            hideTrigger: true,
                                            selectOnFocus: true,
                                            autoStripChars: true,
                                            decimalPrecision: 3,
                                            minValue: 0,
                                            negativeText: 'Значение должно быть больше 1'
                                        },
                                        {
                                            xtype: 'numberfield',
                                            x: 205,
                                            y: 5,
                                            shadowOffset: 1,
                                            disabled: true,
                                            width: 200,
                                            fieldLabel: 'показання до',
                                            labelWidth: 90,
                                            name: 'pok_do',
                                            value: 0,
                                            allowBlank: false,
                                            hideTrigger: true,
                                            selectOnFocus: true,
                                            autoStripChars: true,
                                            decimalPrecision: 3,
                                            minValue: 0,
                                            negativeText: 'Значение должно быть больше 1'
                                        },
                                        {
                                            xtype: 'numberfield',
                                            x: 0,
                                            y: 35,
                                            shadowOffset: 1,
                                            disabled: true,
                                            width: 115,
                                            fieldLabel: 'Кільк днів',
                                            labelWidth: 70,
                                            name: 'rday',
                                            value: 0,
                                            allowBlank: false,
                                            hideTrigger: true,
                                            selectOnFocus: true,
                                            allowDecimals: false,
                                            autoStripChars: true,
                                            decimalPrecision: 0,
                                            minValue: 0,
                                            negativeText: 'Значение должно быть больше 1'
                                        },
                                        {
                                            xtype: 'numberfield',
                                            x: 120,
                                            y: 35,
                                            shadowOffset: 1,
                                            disabled: true,
                                            width: 135,
                                            fieldLabel: 'Гкал разр',
                                            labelWidth: 70,
                                            name: 'qty_kub',
                                            value: 0,
                                            allowBlank: false,
                                            hideTrigger: true,
                                            selectOnFocus: true,
                                            autoStripChars: true,
                                            decimalPrecision: 3,
                                            minValue: 0
                                        },
                                        {
                                            xtype: 'numberfield',
                                            x: 265,
                                            y: 35,
                                            shadowOffset: 1,
                                            disabled: true,
                                            width: 140,
                                            fieldLabel: 'Гкал/Дн',
                                            labelWidth: 55,
                                            name: 'kub_day',
                                            value: 0,
                                            allowBlank: false,
                                            hideTrigger: true,
                                            selectOnFocus: true,
                                            autoStripChars: true,
                                            decimalPrecision: 6
                                        }
                                    ]
                                },
                                {
                                    xtype: 'button',
                                    handler: function(button, e) {
                                        // in use
                                        //var me = this;
                                        //STORE

                                        var stUser = Ext.data.StoreManager.get("StUser");
                                        //LOGIN & PASSWORD
                                        var fmAppTeplomer = Ext.getCmp('fmAppTeplomer');
                                        var teplomer_id = fmAppTeplomer.getForm().findField('teplomer_id');
                                        var insMeedlePokTeplomer = fmAppTeplomer.down('#insMeedlePokTeplomer');
                                        var date_ot = fmAppTeplomer.getForm().findField('date_ot');
                                        var date_do = fmAppTeplomer.getForm().findField('date_do');
                                        var days = fmAppTeplomer.getForm().findField('days');
                                        var pok_ot = fmAppTeplomer.getForm().findField('pok_ot');
                                        var pok_do = fmAppTeplomer.getForm().findField('pok_do');
                                        var rday = fmAppTeplomer.getForm().findField('rday');
                                        var kub_day = fmAppTeplomer.getForm().findField('kub_day');
                                        var newKubov = fmAppTeplomer.getForm().findField('newKubov');
                                        var qty_kub = fmAppTeplomer.getForm().findField('qty_kub');

                                        var value = fmAppTeplomer.getValues();


                                        var values =stUser.getAt(0);
                                        var params = {
                                            login:values.get('login'),
                                            password:values.get('password'),
                                            address_id:values.get('address_id'),
                                            address:values.get('address'),
                                            what:"AddMeedlePokTeplomera"
                                        };
                                        Ext.Object.merge(value, params);
                                        QueryVodomer.updateVodomer(value,function(results){
                                            if (results.success){

                                                date_ot.setDisabled(false);
                                                date_do.setDisabled(false);
                                                pok_do.setDisabled(false);
                                                pok_ot.setDisabled(false);
                                                days.setDisabled(false);
                                                rday.setDisabled(false);
                                                kub_day.setDisabled(false);
                                                newKubov.setDisabled(false);
                                                qty_kub.setDisabled(false);

                                                insMeedlePokTeplomer.setDisabled(false);
                                                date_ot.setValue(results.date_ot);
                                                date_do.setValue(results.date_do);
                                                pok_ot.setValue(results.pok_ot);
                                                pok_do.setValue(results.pok_do);
                                                rday.setValue(results.rday);
                                                kub_day.setValue(results.kub_day);
                                                days.setValue(results.days);
                                                qty_kub.setValue(results.qty_kub);
                                                newKubov.setValue(results.kubov);
                                            } else {
                                                Ext.MessageBox.show({
                                                    title: 'Розрахунок за середнім',
                                                    msg: results.msg,
                                                    buttons: Ext.MessageBox.OK,
                                                    icon: Ext.MessageBox.INFO
                                                });
                                            }
                                        });

                                    },
                                    x: 400,
                                    y: 0,
                                    shadowOffset: 2,
                                    id: 'AddMeedlePokTeplomer',
                                    icon: 'resources/css/images/ico/schet.png',
                                    scale: 'medium',
                                    text: '',
                                    tooltip: 'Нарахувати за середнім',
                                    tooltipType: 'title'
                                }
                            ]
                        },
                        {
                            xtype: 'button',
                            x: 10,
                            y: 230,
                            disabled: true,
                            id: 'aktRasplombirovkiTeplomer',
                            width: 170,
                            icon: 'resources/css/images/ico/add.png',
                            text: 'Акт розпломбування'
                        },
                        {
                            xtype: 'button',
                            x: 200,
                            y: 230,
                            disabled: true,
                            id: 'aktOplombirovkiTeplomer',
                            width: 170,
                            icon: 'resources/css/images/ico/add.png',
                            text: 'Акт опломбування'
                        },
                        {
                            xtype: 'datefield',
                            x: 570,
                            y: 180,
                            disabled: true,
                            width: 215,
                            fieldLabel: 'Акт розпломбув',
                            labelWidth: 105,
                            name: 'date_ar',
                            format: 'd-m-Y',
                            submitFormat: 'Ymd',
                            listeners: {
                                select: 'onDatefieldSelect1'
                            }
                        },
                        {
                            xtype: 'datefield',
                            x: 800,
                            y: 180,
                            disabled: true,
                            width: 215,
                            fieldLabel: 'Акт опломбув',
                            name: 'date_ao',
                            format: 'd-m-Y',
                            submitFormat: 'Ymd',
                            listeners: {
                                select: 'onDatefieldSelect'
                            }
                        }
                    ]
                },
                {
                    xtype: 'gridpanel',
                    id: 'grAllPokAppTeplomera',
                    scrollable: true,
                    width: 1040,
                    title: 'Історія показань приладів обліку теплової енергії',
                    store: 'StAllPokTeplomera',
                    viewConfig: {
                        getRowClass: function(record, rowIndex, rowParams, store) {
                            return record.get('avg') === 0 ? "" : 'change_color';
                        }
                    },
                    columns: [
                        {
                            xtype: 'gridcolumn',
                            menuDisabled: true,
                            text: 'Период',
                            columns: [
                                {
                                    xtype: 'datecolumn',
                                    width: 90,
                                    dataIndex: 'date_ot',
                                    menuDisabled: true,
                                    text: 'Попер',
                                    format: 'd-m-Y'
                                },
                                {
                                    xtype: 'datecolumn',
                                    width: 90,
                                    dataIndex: 'date_do',
                                    menuDisabled: true,
                                    text: 'Поточне',
                                    format: 'd-m-Y'
                                },
                                {
                                    xtype: 'numbercolumn',
                                    width: 53,
                                    dataIndex: 'days',
                                    menuDisabled: true,
                                    text: 'дней',
                                    format: '0'
                                }
                            ]
                        },
                        {
                            xtype: 'gridcolumn',
                            menuDisabled: true,
                            text: 'Показання по приладу обліку',
                            columns: [
                                {
                                    xtype: 'numbercolumn',
                                    width: 80,
                                    dataIndex: 'pred',
                                    menuDisabled: true,
                                    text: 'Поперед',
                                    format: '0.000'
                                },
                                {
                                    xtype: 'numbercolumn',
                                    width: 80,
                                    dataIndex: 'tek',
                                    menuDisabled: true,
                                    text: 'Поточне',
                                    format: '0.000'
                                },
                                {
                                    xtype: 'numbercolumn',
                                    width: 65,
                                    dataIndex: 'qty',
                                    menuDisabled: true,
                                    text: 'кол-во',
                                    format: '0.000'
                                }
                            ]
                        },
                        {
                            xtype: 'gridcolumn',
                            menuDisabled: true,
                            text: 'За середнім',
                            columns: [
                                {
                                    xtype: 'numbercolumn',
                                    width: 80,
                                    dataIndex: 'pok_ot',
                                    menuDisabled: true,
                                    text: 'Поперед',
                                    format: '0.000'
                                },
                                {
                                    xtype: 'numbercolumn',
                                    width: 80,
                                    dataIndex: 'pok_do',
                                    menuDisabled: true,
                                    text: 'Поточне',
                                    format: '0.000'
                                },
                                {
                                    xtype: 'numbercolumn',
                                    width: 78,
                                    dataIndex: 'gkal_rasch',
                                    menuDisabled: true,
                                    text: 'Гкал раз',
                                    format: '0.000'
                                },
                                {
                                    xtype: 'numbercolumn',
                                    width: 59,
                                    dataIndex: 'days',
                                    menuDisabled: true,
                                    text: 'Дней',
                                    format: '0'
                                },
                                {
                                    xtype: 'numbercolumn',
                                    width: 70,
                                    dataIndex: 'gkal_day',
                                    menuDisabled: true,
                                    text: 'Гкал/д',
                                    format: '0.000'
                                }
                            ]
                        },
                        {
                            xtype: 'numbercolumn',
                            width: 57,
                            dataIndex: 'koef',
                            menuDisabled: true,
                            text: 'коэф',
                            format: '0.00000'
                        },
                        {
                            xtype: 'numbercolumn',
                            width: 70,
                            dataIndex: 'gkal',
                            menuDisabled: true,
                            text: 'Гкал',
                            format: '0.000'
                        },
                        {
                            xtype: 'numbercolumn',
                            width: 76,
                            dataIndex: 'pok_id',
                            menuDisabled: true,
                            text: 'Ид пок',
                            format: '0'
                        },
                        {
                            xtype: 'gridcolumn',
                            width: 90,
                            dataIndex: 'operator',
                            menuDisabled: true,
                            text: 'оператор'
                        }
                    ],
                    tools: [
                        {
                            xtype: 'tool',
                            callback: function(owner, tool, event) {
                                //in use
                                var grid = tool.findParentByType('grid');
                                var fmAppTeplomer = Ext.getCmp('fmAppTeplomer');
                                var teplomer_id = fmAppTeplomer.getForm().findField('teplomer_id').getValue();
                                //STORE
                                var stUser = Ext.data.StoreManager.get("StUser");
                                var stAllPokTeplomera = Ext.data.StoreManager.get("StAllPokTeplomera");
                                //LOGIN & PASSWORD
                                var values =stUser.getAt(0);

                                //LOGIKA
                                if(!Ext.isEmpty(teplomer_id)){
                                    stAllPokTeplomera.removeAll();
                                    stAllPokTeplomera.load({
                                        params: {
                                            login:values.get('login'),
                                            password:values.get('password'),
                                            what:'AllPokTeplomeraAll',
                                            what_id: values.get('address_id'),
                                            teplomer_id: teplomer_id
                                        },

                                        callback: function(records,operation,success){
                                            if(success){
                                                grid.getView().refresh();
                                            }
                                        },
                                        scope:this
                                    });
                                }
                            },
                            tooltip: 'Завантажити все показання приладу обліку',
                            tooltipType: 'title',
                            type: 'search'
                        }
                    ]
                }
            ]
        }
    ]

});