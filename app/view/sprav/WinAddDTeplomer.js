/*
 * File: app/view/sprav/WinAddDTeplomer.js
 * Date: Tue Sep 22 2020 01:01:40 GMT+0300 (EEST)
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Ykis.view.sprav.WinAddDTeplomer', {
    extend: 'Ext.window.Window',
    alias: 'widget.winadddteplomer',

    requires: [
        'Ykis.view.sprav.WinAddDTeplomerViewModel',
        'Ext.form.Panel',
        'Ext.form.FieldSet',
        'Ext.form.field.ComboBox',
        'Ext.form.field.Number',
        'Ext.button.Button',
        'Ext.form.field.Date',
        'Ext.form.field.Checkbox',
        'Ext.form.field.Hidden'
    ],

    viewModel: {
        type: 'winadddteplomer'
    },
    height: 456,
    id: 'winAddDTeplomer',
    width: 645,
    layout: 'fit',
    title: 'Ввод нового домового тепломера',
    modal: true,
    defaultListenerScope: true,

    items: [
        {
            xtype: 'form',
            height: 441,
            id: 'fmAddDTeplomer',
            layout: 'absolute',
            bodyPadding: 10,
            title: '',
            items: [
                {
                    xtype: 'fieldset',
                    x: 25,
                    y: 15,
                    height: 105,
                    style: 'background-color: #DCDCDC;',
                    width: 590,
                    layout: 'absolute',
                    title: 'Тепломер',
                    items: [
                        {
                            xtype: 'combobox',
                            x: 140,
                            y: 10,
                            formBind: false,
                            width: 250,
                            fieldLabel: 'Модель',
                            labelWidth: 50,
                            name: 'model_id',
                            allowBlank: false,
                            displayField: 'model',
                            queryMode: 'local',
                            store: 'StTmodel',
                            valueField: 'model_id'
                        },
                        {
                            xtype: 'numberfield',
                            x: 380,
                            y: 45,
                            formBind: false,
                            id: 'koefEdIzmDT',
                            width: 135,
                            fieldLabel: 'коеф',
                            labelWidth: 40,
                            name: 'koef',
                            allowBlank: false,
                            blankText: 'Поле обязательное для заполнения',
                            hideTrigger: true,
                            decimalPrecision: 5
                        },
                        {
                            xtype: 'combobox',
                            x: 205,
                            y: 45,
                            width: 145,
                            fieldLabel: 'Ед.изм.',
                            labelWidth: 50,
                            name: 'edizm',
                            displayField: 'edizm',
                            queryMode: 'local',
                            store: 'StEdIzm',
                            valueField: 'edizm',
                            listeners: {
                                select: 'onComboboxSelect'
                            }
                        },
                        {
                            xtype: 'textfield',
                            x: 10,
                            y: 45,
                            formBind: false,
                            width: 185,
                            fieldLabel: 'Номер',
                            labelWidth: 50,
                            name: 'nomer',
                            allowBlank: false,
                            blankText: 'Поле обязательное для заполнения'
                        }
                    ]
                },
                {
                    xtype: 'button',
                    x: 365,
                    y: 365,
                    formBind: true,
                    height: 30,
                    id: 'btAddDTeplomer',
                    width: 160,
                    icon: 'resources/css/images/ico/add.png',
                    text: 'Добавить тепломер'
                },
                {
                    xtype: 'button',
                    handler: function(button, event) {
                        button.up('#winAddDTeplomer').close();
                    },
                    x: 150,
                    y: 365,
                    height: 30,
                    width: 95,
                    icon: 'resources/css/images/ico/delete.png',
                    text: 'Отмена'
                },
                {
                    xtype: 'fieldset',
                    x: 75,
                    y: 200,
                    height: 145,
                    id: 'fcntNewDTeplomer',
                    style: 'background-color: #e0e0e0;',
                    width: 240,
                    title: 'Повірка',
                    items: [
                        {
                            xtype: 'datefield',
                            anchor: '100%',
                            fieldLabel: 'Остання',
                            labelWidth: 70,
                            name: 'pdate',
                            allowBlank: false,
                            format: 'd-m-Y',
                            submitFormat: 'Ymd'
                        },
                        {
                            xtype: 'datefield',
                            anchor: '100%',
                            fieldLabel: 'Наступна',
                            labelWidth: 70,
                            name: 'fpdate',
                            format: 'd-m-Y',
                            submitFormat: 'Ymd'
                        },
                        {
                            xtype: 'textfield',
                            anchor: '100%',
                            fieldLabel: '№ пломби',
                            labelWidth: 70,
                            name: 'plomba'
                        },
                        {
                            xtype: 'checkboxfield',
                            anchor: '100%',
                            padding: '0 0 0 20',
                            width: 120,
                            fieldLabel: '',
                            name: 'paused',
                            boxLabel: 'Призупинено',
                            inputValue: '1',
                            uncheckedValue: '0'
                        }
                    ]
                },
                {
                    xtype: 'fieldset',
                    x: 325,
                    y: 200,
                    height: 145,
                    style: 'background-color: #e0e0e0;',
                    width: 240,
                    title: 'Установка',
                    items: [
                        {
                            xtype: 'datefield',
                            anchor: '100%',
                            fieldLabel: 'Дата випуску',
                            name: 'zdate',
                            format: 'd-m-Y',
                            submitFormat: 'Ymd'
                        },
                        {
                            xtype: 'numberfield',
                            anchor: '100%',
                            width: 218,
                            fieldLabel: 'термін повірки (рік)',
                            labelWidth: 150,
                            name: 'pp',
                            value: 0,
                            blankText: 'Поле обязательное для заполнения',
                            hideTrigger: true,
                            decimalPrecision: 0
                        },
                        {
                            xtype: 'datefield',
                            anchor: '100%',
                            fieldLabel: 'Дата введення',
                            name: 'sdate',
                            format: 'd-m-Y',
                            submitFormat: 'Ymd'
                        },
                        {
                            xtype: 'numberfield',
                            anchor: '100%',
                            fieldLabel: 'Первинне показання',
                            name: 'tek',
                            value: 0,
                            allowBlank: false,
                            blankText: 'Поле обязательное для заполнения',
                            hideTrigger: true,
                            decimalPrecision: 3
                        }
                    ]
                },
                {
                    xtype: 'fieldset',
                    x: 25,
                    y: 125,
                    height: 70,
                    style: 'background-color: #f1eeee;',
                    width: 590,
                    layout: 'absolute',
                    title: 'Номер ввода',
                    items: [
                        {
                            xtype: 'numberfield',
                            x: 270,
                            y: 5,
                            hidden: true,
                            width: 90,
                            fieldLabel: 'с',
                            labelWidth: 20,
                            name: 'first_app',
                            allowDecimals: false,
                            decimalPrecision: 0,
                            step: 10
                        },
                        {
                            xtype: 'numberfield',
                            x: 370,
                            y: 5,
                            hidden: true,
                            width: 90,
                            fieldLabel: 'по',
                            labelWidth: 20,
                            name: 'last_app',
                            allowDecimals: false,
                            decimalPrecision: 0,
                            step: 10
                        },
                        {
                            xtype: 'checkboxfield',
                            x: 160,
                            y: 5,
                            fieldLabel: '',
                            name: 'allapp',
                            boxLabel: 'все квартиры',
                            checked: true,
                            inputValue: '1',
                            uncheckedValue: '0',
                            listeners: {
                                change: 'onCheckboxfieldChange111'
                            }
                        },
                        {
                            xtype: 'combobox',
                            x: 0,
                            y: 5,
                            width: 150,
                            fieldLabel: 'Ввод',
                            labelWidth: 50,
                            name: 'vvod',
                            allowBlank: false,
                            displayField: 'vvod',
                            queryMode: 'local',
                            store: 'StVvod',
                            valueField: 'vvod'
                        },
                        {
                            xtype: 'button',
                            handler: function(button, e) {
                                var form = button.findParentByType('form');
                                var value = form.getValues();
                                var stUser = Ext.data.StoreManager.get("StUser");
                                var StTekPokDTeplomera = Ext.data.StoreManager.get("StTekPokDTeplomera");
                                var values =stUser.getAt(0);
                                var params = {
                                    login:values.get('login'),
                                    password:values.get('password'),
                                    what:"updateVvodDteplomer"
                                };

                                var fmDTeplomers = Ext.getCmp('fmDTeplomers');
                                var fmAddDTeplomer = Ext.getCmp('fmAddDTeplomer');
                                var value = fmAddDTeplomer.getValues();

                                Ext.Object.merge(value, params);

                                var myMask= Ext.Msg.show({
                                    title:'Оновлення квартир на введенні приладу обліку...',
                                    msg: 'Оновлення квартир.Чекайте...',
                                    buttons: Ext.Msg.CANCEL,
                                    wait: true,
                                    modal: true,
                                    icon: Ext.Msg.INFO
                                });
                                QueryTeplomer.addTeplomer(value,function(results){
                                    if (results.success){
                                        StTekPokDTeplomera.load({
                                            params: {
                                                login:values.get('login'),
                                                password:values.get('password'),
                                                what:'TekPokDTeplomera',
                                                dteplomer_id:value.dteplomer_id

                                            },
                                            callback: function(records,operation,success){
                                                if(success){
                                                    Ext.MessageBox.show({
                                                        title: 'Оновлення квартир на введенні приладу обліку',
                                                        msg: results.msg,
                                                        buttons: Ext.MessageBox.OK,
                                                        icon: Ext.MessageBox.INFO
                                                    });
                                                    fmDTeplomers.getForm().loadRecord(records[0]);
                                                }
                                            },
                                            scope:this
                                        });

                                    }else{
                                        Ext.MessageBox.show({
                                            title: 'Оновлення квартир на введенні приладу обліку',
                                            msg: results.msg,
                                            buttons: Ext.MessageBox.OK,
                                            icon: Ext.MessageBox.ERROR
                                        });
                                    }
                                    //myMask.close();

                                });
                                button.up('#winAddDTeplomer').close();
                            },
                            x: 470,
                            y: 5,
                            hidden: true,
                            id: 'btnUpdateVvodDT',
                            width: 90,
                            icon: 'resources/css/images/ico/add.png',
                            text: 'Оновити'
                        }
                    ]
                },
                {
                    xtype: 'hiddenfield',
                    fieldLabel: 'Label',
                    name: 'dteplomer_id'
                }
            ]
        }
    ],

    onComboboxSelect: function(combo, record, eOpts) {
        var koefEdIzm = Ext.getCmp('koefEdIzmDT');
        var selected = record;
        //console.log(faddress);
        if (selected) {
            koefEdIzm.setValue(selected.get('koef'));
        }
    },

    onCheckboxfieldChange111: function(field, newValue, oldValue, eOpts) {
        var form = field.findParentByType('form');

        if (newValue) {
            form.getForm().findField('first_app').setValue(0);
            form.getForm().findField('last_app').setValue(0);
            form.getForm().findField('first_app').hide();
            form.getForm().findField('last_app').hide();
        } else {
            form.getForm().findField('first_app').setValue(1);
            form.getForm().findField('last_app').setValue(0);
            form.getForm().findField('first_app').show();
            form.getForm().findField('last_app').show();
            //form.getForm().reset();
            //var btn = form.down('#btAddDVodomer').focus();
            // console.log(btn)

        }
    }

});