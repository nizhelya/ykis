/*
 * File: app/view/sprav/WinAddOplataOrg.js
 * Date: Sun May 17 2020 02:44:16 GMT+0300 (EEST)
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Ykis.view.sprav.WinAddOplataOrg', {
    extend: 'Ext.window.Window',
    alias: 'widget.winaddoplataorg',

    requires: [
        'Ykis.view.sprav.WinAddOplataOrgViewModel',
        'Ext.form.Panel',
        'Ext.form.FieldSet',
        'Ext.form.field.Hidden',
        'Ext.form.field.ComboBox',
        'Ext.form.field.Date',
        'Ext.form.field.Number',
        'Ext.form.field.TextArea',
        'Ext.form.field.Checkbox',
        'Ext.button.Button'
    ],

    viewModel: {
        type: 'winaddoplataorg'
    },
    height: 592,
    id: 'winAddOplataOrg',
    width: 726,
    layout: 'fit',
    title: 'Ввод оплаты',
    modal: true,
    defaultListenerScope: true,

    items: [
        {
            xtype: 'form',
            id: 'fmAddOplataOrg',
            layout: 'fit',
            title: '',
            items: [
                {
                    xtype: 'fieldset',
                    style: 'background-color: #e0e0e0;',
                    width: 415,
                    title: '',
                    items: [
                        {
                            xtype: 'hiddenfield',
                            fieldLabel: 'Запись_ид',
                            labelAlign: 'top',
                            name: 'rec_id'
                        },
                        {
                            xtype: 'fieldset',
                            anchor: '100%',
                            height: 138,
                            style: 'background-color: #DCDCDC;',
                            width: 675,
                            layout: 'absolute',
                            title: 'Реквизиты плательщика',
                            items: [
                                {
                                    xtype: 'combobox',
                                    anchor: '100%',
                                    x: 10,
                                    width: 653,
                                    fieldLabel: 'Организация',
                                    labelAlign: 'top',
                                    name: 'org_id',
                                    allowBlank: false,
                                    anyMatch: true,
                                    displayField: 'sname',
                                    forceSelection: true,
                                    queryMode: 'local',
                                    store: 'StOrgOpl',
                                    valueField: 'org_id',
                                    listeners: {
                                        select: 'onComboboxSelect'
                                    }
                                },
                                {
                                    xtype: 'combobox',
                                    anchor: '100%',
                                    x: 10,
                                    y: 50,
                                    width: 653,
                                    fieldLabel: 'Обьект',
                                    labelAlign: 'top',
                                    name: 'filial_id',
                                    allowBlank: false,
                                    anyMatch: true,
                                    displayField: 'name',
                                    forceSelection: true,
                                    queryMode: 'local',
                                    store: 'StFilialOpl',
                                    valueField: 'filial_id'
                                }
                            ]
                        },
                        {
                            xtype: 'fieldset',
                            anchor: '100%',
                            height: 329,
                            style: 'background-color: #DCDCDC;',
                            width: 675,
                            layout: 'absolute',
                            title: 'Реквизиты платежа',
                            items: [
                                {
                                    xtype: 'textfield',
                                    x: 10,
                                    y: 170,
                                    formBind: false,
                                    width: 160,
                                    fieldLabel: '№ док',
                                    labelWidth: 60,
                                    name: 'nomer',
                                    allowBlank: false,
                                    blankText: 'Поле обязательное для заполнения'
                                },
                                {
                                    xtype: 'datefield',
                                    x: 200,
                                    y: 170,
                                    width: 230,
                                    fieldLabel: 'Дата платежа',
                                    name: 'data',
                                    allowBlank: false,
                                    format: 'd-m-Y',
                                    submitFormat: 'Ymd'
                                },
                                {
                                    xtype: 'numberfield',
                                    x: 470,
                                    y: 170,
                                    width: 165,
                                    fieldLabel: 'Сумма',
                                    labelWidth: 50,
                                    name: 'summa',
                                    value: 0,
                                    fieldStyle: 'background-color:#F0F8FF;font-size:11pt;text-align:right;',
                                    allowBlank: false,
                                    hideTrigger: true
                                },
                                {
                                    xtype: 'combobox',
                                    x: 10,
                                    y: 210,
                                    saveDelay: 120,
                                    width: 180,
                                    fieldLabel: 'Коммунальная услуга',
                                    labelAlign: 'top',
                                    labelWidth: 150,
                                    name: 'pr',
                                    allowBlank: false,
                                    displayField: 'usluga',
                                    queryMode: 'local',
                                    store: 'StUsluga',
                                    valueField: 'pr'
                                },
                                {
                                    xtype: 'textareafield',
                                    x: 240,
                                    y: 210,
                                    width: 405,
                                    fieldLabel: 'Детали платежа',
                                    labelAlign: 'top',
                                    name: 'note',
                                    grow: true
                                },
                                {
                                    xtype: 'checkboxfield',
                                    x: 10,
                                    y: 260,
                                    fieldLabel: 'Оплата введена',
                                    labelWidth: 120,
                                    name: 'opl',
                                    boxLabel: 'Нет',
                                    inputValue: '1',
                                    uncheckedValue: '0',
                                    listeners: {
                                        change: 'onCheckboxfieldChange101'
                                    }
                                },
                                {
                                    xtype: 'fieldset',
                                    anchor: '100%',
                                    x: 0,
                                    y: 10,
                                    height: 145,
                                    style: 'background-color: #e0e0e0;',
                                    width: 155,
                                    layout: 'absolute',
                                    title: '',
                                    items: [
                                        {
                                            xtype: 'textfield',
                                            anchor: '100%',
                                            x: 80,
                                            y: 10,
                                            width: 570,
                                            fieldLabel: 'Организация',
                                            labelAlign: 'top',
                                            labelWidth: 80,
                                            name: 'iname'
                                        },
                                        {
                                            xtype: 'combobox',
                                            anchor: '100%',
                                            x: 10,
                                            y: 65,
                                            fieldLabel: 'Банк',
                                            labelWidth: 40,
                                            name: 'mfo',
                                            anyMatch: true,
                                            displayField: 'sname',
                                            queryMode: 'local',
                                            store: 'StBanks',
                                            valueField: 'mfo'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 10,
                                            y: 100,
                                            width: 215,
                                            fieldLabel: 'Р/с',
                                            labelWidth: 40,
                                            name: 'rs'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 230,
                                            y: 100,
                                            width: 215,
                                            fieldLabel: 'ЕДРПОУ',
                                            labelWidth: 70,
                                            name: 'edrpou'
                                        },
                                        {
                                            xtype: 'textfield',
                                            x: 0,
                                            y: 10,
                                            width: 76,
                                            fieldLabel: 'Код',
                                            labelAlign: 'top',
                                            name: 'iorg_id'
                                        },
                                        {
                                            xtype: 'checkboxfield',
                                            x: 460,
                                            y: 100,
                                            fieldLabel: 'Записать реквизиты',
                                            labelWidth: 140,
                                            name: 'ins',
                                            boxLabel: 'Нет',
                                            inputValue: '1',
                                            uncheckedValue: '0',
                                            listeners: {
                                                change: 'onCheckboxfieldChange1011'
                                            }
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            xtype: 'button',
                            handler: function(button, e) {
                                /// in use
                                //CONTROLLER

                                var value = button.findParentByType('form').getValues();
                                var form = button.findParentByType('form');
                                var oplata = 0;
                                var summa = form.getForm().findField('summa').getValue();
                                var stUser = Ext.data.StoreManager.get("StUser");
                                var StOplataOrg = Ext.data.StoreManager.get("StOplataOrg");
                                var values =stUser.getAt(0);
                                var params = {
                                    login:values.get('login'),
                                    password:values.get('password'),
                                    what:"addOplataOrg"
                                };

                                if (summa !== "0") {
                                    Ext.Object.merge(value, params);
                                    QueryAddress.updateRecords(value,function(results){
                                        if(results.success==="1"){

                                            Ext.MessageBox.show({
                                                title: 'Запись оплаты в базу начислений',
                                                msg: results.msg,
                                                buttons: Ext.MessageBox.OK,
                                                icon: Ext.MessageBox.INFO
                                            });
                                            StOplataOrg.load({
                                                params: {
                                                    what:'getOplataOrg',
                                                    login:values.get('login'),
                                                    password:values.get('password')
                                                },
                                                scope:this
                                            });
                                        } else {

                                            Ext.MessageBox.show({
                                                title: 'Запись оплаты в базу начислений',
                                                msg: results.msg,
                                                buttons: Ext.MessageBox.OK,
                                                icon: Ext.MessageBox.ERROR
                                            });
                                        }


                                    });
                                    this.up('#winAddOplataOrg').close();
                                } else {
                                    Ext.MessageBox.show({
                                        title: 'Контроль данных',
                                        msg: 'Оплата равна 0',
                                        buttons: Ext.MessageBox.OK,
                                        icon: Ext.MessageBox.ERROR
                                    });
                                }

                            },
                            formBind: true,
                            id: 'btAddOplataOrg',
                            width: 290,
                            icon: 'resources/css/images/ico/yes.png',
                            text: 'ввод оплаты в базу начислений'
                        }
                    ]
                }
            ]
        }
    ],

    onComboboxSelect: function(combo, record, eOpts) {
        var store = combo.getStore();
        var selected = record;
        var form = combo.findParentByType('form');
        var cbFilial = form.getForm().findField('filial_id');
        var edrpou = form.getForm().findField('edrpou');
        var rs = form.getForm().findField('rs');
        //var iname = form.getForm().findField('iname');
        //var iorg_id = form.getForm().findField('iorg_id');

        var stUser = Ext.data.StoreManager.get("StUser");
        var StFilialOpl = Ext.data.StoreManager.get("StFilialOpl");
        var values =stUser.getAt(0);


        if (selected && !store.getById(selected.get("org_id"))) {
            edrpou.setValue(selected.get("edrpou"));
            rs.setValue(selected.get("rs"));
            //iname.setValue(selected.get("fname"));
            //iorg_id.setValue(selected.get("org_id"));

            cbFilial.clearValue();
            StFilialOpl.removeAll();

            StFilialOpl.load({
                params: {
                    what:'getFilialOrg',
                    login:values.get('login'),
                    password:values.get('password'),
                    org_id:selected.get('org_id')

                },
                scope:this
            });

        }

    },

    onCheckboxfieldChange101: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    },

    onCheckboxfieldChange1011: function(field, newValue, oldValue, eOpts) {
        if(newValue){
            field.setBoxLabel("Да");
        }else{
            field.setBoxLabel("Нет");
        }
    }

});