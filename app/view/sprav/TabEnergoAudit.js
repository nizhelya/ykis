/*
 * File: app/view/sprav/TabEnergoAudit.js
 * Date: Wed Dec 09 2020 13:39:15 GMT+0200 (EET)
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Ykis.view.sprav.TabEnergoAudit', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.tabenergoaudit',

    requires: [
        'Ykis.view.sprav.TabEnergoAuditViewModel',
        'Ykis.view.sprav.TabEnergoAuditViewController',
        'Ext.form.Panel',
        'Ext.grid.Panel',
        'Ext.view.Table',
        'Ext.toolbar.Toolbar',
        'Ext.form.field.ComboBox',
        'Ext.button.Button',
        'Ext.selection.CheckboxModel',
        'Ext.grid.column.Number',
        'Ext.grid.feature.Summary',
        'Ext.form.field.Number',
        'Ext.grid.column.Action',
        'Ext.grid.feature.GroupingSummary'
    ],

    controller: 'tabenergoaudit',
    viewModel: {
        type: 'tabenergoaudit'
    },
    id: 'tabEnergoAudit',
    scrollable: true,
    layout: 'fit',
    bodyBorder: false,
    closable: true,
    title: 'Єнергоаудіт',
    defaultListenerScope: true,

    initConfig: function(instanceConfig) {
        var me = this,
            config = {
                items: [
                    {
                        xtype: 'form',
                        height: 705,
                        id: 'fmEnergoAudit',
                        scrollable: true,
                        layout: 'absolute',
                        bodyPadding: 10,
                        title: '',
                        standardSubmit: true,
                        items: [
                            {
                                xtype: 'gridpanel',
                                x: 0,
                                y: 5,
                                height: 710,
                                id: 'grEnauditOut',
                                scrollable: true,
                                width: 265,
                                bodyBorder: true,
                                title: 'Список будинків без енергоаудіта',
                                store: 'StHouseEnOut',
                                viewConfig: {
                                    height: 421
                                },
                                dockedItems: [
                                    {
                                        xtype: 'toolbar',
                                        dock: 'top',
                                        items: [
                                            {
                                                xtype: 'combobox',
                                                id: 'cbRaionEnaudit',
                                                padding: '5 5 5 5',
                                                width: 225,
                                                fieldLabel: 'Район',
                                                labelWidth: 60,
                                                name: 'raion_id',
                                                editable: false,
                                                emptyText: 'Выбор района',
                                                displayField: 'raion',
                                                queryMode: 'local',
                                                store: 'StRaionOrg',
                                                valueField: 'raion_id',
                                                listeners: {
                                                    select: 'onCbRaionEnaudit'
                                                }
                                            }
                                        ]
                                    },
                                    {
                                        xtype: 'toolbar',
                                        dock: 'top',
                                        items: [
                                            {
                                                xtype: 'button',
                                                handler: function(button, event) {
                                                    var me = this;
                                                    var StUser = Ext.data.StoreManager.get("StUser");
                                                    var values =StUser.getAt(0);

                                                    var StHouseEnOut = Ext.data.StoreManager.get("StHouseEnOut");
                                                    var StHouseEnIn = Ext.data.StoreManager.get("StHouseEnIn");
                                                    var raion_id =  Ext.getCmp('cbRaionEnaudit').getValue();

                                                    //V
                                                    var grid = Ext.getCmp('grEnauditOut');
                                                    var gridRowSelectedRecords  = grid.getView().getSelectionModel().getSelection();
                                                    var size = Ext.Object.getSize(gridRowSelectedRecords) ;
                                                    var houses =[];
                                                    if (size >= 1){

                                                        Ext.Object.each(gridRowSelectedRecords, function(key, val, myself) {
                                                            Ext.Object.merge(val.data, houses);
                                                            houses.push(val.data.house_id);
                                                        });

                                                    }

                                                    if (size) {


                                                        var value = {
                                                            login:values.get('login'),
                                                            password:values.get('password'),
                                                            what:'EnauditAddHouses',
                                                            qty:size,
                                                            houses: houses
                                                        };

                                                        QueryReport.getResults(value,function(data){
                                                            if (data){

                                                                StHouseEnIn.load({
                                                                    params: {
                                                                        what:'enaudit_in',
                                                                        login:values.get('login'),
                                                                        raion_id:raion_id,
                                                                        password:values.get('password')
                                                                    },
                                                                    scope:this
                                                                });
                                                                StHouseEnOut.load({
                                                                    params: {
                                                                        what:'enaudit_out',
                                                                        login:values.get('login'),
                                                                        password:values.get('password'),
                                                                        raion_id:raion_id

                                                                    },
                                                                    scope:this
                                                                });
                                                                Ext.MessageBox.show({
                                                                    title: 'Енергоаудит добавление.. ',
                                                                    msg: data.msg,
                                                                    buttons: Ext.MessageBox.OK,
                                                                    icon: Ext.MessageBox.INFO
                                                                });
                                                            } else {
                                                                Ext.MessageBox.show({
                                                                    title: 'Енергоаудит добавление..',
                                                                    msg: data.msg,
                                                                    buttons: Ext.MessageBox.OK,
                                                                    icon: Ext.MessageBox.ERROR
                                                                });
                                                            }


                                                        });


                                                    }
                                                    button.setDisabled(false);

                                                },
                                                disabled: true,
                                                id: 'btnAddHousesEnaudit',
                                                width: 155,
                                                icon: 'resources/css/images/ico/yes.png',
                                                text: 'Додати в список'
                                            }
                                        ]
                                    }
                                ],
                                selModel: Ext.create('Ext.selection.CheckboxModel', {
                                    selType: 'checkboxmodel',
                                    mode: 'SIMPLE',
                                    showHeaderCheckbox: true
                                }),
                                columns: [
                                    {
                                        xtype: 'numbercolumn',
                                        width: 50,
                                        dataIndex: 'house_id',
                                        menuDisabled: true,
                                        text: 'ид',
                                        format: '0'
                                    },
                                    {
                                        xtype: 'gridcolumn',
                                        width: 156,
                                        dataIndex: 'house',
                                        menuDisabled: true,
                                        text: 'Дом'
                                    }
                                ],
                                listeners: {
                                    select: {
                                        fn: 'onGrEnauditOutSelect',
                                        scope: 'controller'
                                    }
                                }
                            },
                            {
                                xtype: 'gridpanel',
                                x: 775,
                                y: 5,
                                height: 500,
                                id: 'grEnauditKv',
                                scrollable: true,
                                width: 335,
                                bodyBorder: true,
                                title: 'Список квартир',
                                store: 'StAddressDt',
                                viewConfig: {
                                    height: 500
                                },
                                columns: [
                                    {
                                        xtype: 'numbercolumn',
                                        hidden: true,
                                        width: 41,
                                        dataIndex: 'enaudit_id',
                                        menuDisabled: true,
                                        text: 'en_id',
                                        format: '0'
                                    },
                                    {
                                        xtype: 'gridcolumn',
                                        renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                            switch (value) {
                                                case "да":
                                                metaData='<span><img clas="icon" src="resources/css/images/ico/yes.png"/></span>';
                                                break;
                                                case "нет":
                                                metaData='<span><img clas="icon" src="resources/css/images/ico/no.png"/></span>';
                                                break;
                                            }
                                            return metaData;

                                        },
                                        width: 36,
                                        dataIndex: 'otoplenie',
                                        menuDisabled: true,
                                        text: 'вкл'
                                    },
                                    {
                                        xtype: 'gridcolumn',
                                        width: 148,
                                        dataIndex: 'address',
                                        menuDisabled: true,
                                        text: 'Адрес'
                                    },
                                    {
                                        xtype: 'numbercolumn',
                                        summaryType: 'sum',
                                        width: 64,
                                        dataIndex: 'area_otopl',
                                        menuDisabled: true,
                                        text: 'S_(м&sup2;)',
                                        format: '0.00'
                                    },
                                    {
                                        xtype: 'numbercolumn',
                                        summaryType: 'sum',
                                        width: 64,
                                        dataIndex: 'area_otopl',
                                        menuDisabled: true,
                                        text: 'S_(контр)',
                                        format: '0.00'
                                    }
                                ],
                                features: [
                                    {
                                        ftype: 'summary',
                                        dock: 'top'
                                    }
                                ]
                            },
                            {
                                xtype: 'gridpanel',
                                x: 270,
                                y: 5,
                                height: 500,
                                id: 'grEnauditIn',
                                scrollable: true,
                                width: 500,
                                bodyBorder: true,
                                title: 'Список будинків які провели енергоаудит',
                                store: 'StHouseEnIn',
                                viewConfig: {
                                    getRowClass: function(record, rowIndex, rowParams, store) {

                                        if(record.get('check') === 1 ){

                                            return  'change_color_red';
                                        }

                                    },
                                    height: 626
                                },
                                dockedItems: [
                                    {
                                        xtype: 'toolbar',
                                        dock: 'top',
                                        items: [
                                            {
                                                xtype: 'button',
                                                handler: function(button, event) {
                                                    var me = this;
                                                    var StUser = Ext.data.StoreManager.get("StUser");
                                                    var values =StUser.getAt(0);
                                                    var StOrgByDteplomer = Ext.data.StoreManager.get("StOrgByDteplomer");
                                                    var StAddressDt = Ext.data.StoreManager.get("StAddressDt");
                                                    var raion_id =  Ext.getCmp('cbRaionEnaudit').getValue();

                                                    var StHouseEnOut = Ext.data.StoreManager.get("StHouseEnOut");
                                                    var StHouseEnIn = Ext.data.StoreManager.get("StHouseEnIn");

                                                    //V
                                                    var grid = Ext.getCmp('grEnauditIn');
                                                    var gridRowSelectedRecords  = grid.getView().getSelectionModel().getSelection();
                                                    var size = Ext.Object.getSize(gridRowSelectedRecords) ;
                                                    var houses =[];
                                                    if (size >= 1){

                                                        Ext.Object.each(gridRowSelectedRecords, function(key, val, myself) {
                                                            Ext.Object.merge(val.data, houses);
                                                            houses.push(val.data.house_id);
                                                        });

                                                    }

                                                    if (size) {

                                                        StOrgByDteplomer.removeAll();
                                                        StAddressDt.removeAll();

                                                        var value = {
                                                            login:values.get('login'),
                                                            password:values.get('password'),
                                                            what:'EnauditDelHouses',
                                                            houses: houses
                                                        };

                                                        QueryReport.getResults(value,function(data){
                                                            if (data){

                                                                StHouseEnIn.load({
                                                                    params: {
                                                                        what:'enaudit_in',
                                                                        login:values.get('login'),
                                                                        password:values.get('password'),
                                                                        raion_id:raion_id

                                                                    },
                                                                    scope:this
                                                                });
                                                                StHouseEnOut.load({
                                                                    params: {
                                                                        what:'enaudit_out',
                                                                        login:values.get('login'),
                                                                        password:values.get('password'),
                                                                        raion_id:raion_id

                                                                    },
                                                                    scope:this
                                                                });
                                                                Ext.MessageBox.show({
                                                                    title: 'Енергоаудит добавление.. ',
                                                                    msg: data.msg,
                                                                    buttons: Ext.MessageBox.OK,
                                                                    icon: Ext.MessageBox.INFO
                                                                });
                                                            } else {
                                                                Ext.MessageBox.show({
                                                                    title: 'Енергоаудит добавление..',
                                                                    msg: data.msg,
                                                                    buttons: Ext.MessageBox.OK,
                                                                    icon: Ext.MessageBox.ERROR
                                                                });
                                                            }


                                                        });


                                                    }
                                                    button.setDisabled(false);

                                                },
                                                disabled: true,
                                                id: 'btnDelHousesEnaudit',
                                                width: 140,
                                                icon: 'resources/css/images/ico/no.png',
                                                text: 'Видалити зі списку '
                                            },
                                            {
                                                xtype: 'numberfield',
                                                disabled: true,
                                                id: 'tnb',
                                                width: 101,
                                                fieldLabel: 'ТНБ',
                                                labelWidth: 30,
                                                name: 'tnb',
                                                value: 0.000,
                                                hideTrigger: true,
                                                decimalPrecision: 6
                                            },
                                            {
                                                xtype: 'button',
                                                handler: function(button, event) {
                                                    var me = this;
                                                    var StUser = Ext.data.StoreManager.get("StUser");
                                                    var values =StUser.getAt(0);

                                                    var StHouseEnIn = Ext.data.StoreManager.get("StHouseEnIn");
                                                    var tnb = Ext.getCmp('tnb').getValue();
                                                    var raion_id =  Ext.getCmp('cbRaionEnaudit').getValue();

                                                    var grid = Ext.getCmp('grEnauditIn');
                                                    var gridRowSelectedRecords  = grid.getView().getSelectionModel().getSelection();
                                                    var size = Ext.Object.getSize(gridRowSelectedRecords) ;
                                                    var houses =[];
                                                    if (size >= 1 & tnb !==0){

                                                        Ext.Object.each(gridRowSelectedRecords, function(key, val, myself) {
                                                            Ext.Object.merge(val.data, houses);
                                                            houses.push(val.data.house_id);
                                                        });

                                                        var value = {
                                                            login:values.get('login'),
                                                            password:values.get('password'),
                                                            what:'EnauditInsTnb',
                                                            tnb:tnb,
                                                            houses: houses
                                                        };

                                                        QueryReport.getResults(value,function(data){
                                                            if (data){

                                                                StHouseEnIn.load({
                                                                    params: {
                                                                        what:'enaudit_in',
                                                                        login:values.get('login'),
                                                                        password:values.get('password'),
                                                                        raion_id:raion_id

                                                                    },
                                                                    scope:this
                                                                });

                                                                Ext.MessageBox.show({
                                                                    title: 'Начисление Нагрузки.. ',
                                                                    msg:data.msg,
                                                                    buttons: Ext.MessageBox.OK,
                                                                    icon: Ext.MessageBox.INFO
                                                                });
                                                            } else {
                                                                Ext.MessageBox.show({
                                                                    title: 'Начисление Нагрузки.. ',
                                                                    msg:data.msg,
                                                                    buttons: Ext.MessageBox.OK,
                                                                    icon: Ext.MessageBox.ERROR
                                                                });
                                                            }


                                                        });
                                                    } else {
                                                        Ext.MessageBox.show({
                                                            title: 'Начисление Нагрузки.. ',
                                                            msg:"Не выбраны дома или не введена нагрузка",
                                                            buttons: Ext.MessageBox.OK,
                                                            icon: Ext.MessageBox.ERROR
                                                        });

                                                    }


                                                },
                                                disabled: true,
                                                id: 'btnInsTnb',
                                                width: 115,
                                                icon: 'resources/css/images/ico/yes.png',
                                                text: 'начислить тнб'
                                            },
                                            {
                                                xtype: 'button',
                                                handler: function(button, event) {
                                                    var StHouseEnIn = Ext.data.StoreManager.get("StHouseEnIn");
                                                    var StUser = Ext.data.StoreManager.get("StUser");
                                                    var values =StUser.getAt(0);
                                                    var raion_id =  Ext.getCmp('cbRaionEnaudit').getValue();

                                                    var params = {
                                                        login:values.get('login'),
                                                        password:values.get('password'),
                                                        what:'EnauditControl'
                                                    };

                                                    QueryAddress.updateRecords(params,function(results){
                                                        if(results.success==="1"){
                                                            StHouseEnIn.load({
                                                                params: {
                                                                    what:'enaudit_in',
                                                                    login:values.get('login'),
                                                                    password:values.get('password'),
                                                                    raion_id:raion_id

                                                                }
                                                            });

                                                            Ext.MessageBox.show({
                                                                title: 'Контроль площадей по нагрузки..',
                                                                msg: results.msg,
                                                                buttons: Ext.MessageBox.OK,
                                                                icon: Ext.MessageBox.INFO
                                                            });
                                                        } else {
                                                            Ext.MessageBox.show({
                                                                title: 'Контроль площадей по нагрузки.. ',
                                                                msg: results.msg,
                                                                buttons: Ext.MessageBox.OK,
                                                                icon: Ext.MessageBox.ERROR
                                                            });

                                                        }

                                                    });
                                                },
                                                disabled: true,
                                                id: 'btnEnControl',
                                                width: 115,
                                                icon: 'resources/css/images/ico/xsldbg_refresh.png',
                                                text: 'контроль S_(м&sup2;)'
                                            }
                                        ]
                                    }
                                ],
                                selModel: Ext.create('Ext.selection.CheckboxModel', {
                                    selType: 'checkboxmodel'
                                }),
                                columns: [
                                    {
                                        xtype: 'actioncolumn',
                                        maxWidth: 25,
                                        minWidth: 25,
                                        width: 112,
                                        menuDisabled: true,
                                        items: [
                                            {
                                                getClass: function(v, metadata, r, rowIndex, colIndex, store) {
                                                    var en = r.get('qty');
                                                    if (en === 1 ) {
                                                        metaData = 'x-hide-display';
                                                    } else {
                                                        metaData = 'x-grid-center-icon';
                                                    }
                                                    return metaData;
                                                },
                                                icon: 'resources/css/images/ico/elbow-plus.png',
                                                tooltip: 'добавить обьект к вводу (Дводомеру)'
                                            }
                                        ]
                                    },
                                    {
                                        xtype: 'numbercolumn',
                                        hidden: true,
                                        width: 50,
                                        dataIndex: 'house_id',
                                        menuDisabled: true,
                                        text: 'ид',
                                        format: '0'
                                    },
                                    {
                                        xtype: 'numbercolumn',
                                        hidden: true,
                                        width: 45,
                                        dataIndex: 'enaudit_id',
                                        menuDisabled: true,
                                        text: 'ен_ид',
                                        format: '0'
                                    },
                                    {
                                        xtype: 'gridcolumn',
                                        width: 120,
                                        dataIndex: 'house',
                                        menuDisabled: true,
                                        text: 'Дом'
                                    },
                                    {
                                        xtype: 'numbercolumn',
                                        summaryType: 'sum',
                                        width: 65,
                                        dataIndex: 'enaudit_area',
                                        menuDisabled: true,
                                        text: 'S_(м&sup2;)',
                                        format: '0.00'
                                    },
                                    {
                                        xtype: 'numbercolumn',
                                        summaryType: 'sum',
                                        width: 65,
                                        dataIndex: 'control_area',
                                        menuDisabled: true,
                                        text: 'S_(контр)',
                                        format: '0.00'
                                    },
                                    {
                                        xtype: 'numbercolumn',
                                        summaryType: 'sum',
                                        width: 72,
                                        dataIndex: 'tnb',
                                        menuDisabled: true,
                                        text: 'ТНБ',
                                        format: '0.000000'
                                    },
                                    {
                                        xtype: 'numbercolumn',
                                        width: 107,
                                        dataIndex: 'gkal_hour',
                                        menuDisabled: true,
                                        text: 'ТНБ(м&sup2;)',
                                        format: '0.0000000000000'
                                    }
                                ],
                                features: [
                                    {
                                        ftype: 'groupingsummary',
                                        enableGroupingMenu: false
                                    }
                                ],
                                listeners: {
                                    select: {
                                        fn: 'onGrEnauditInSelect',
                                        scope: 'controller'
                                    },
                                    rowclick: {
                                        fn: 'onGrEnauditInRowClick',
                                        scope: 'controller'
                                    }
                                }
                            },
                            {
                                xtype: 'gridpanel',
                                x: 270,
                                y: 510,
                                height: 205,
                                id: 'grEnauditOrg',
                                width: 840,
                                title: 'список об\'єктів',
                                store: 'StOrgByDteplomer',
                                columns: [
                                    {
                                        xtype: 'numbercolumn',
                                        hidden: true,
                                        width: 46,
                                        align: 'center',
                                        dataIndex: 'enaudit_id',
                                        menuDisabled: true,
                                        text: 'en_id',
                                        format: '0'
                                    },
                                    {
                                        xtype: 'gridcolumn',
                                        renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                            switch (value) {
                                                case "1":
                                                metaData='<span><img clas="icon" src="resources/css/images/ico/yes.png"/></span>';
                                                break;
                                                case "0":
                                                metaData='<span><img clas="icon" src="resources/css/images/ico/no.png"/></span>';
                                                break;
                                            }
                                            return metaData;

                                        },
                                        width: 36,
                                        dataIndex: 'vkl_otopl',
                                        menuDisabled: true,
                                        text: 'вкл'
                                    },
                                    {
                                        xtype: 'gridcolumn',
                                        renderer: function(value, metaData, record, rowIndex, colIndex, store, view) {
                                            return Ext.String.format('<div  <b>{0}</b><br><span >{1} </span></div>',
                                            value,
                                            record.get('name') || "");
                                        },
                                        width: 421,
                                        dataIndex: 'fname',
                                        text: 'Найменування об\'єкта'
                                    },
                                    {
                                        xtype: 'numbercolumn',
                                        summaryType: 'sum',
                                        width: 76,
                                        align: 'center',
                                        dataIndex: 'area',
                                        menuDisabled: true,
                                        text: 'S_(м&sup2;)',
                                        format: '0.00'
                                    },
                                    {
                                        xtype: 'numbercolumn',
                                        summaryType: 'sum',
                                        width: 69,
                                        align: 'center',
                                        dataIndex: 'area',
                                        menuDisabled: true,
                                        text: 'S_(контр)',
                                        format: '0.00'
                                    },
                                    {
                                        xtype: 'numbercolumn',
                                        width: 100,
                                        align: 'center',
                                        dataIndex: 'gkal_h_ot',
                                        menuDisabled: true,
                                        text: 'ТНБ 1 м&sup2;  год',
                                        format: '0.000000'
                                    },
                                    {
                                        xtype: 'numbercolumn',
                                        width: 91,
                                        align: 'center',
                                        dataIndex: 'gkal_y_ot',
                                        menuDisabled: true,
                                        text: 'ТНБ 1 м&sup2;  рік',
                                        format: '0.000'
                                    }
                                ],
                                features: [
                                    {
                                        ftype: 'summary',
                                        dock: 'top'
                                    }
                                ]
                            }
                        ]
                    }
                ]
            };
        if (instanceConfig) {
            me.getConfigurator().merge(me, config, instanceConfig);
        }
        return me.callParent([config]);
    },

    onCbRaionEnaudit: function(combo, record, eOpts) {
        var stUser = Ext.data.StoreManager.get("StUser");
        var values =stUser.getAt(0);
        var login = values.get('login');
        var password = values.get('password');
        var btnAddHousesEnaudit = Ext.getCmp('btnAddHousesEnaudit');
        var btnDelHousesEnaudit = Ext.getCmp('btnDelHousesEnaudit');
        var tnb = Ext.getCmp('tnb');
        var store =combo.getStore();
        var selected = record;
        var StHouseEnIn = Ext.data.StoreManager.get("StHouseEnIn");
        var StHouseEnOut = Ext.data.StoreManager.get("StHouseEnOut");
        var StOrgByDteplomer = Ext.data.StoreManager.get("StOrgByDteplomer");
        var StAddressDt = Ext.data.StoreManager.get("StAddressDt");
        switch (values.get('role')){
            case "2":
            case "7":
                if (selected ) {
                    btnAddHousesEnaudit.setDisabled(false);
                    btnDelHousesEnaudit.setDisabled(false);
                    tnb.setValue(0);
                    StHouseEnIn.removeAll();
                    StHouseEnOut.removeAll();
                    StOrgByDteplomer.removeAll();
                    StAddressDt.removeAll();
                    StHouseEnIn.load({
                        params: {
                            what:'enaudit_in',
                            login:login,
                            raion_id:selected.get("raion_id"),
                            password:password
                        },
                        scope:this
                    });
                    StHouseEnOut.load({
                        params: {
                            what:'enaudit_out',
                            login:login,
                            raion_id:selected.get("raion_id"),
                            password:password
                        },
                        scope:this
                    });
                }
                break;
            default:
                Ext.MessageBox.show({
                    title: 'Ошибка ',
                    msg: 'У Вас нет прав загружать базу енергоаудита',
                    buttons: Ext.MessageBox.OK,
                    icon: Ext.MessageBox.ERROR
                });
        }
    }

});