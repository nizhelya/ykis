/*
 * File: app/controller/CrLeftMenu.js
 * Date: Wed Dec 09 2020 12:18:58 GMT+0200 (EET)
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Ykis.controller.CrLeftMenu', {
    extend: 'Ext.app.Controller',
    alias: 'controller.crLeftMenu',

    views: [
        'VpKommuna',
        'menu.TabPnCenter',
        'org.WinAddOrg',
        'sprav.TabDvodomer',
        'org.WinAddFilial'
    ],

    refs: {
        CbRaion: '#cbRaion',
        ListHouses: '#listHouses',
        ListHousesData: 'listHouses dataview',
        CbStreet: '#cbStreet',
        GrTreeOrg: '#grTreeOrg',
        ShowAddress: '#showAddress',
        VpKommuna: '#vpKommuna',
        GrOrgSearchField: '#grOrgSearchField',
        RadioTreeOrg: '#radioTreeOrg',
        GrOrgFil: '#grOrgFil',
        WinAddOrg: {
            autoCreate: true,
            selector: 'winAddOrg',
            xtype: 'winaddorg'
        },
        CbTreeOrg: '#cbTreeOrg',
        ShowOrgFilial: '#showOrgFilial',
        WinAddFilial: '#winAddFilial',
        ShowOrg: '#showOrg',
        FmOrgInfo: '#fmOrgInfo',
        TabPnCenter: '#tabPnCenter',
        GrOgrDog: '#grOgrDog',
        TbDogOrgInsert: '#tbDogOrgInsert'
    },

    control: {
        "#tabMenuLifeFond": {
            activate: 'onTabMenuLifeFondActivate'
        },
        "#tabMenuOrg": {
            activate: 'onTabMenuOrgActivate'
        },
        "#tabMenuSprav": {
            activate: 'onPanelActivate'
        },
        "#tabFilial": {
            activate: 'onTabFilialActivate'
        },
        "#listHousesView": {
            itemclick: 'onListHousesViewItemClick'
        },
        "#btnAddOrg": {
            click: 'onBtnAddOrgClick'
        },
        "#rbTypeClick": {
            change: 'onRbTypeClickChange'
        },
        "#grTreeOrg": {
            itemclick: 'onGrTreeOrgItemClick'
        },
        "#winBtnAddOrg": {
            click: 'onWinBtnAddOrgClick'
        },
        "#btOrgFilialAdd": {
            click: 'onBtOrgFilialAddClick'
        },
        "#cbRaion1": {
            select: 'onCbRaionSelect1'
        },
        "#cbStreet1": {
            select: 'onCbStreetSelect1'
        }
    },

    onTabMenuLifeFondActivate: function(component, eOpts) {
        //in use
        var me=this;
        //TAB
        var tabPnCenter = me.getTabPnCenter();
        //LOGIKA
        //ДОМА
        tabPnCenter.child('#tabDteplomer').tab.hide();
        tabPnCenter.child('#tabDvodomer').tab.hide();
        //КВАРТИРЫ
        tabPnCenter.child('#tabAppBti').tab.hide();
        tabPnCenter.child('#tabKassa').tab.hide();
        tabPnCenter.child('#tabNachApp').tab.hide();
        tabPnCenter.child('#tabNachAppVoda').tab.hide();
        tabPnCenter.child('#tabNachAppTeplo').tab.hide();


        tabPnCenter.child('#tabOplata').tab.hide();

        tabPnCenter.child('#tabAppVodomer').tab.hide();
        tabPnCenter.child('#tabAppTeplomer').tab.hide();
        //ОБЬЕКТЫ
        tabPnCenter.child('#tabOrgVodomer').tab.hide();
        tabPnCenter.child('#tabOrgTeplomer').tab.hide();
        tabPnCenter.child('#tabFilial').tab.hide();
        tabPnCenter.child('#tabNachFilial').tab.hide();

        //ОРГАНИЗАЦИИ
        //tabPnCenter.child('#tabDog').tab.hide();
        tabPnCenter.child('#tabOrg').tab.hide();
        //СПРАВОЧНИК
        //tabPnCenter.child('#tabSprav').tab.hide();
        //tabPnCenter.child('#tabReportOrg').tab.hide();
        tabPnCenter.child('#tabLogin').tab.hide();
        tabPnCenter.setActiveTab('tabLogin');
    },

    onTabMenuOrgActivate: function(component, eOpts) {
        //in use
        var me=this;


        var stUser = Ext.data.StoreManager.get("StUser");
        var values =stUser.getAt(0);
        values.set({'vibor':"org"});
        //TAB
        var tabPnCenter = me.getTabPnCenter();
        //LOGIKA
        //ДОМА

        tabPnCenter.child('#tabDteplomer').tab.hide();
        tabPnCenter.child('#tabDvodomer').tab.hide();
        //tabPnCenter.child('#tabWaterHouse').tab.hide();


        //КВАРТИРЫ
        tabPnCenter.child('#tabAppBti').tab.hide();
        tabPnCenter.child('#tabKassa').tab.hide();
        tabPnCenter.child('#tabNachApp').tab.hide();
        tabPnCenter.child('#tabOplata').tab.hide();
        tabPnCenter.child('#tabAppVodomer').tab.hide();
        tabPnCenter.child('#tabAppTeplomer').tab.hide();
        tabPnCenter.child('#tabNachAppVoda').tab.hide();
        tabPnCenter.child('#tabNachAppTeplo').tab.hide();


        //ОБЬЕКТЫ
        tabPnCenter.child('#tabOrgVodomer').tab.hide();
        tabPnCenter.child('#tabOrgTeplomer').tab.hide();
        tabPnCenter.child('#tabFilial').tab.hide();
        tabPnCenter.child('#tabNachFilial').tab.hide();

        //ОРГАНИЗАЦИИ
        //tabPnCenter.child('#tabDog').tab.hide();
        tabPnCenter.child('#tabOrg').tab.hide();
        //СПРАВОЧНИК
        //tabPnCenter.child('#tabSprav').tab.hide();
        //tabPnCenter.child('#tabReportOrg').tab.hide();
        tabPnCenter.child('#tabLogin').tab.hide();
        tabPnCenter.setActiveTab('tabLogin');

    },

    onPanelActivate: function(component, eOpts) {
        //in use
        var me=this;
        //TAB
        var tabPnCenter = me.getTabPnCenter();
        //LOGIKA
        //ДОМА
        //tabPnCenter.child('#tabDteplomer').tab.hide();
        //tabPnCenter.child('#tabDvodomer').tab.hide();
        //tabPnCenter.child('#tabWaterHouse').tab.hide();


        //КВАРТИРЫ
        //tabPnCenter.child('#tabAppBti').tab.hide();
        //tabPnCenter.child('#tabKassa').tab.hide();
        //tabPnCenter.child('#tabNachApp').tab.hide();
        //tabPnCenter.child('#tabAppVodomer').tab.hide();
        //tabPnCenter.child('#tabAppTeplomer').tab.hide();
        //ОБЬЕКТЫ
        //tabPnCenter.child('#tabOrgVodomer').tab.hide();
        //tabPnCenter.child('#tabOrgTeplomer').tab.hide();
        //tabPnCenter.child('#tabFilial').tab.hide();
        //tabPnCenter.child('#tabNachFilial').tab.hide();

        //ОРГАНИЗАЦИИ
        //tabPnCenter.child('#tabDog').tab.hide();
        //tabPnCenter.child('#tabOrg').tab.hide();
        //СПРАВОЧНИК
        //tabPnCenter.child('#tabSprav').tab.hide();
        //tabPnCenter.child('#tabReportOrg').tab.hide();
        tabPnCenter.child('#tabLogin').tab.hide();
        tabPnCenter.setActiveTab('tabLogin');
    },

    onTabFilialActivate: function(component, eOpts) {
        var me = this;
        var stUser = Ext.data.StoreManager.get("StUser");
        var StFilial = Ext.data.StoreManager.get("StFilial");
        var stTekNachFilial = Ext.data.StoreManager.get("StTekNachFilial");
        var tabPnCenter = me.getTabPnCenter();
        var fmFilial = Ext.getCmp('fmFilial');
        var fmInfoNachOrg = Ext.getCmp('fmInfoNachFilial');

        //LOGIN & PASSWORD & CONFIG

        var values =stUser.getAt(0);
        var login = values.get('login');
        var password = values.get('password');
        var org_id = values.get('org_id');
        var filial_id = values.get('filial_id');
        var org = values.get('org');
        var filial = values.get('filial');


        tabPnCenter.child('#tabOrgVodomer').tab.show();
        tabPnCenter.child('#tabOrgTeplomer').tab.show();
        tabPnCenter.child('#tabFilial').tab.show();
        tabPnCenter.child('#tabNachFilial').tab.show();


        StFilial.load({
            params: {
                what:'FmFilial',
                filial_id: filial_id,
                login:login,
                password:password
            },
            callback: function(records,operation,success){
                if(success){
                    stTekNachFilial.removeAll();
                    if (records.length){
                        //  console.log('1');
                        // STORE
                        var StStreet = Ext.data.StoreManager.get("StStreetOrg");
                        var stHouses = Ext.data.StoreManager.get("StHousesOrg");
                        var stAddressOrg = Ext.data.StoreManager.get("StAddressOrg");
                        var StDTeplomerCb = Ext.data.StoreManager.get("StDTeplomerCb");
                        var StDVodomerCb = Ext.data.StoreManager.get("StDVodomerCb");
                        var showOrgFilial = Ext.getCmp('showOrgFilial');
                        values.set({'org_id':records[0].get('org_id'),'filial':records[0].get('name'),'vibor':"org"});
                        stUser.sync();
                        tabPnCenter.setActiveTab('tabFilial');
                        showOrgFilial.setHtml(filial);
                        //console.log(records[0]);
                        fmFilial.getForm().reset();
                        if (values.get('role') ==="7" ){
                            fmFilial.getForm().findField('new_id').show();
                        } else {
                            fmFilial.getForm().findField('new_id').hide();
                        }

                        StStreet.load({
                            params: {
                                what:'StreetsFromRaion',
                                what_id:records[0].get('raion_id')
                            },
                            scope: this
                        });
                        stHouses.load({
                            params: {
                                what:'HousesFromStreet',
                                what_id: records[0].get('street_id')
                            },
                            scope: this
                        });
                        stAddressOrg.load({
                            params: {
                                what:'AddressFromHouses',
                                what_id: records[0].get('house_id')
                            },
                            scope:this
                        });
                        //загрузка в combobox номера дтепломеров по дому
                        StDTeplomerCb.load({
                            params: {
                                what_id: records[0].get('house_id'),
                                what:'DteplomerHouse'
                            },
                            scope:this
                        });
                        StDVodomerCb.load({
                            params: {
                                what_id: records[0].get('house_id'),
                                what:'DvodomerHouse'
                            },
                            scope:this
                        });
                        fmFilial.getForm().loadRecord(records[0]);
                        var dogYtke = fmFilial.getForm().findField('dog_ytke').getValue();
                        if(dogYtke!=="") {
                            fmFilial.down('#btnOpenWinDogovorOrgYtke').setText('Договір № '+dogYtke);
                        } else {
                            fmFilial.down('#btnOpenWinDogovorOrgYtke').setText('Договіра немає');
                        }

                    }  else {
                        fmFilial.getForm().loadRecord(0);

                    }


                } else {
                    fmFilial.getForm().reset();

                }
            },
            scope:this
        });

    },

    onListHousesViewItemClick: function(dataview, record, item, index, e, eOpts) {
        //in use
        var me = this;
        var showAddress = Ext.getCmp('showAddress');
        var showHouse = Ext.getCmp('showHouse');
        var rbTypeClick = Ext.getCmp('rbTypeClick');

        // STORE

        var stUser = Ext.data.StoreManager.get("StUser");

        //LOGIN & PASSWORD

        var values =stUser.getAt(0);
        var login = values.get('login');
        var password = values.get('password');

        //LOGIKA

        var selected = record.data;
           //console.log(selected);

        if (selected){
            values.set({'house_id':selected.house_id,
                        'house':selected.house,
                        'address_id':selected.address_id,
                        'address':selected.address,
                        'raion_id':selected.raion_id,
                        'raion':selected.raion,
                        'appartment':selected.appartment,
                        'street_id':selected.street_id,
                        'vibor':"app"
                       });
            //console.log(values);

            if(rbTypeClick.getValue().typeClick==='address'){
                if(selected.address_id===0){


                    Ext.MessageBox.prompt(selected.house,
                                          ' Введите номер квартиры:',
                                          function(btn,text){
                                              if (btn === 'ok') {
                                                  var sendValue = {'what': 'CheckFlat',
                                                                   'house_id': selected.house_id,
                                                                   'appartment':text,
                                                                   login:login ,
                                                                   password:password};
                                                  QueryAddress.getResults(sendValue,function(results){
                                                      if (results.success){
                                                          if (results.data[0]) {
                                                              values.set({'raion_id':results.data[0].raion_id,
                                                                          'raion':results.data[0].raion,
                                                                          'street_id':results.data[0].street_id,
                                                                          'house_id':results.data[0].house_id,
                                                                          'house':results.data[0].house,
                                                                          'address_id':results.data[0].address_id,
                                                                          'address':results.data[0].address,
                                                                          'appartment':results.data[0].appartment,
                                                                          'vibor':"app"
                                                                         });
                                                              showAddress.setText(results.data[0].address).show();
                                                              me.LoadFlatData(true);
                                                          } else {
                                                              Ext.MessageBox.show({title: 'Выбор номера квартиры',
                                                                                   msg: 'Квартира не найдена',
                                                                                   buttons: Ext.MessageBox.OK,
                                                                                   icon: Ext.MessageBox.ERROR
                                                                                  });
                                                          }
                                                      }
                                                  }
                                                                         );
                                              }
                                          });
                }else{
                    showAddress.setText(selected.address).show();

                    me.LoadFlatData(true);
                }
            } else{
                showHouse.setText(selected.house).show();


                me.LoadFlatData(false);
            }
        }

    },

    onBtnAddOrgClick: function(button, e, eOpts) {
        //in use
        var me=this;

        //WIN

        var WinAddOrg = me.getWinAddOrg();

        // LOGIKA


        WinAddOrg.show();
    },

    onRbTypeClickChange: function(field, newValue, oldValue, eOpts) {
        //in use
        var me=this;
        //TAB

        var tabPnCenter = me.getTabPnCenter();
        //ДОМА
        tabPnCenter.child('#tabDteplomer').tab.hide();
        tabPnCenter.child('#tabDvodomer').tab.hide();


        //КВАРТИРЫ
        tabPnCenter.child('#tabAppBti').tab.hide();
        tabPnCenter.child('#tabKassa').tab.hide();
        tabPnCenter.child('#tabNachApp').tab.hide();
        tabPnCenter.child('#tabNachAppVoda').tab.hide();
        tabPnCenter.child('#tabNachAppTeplo').tab.hide();


        tabPnCenter.child('#tabOplata').tab.hide();

        tabPnCenter.child('#tabAppVodomer').tab.hide();
        tabPnCenter.child('#tabAppTeplomer').tab.hide();

        //ОБЬЕКТЫ
        tabPnCenter.child('#tabOrgVodomer').tab.hide();
        tabPnCenter.child('#tabOrgTeplomer').tab.hide();
        tabPnCenter.child('#tabFilial').tab.hide();
        tabPnCenter.child('#tabNachFilial').tab.hide();

        //ОРГАНИЗАЦИИ
        //tabPnCenter.child('#tabDog').tab.hide();
        tabPnCenter.child('#tabOrg').tab.hide();
        //СПРАВОЧНИК
        //tabPnCenter.child('#tabSprav').tab.hide();
        //tabPnCenter.child('#tabReportOrg').tab.hide();
        tabPnCenter.child('#tabLogin').tab.hide();
        tabPnCenter.setActiveTab('tabLogin');
    },

    onGrTreeOrgItemClick: function(dataview, record, item, index, e, eOpts) {
        //console.log(selected);
        //in use
        var me = this;

        // STORE

        var stUser = Ext.data.StoreManager.get("StUser");

        //TAB

        //var tabPnCenter = me.getTabPnCenter();
        //var tabFilial = tabPnCenter.child('#tabFilial');
        var tree = Ext.getCmp('grTreeOrg');


        //LOGIN & PASSWORD

        var values =stUser.getAt(0);
        var login = values.get('login');
        var password = values.get('password');
        var parentId = values.get('parentId');

        //LOGIKA
        var select = record.data;
        //var treeCateg = tree.getRootNode().findChild("orig_id",selected.orig_id, true);
        //console.log(select);
        switch (select.what) {
            case 'category':  // ВЫБРАНА ОРГАНИЗАЦИЯ
            values.set({'parentId':select.id,'org_id':select.orig_id,'org':select.text,'vibor':"org"});
            stUser.sync();
            me.loadOrg();
            break;
            case 'subcategory':
                values.set({'filial_id':select.orig_id,'filial':select.text,'golovnoe':select.golovnoe,'ind':select.ind,'vibor':"org"});
                stUser.sync();
                me.onTabFilialActivate();
           // me.LoadFilial();
            break;
            case 'addfil':
            me.AddFilial(select.orig_id);
            break;
        }
    },

    onWinBtnAddOrgClick: function(button, e, eOpts) {
        // in use
        var me = this;

        //CONTROLER

        var crLeftMenu = this.application.getController('CrLeftMenu');
        var org_id = 0;
        //STORE

        var stUser = Ext.data.StoreManager.get("StUser");
        var stOrg = Ext.data.StoreManager.get("StOrg");//QueryOrgVodomer.getResults  <AllPokVodomera>
        var stFilial = Ext.data.StoreManager.get("StFilial");//QueryOrgVodomer.getResults  <AllPokVodomera>
        var StTreeOrg = Ext.data.StoreManager.get("StTreeOrg");//url 'php/classes/QueryTreeOrg.php'
        //TAB

        var tabPnCenter = me.getTabPnCenter();
        var tabOrg= tabPnCenter.child('#tabOrg');

        //LOGIN & PASSWORD & ID

        var values =stUser.getAt(0);
        var params = {
            login:values.get('login'),
            password:values.get('password'),
            what:'addOrg'
        };

        //WIN

        var winAddOrg = crLeftMenu.getWinAddOrg();

        //GRID

        var tree = Ext.getCmp('grTreeOrg');
        var dataview = tree.getView();
        //FORMA

        var fmAddOrg = Ext.getCmp('fmAddOrg');
        var fmOrg = Ext.getCmp('fmOrg');
        var value = fmAddOrg.getValues();
        var showOrg = crLeftMenu.getShowOrg();
        //LOGIKA

        Ext.Object.merge(value, params);
        QueryOrg.Org(value,function(results){
            if (results.success==="1"){
                Ext.MessageBox.show({
                    title: 'Добавление новой организации !',
                    msg: results.msg,
                    buttons: Ext.MessageBox.OK,
                    buttonText:{
                        ok: "Закрыть!"
                    },
                    icon: Ext.MessageBox.INFO
                });
                stFilial.removeAll();
                stOrg.removeAll();
                org_id  = results.org_id;
                values.set({'org_id':org_id});
                //console.log(results.org_id);
                /*
                StTreeOrg.load({
                    params: {
                        cat:0,
                        org:0,
                        login:value.login,
                        password:value.password
                    },
                    callback: function(record,eOpts,success) {
                        if(success){
                            // console.log(record);

                            tree.expandAll();
                            var rec = tree.getRootNode().findChild("orig_id",org_id, true);
                            dataview.getSelectionModel().select(rec);
                            me.onGrTreeOrgItemClick(dataview,rec);


                        }
                    },
                    scope: this
                });
        */
                winAddOrg.close();
            }    else {
                Ext.MessageBox.show({
                    title: 'Добавление новой организации !',
                    msg: results.msg,
                    buttons: Ext.MessageBox.OK,
                    buttonText:{
                        ok: "Закрыть!"
                    },
                    icon: Ext.MessageBox.ERROR
                });
            }
        });
    },

    onBtOrgFilialAddClick: function(button, e, eOpts) {
         // in use
                var me = this;

                //CONTROLER

                var crLeftMenu = this.application.getController('CrLeftMenu');

                //STORE

                var stUser = Ext.data.StoreManager.get("StUser");
                var stFilial = Ext.data.StoreManager.get("StFilial");//QueryVodomer.getResults  <AllPokVodomera>
                var StTreeOrg = Ext.data.StoreManager.get("StTreeOrg");//QueryVodomer.getResults <TekPokVodomera>
                //TAB

                var tabPnCenter = me.getTabPnCenter();
                var tabFilial = tabPnCenter.child('#tabFilial');

                //LOGIN & PASSWORD & ID

                var values =stUser.getAt(0);
                var params = {
                    login:values.get('login'),
                    password:values.get('password'),
                    org_id:values.get('org_id'),
                    org:values.get('org'),
                    what:'addFilial'
                };

                //WIN

                var winAddFilial = crLeftMenu.getWinAddFilial();

                //GRID

                var tree = Ext.getCmp('grTreeOrg');
                var dataview = tree.getView();

                //var select=tree.getSelectionModel().clearSelections();

                //FORMA

                var fmAddFilial = Ext.getCmp('fmAddFilial');
                var fmFilial = Ext.getCmp('fmFilial');
                var value = fmAddFilial.getValues();
                //LOGIKA

                Ext.Object.merge(value, params);
                //console.log(value);

                QueryOrg.Filial(value,function(results){
                    if (results.success==="1"){
                        stFilial.removeAll();
                        StTreeOrg.load({
                            params: {
                                org_id:values.get('org_id'),
                                login:value.login,
                                password:value.password
                            },
                            callback: function(record,eOpts,success) {
                                if(success){
                                    tree.expandAll();
                                                       // console.log(record);

                                  // var TreeNodeId = record[0].get('filial_id');

                                    var TreeNodeId = results.filial_id;
                                  //  console.log(record);
                                    var rec = tree.getRootNode().findChild("orig_id",TreeNodeId, true);
                                    dataview.getSelectionModel().select(rec);
                                    me.onGrTreeOrgItemClick(dataview,rec);
                                }
                            },
                            scope: this
                        });
                        values.set({'filial_id':results.filial_id});
                        stFilial.load({
                            params: {
                                what:'FmFilial',
                                filial_id: results.filial_id,
                                login:value.login,
                                password:value.password
                            },
                            scope:this
                        });
                        // crLeftMenu.onGrOrgSearchFieldChange();
                        winAddFilial.close();



                    }
                });
    },

    onCbRaionSelect1: function(combo, record, eOpts) {
        //in use
        var me=this;
        /*
        COMPONENT
        */
        var cbStreet = me.getCbStreet();
        var viewHouses = me.getListHousesData();
        /*
        STORE
        */
        var stUser = Ext.data.StoreManager.get("StUser");
        var stHouses = Ext.data.StoreManager.get("StHouses");
        /*
        LOGIN & PASSWORD
        */
        var values =stUser.getAt(0);
        var login = values.get('login');
        var password = values.get('password');
        /*
        LOGIKA
        */

        cbStreet.clearValue();
        if (record) {
            stHouses.load({
                params: {
                    what:'HousesFromRaion',
                    what_id: record.get('raion_id'),
                    login:login,
                    password:password
                },
                scope: this
            });
        }

    },

    onCbStreetSelect1: function(combo, record, eOpts) {
        //in use
        var me=this;
        /*
        COMPONENT
        */
        var cbRaion = me.getCbRaion();
        var viewHouses = me.getListHousesData();
        /*
        STORE
        */
        var stUser = Ext.data.StoreManager.get("StUser");
        var stHouses = Ext.data.StoreManager.get("StHouses");
        /*
        LOGIN & PASSWORD
        */
        var values =stUser.getAt(0);
        var login = values.get('login');
        var password = values.get('password');
        /*
        LOGIKA
        */
        //cbRaion.clearValue();
        if (record) {
            stHouses.load({
                params: {
                    what:'HousesFromStreet',
                    what_id: record.get('street_id'),
                    privat: record.get('privat'),
                    login:login,
                    password:password
                },
                scope: this
            });
        }
    },

    LoadTabDvodomer: function() {
        //in use
        var me = this;
        //STORE

        var stUser = Ext.data.StoreManager.get("StUser");
        var StTarif = Ext.data.StoreManager.get("StTarif");

        //LOGIN & PASSWORD

        var values =stUser.getAt(0);
        var login = values.get('login');
        var password = values.get('password');
        var address_id = values.get('address_id');
        var address = values.get('address');
        var house_id = values.get('house_id');
        var prixod_id = values.get('prixod_id');

        //LOGIKA
        values.set({'dvodomer_id':0});
        stUser.sync();

        var fmDvodomers = Ext.getCmp('fmDVodomers');
        var StDVodomer = Ext.data.StoreManager.get("StDVodomer");
        var StVodomerAvg = Ext.data.StoreManager.get("StVodomerAvg");

        var StHDVodomer = Ext.data.StoreManager.get("StHDVodomer");
        var StAllPokDVodomera = Ext.data.StoreManager.get("StAllPokDVodomera");
        var StOrgByDvodomer = Ext.data.StoreManager.get("StOrgByDvodomer");
        var StAOVodomer = Ext.data.StoreManager.get("StAOVodomer");
        var stHouses = Ext.data.StoreManager.get("StHousesTeplo");
        var grHDVodomer = Ext.getCmp('grHDVodomer');
        var grAOVodomer = Ext.getCmp('grAOVodomer');
        var grAvgVodomer = Ext.getCmp('grAvgVodomer');
        var grAktPVoda = Ext.getCmp('grAktPVoda');

        var grAllPokDvodomera = Ext.getCmp('grAllPokDvodomera');
        var grOrgByDVodomer = Ext.getCmp('grOrgByDVodomer');
        var grDvodomer = Ext.getCmp('grDvodomer');
        grHDVodomer.setDisabled(true);
        grAOVodomer.setDisabled(true);
        grAvgVodomer.setDisabled(true);

        grAllPokDvodomera.setDisabled(true);
        grOrgByDVodomer.setDisabled(true);
        grAktPVoda.setDisabled(true);

        StDVodomer.removeAll();
        StHDVodomer.removeAll();
        StOrgByDvodomer.removeAll();
        StAllPokDVodomera.removeAll();
        StAOVodomer.removeAll();
        StVodomerAvg.removeAll();


        fmDvodomers.setTitle('Технічна характеристика будинку');
        fmDvodomers.getForm().reset();
        fmDvodomers.expand(true);
        //grAllPokVodomera.getView().refresh();

        stHouses.load({
            params: {
                house_id:house_id,
                what:'HouseUpdateTeplo',
                login:login,
                password:password,
            },
            callback: function(rec,operation,success){
                if((success) && (rec.length)){
                    fmDvodomers.getForm().loadRecord(rec[0]);

                }
            },
            scope:this
        });
        StTarif.load({
            params: {
                what:'TarifVoda',
                login:login,
                password:password,
                house_id:house_id,
            },
            scope:this
        });

        StDVodomer.load({
            params: {
                house_id:house_id,
                what:'Dvodomer',
                login:login,
                password:password
            },
            scope:this
        });
        StHDVodomer.load({
            params: {
                house_id:house_id,
                what:'HDvodomer',
                login:login,
                password:password
            },
            scope:this
        });
    },

    LoadTabDteplomer: function() {
        //in use
        var me = this;
        //STORE

        var stUser = Ext.data.StoreManager.get("StUser");

        //LOGIN & PASSWORD

        var values =stUser.getAt(0);
        var login = values.get('login');
        var password = values.get('password');
        var address_id = values.get('address_id');
        var address = values.get('address');
        var house_id = values.get('house_id');
        var prixod_id = values.get('prixod_id');

        //LOGIKA
        values.set({'dteplomer_id':0});
        stUser.sync();
        //dteplomers
        var StDTeplomer = Ext.data.StoreManager.get("StDTeplomer");
        var stHouses = Ext.data.StoreManager.get("StHousesTeplo");
        var fmDTeplomers = Ext.getCmp('fmDTeplomers');

        // var StHeatHouse = Ext.data.StoreManager.get("StHeatHouse");
        var StHDTeplomer = Ext.data.StoreManager.get("StHDTeplomer");
        var StMop = Ext.data.StoreManager.get("StMop");//QueryTeplomer.getResults
        var StOrgByDteplomer = Ext.data.StoreManager.get("StOrgByDteplomer");//QueryTeplomer.getResults
        var StAllPokDteplomera = Ext.data.StoreManager.get("StAllPokDTeplomera");
        var grHeatHouse = Ext.getCmp('grHeatHouse');
        var grHDteplomer = Ext.getCmp('grHDteplomer');
        var grOrgByDteplomer = Ext.getCmp('grOrgByDteplomer');
        var grMop = Ext.getCmp('grMop');
        var grAktP = Ext.getCmp('grAktP');

        StOrgByDteplomer.removeAll();
        StAllPokDteplomera.removeAll();
        StDTeplomer.removeAll();
        StMop.removeAll();


        grHeatHouse.setDisabled(true);
        grHDteplomer.setDisabled(true);
        grOrgByDteplomer.setDisabled(true);
        grMop.setDisabled(true);
        grAktP.setDisabled(true);

        fmDTeplomers.setTitle('Технічна характеристика будинку');
        fmDTeplomers.getForm().reset();
        fmDTeplomers.expand(true);


        stHouses.load({
            params: {
                house_id:house_id,
                what:'HouseUpdateTeplo',
                login:login,
                password:password,
            },
            callback: function(rec,operation,success){
                if((success) && (rec.length)){
                    fmDTeplomers.getForm().loadRecord(rec[0]);

                }
            },
            scope:this
        });
        StDTeplomer.load({
            params: {
                house_id:house_id,
                what:'Dteplomer',
                login:login,
                password:password
            },
            scope:this
        });
        StHDTeplomer.load({
            params: {
                house_id:house_id,
                what:'HDteplomers',
                login:login,
                password:password
            },
            scope:this
        });

    },

    LoadFlatData: function(adr) {
        //in use
        var me = this;
        var crKassa = this.application.getController('CrKassa');

        //TAB_PANEL
        // Активный таб
        //console.log(activeTab);
        var tabPnCenter = me.getTabPnCenter();
        var activeTab = tabPnCenter.getActiveTab();
        var nameactiveTab = activeTab.getXType();
        var index = tabPnCenter.items.indexOf(activeTab);

        //STORE

        var stUser = Ext.data.StoreManager.get("StUser");

        //LOGIN & PASSWORD

        var values =stUser.getAt(0);
        var login = values.get('login');
        var password = values.get('password');
        var address_id = values.get('address_id');
        var address = values.get('address');
        var house_id = values.get('house_id');
        var prixod_id = values.get('prixod_id');

        //LOGIKA
        values.set({'dteplomer_id':0});
        stUser.sync();
        if(adr){
            tabPnCenter.child('#tabAppBti').tab.show();
            tabPnCenter.child('#tabKassa').tab.show();
            tabPnCenter.child('#tabOplata').tab.show();
            tabPnCenter.child('#tabOrgVodomer').tab.hide();
            tabPnCenter.child('#tabOrgTeplomer').tab.hide();
            tabPnCenter.child('#tabFilial').tab.hide();
            tabPnCenter.child('#tabNachFilial').tab.hide();
            tabPnCenter.child('#tabDteplomer').tab.hide();
            tabPnCenter.child('#tabDvodomer').tab.hide();
            tabPnCenter.child('#tabOrg').tab.hide();
            tabPnCenter.child('#tabLogin').tab.hide();
            switch (values.get('role')){
                case "3":
                    tabPnCenter.child('#tabAppVodomer').tab.show();
                    tabPnCenter.child('#tabNachAppVoda').tab.show();
                    tabPnCenter.child('#tabAppTeplomer').tab.hide();
                    tabPnCenter.child('#tabNachAppTeplo').tab.hide();
                    tabPnCenter.child('#tabNachApp').tab.hide();
                    break;
                case "2":
                    tabPnCenter.child('#tabAppVodomer').tab.hide();
                    tabPnCenter.child('#tabAppTeplomer').tab.show();
                    tabPnCenter.child('#tabNachAppVoda').tab.hide();
                    tabPnCenter.child('#tabNachAppTeplo').tab.show();
                    tabPnCenter.child('#tabNachApp').tab.hide();

                    break;
                case "7":
                    tabPnCenter.child('#tabAppVodomer').tab.show();
                    tabPnCenter.child('#tabAppTeplomer').tab.show();
                    tabPnCenter.child('#tabNachAppVoda').tab.show();
                    tabPnCenter.child('#tabNachAppTeplo').tab.show();
                    tabPnCenter.child('#tabNachApp').tab.show();
                    break;
                case "5":
                    tabPnCenter.child('#tabAppVodomer').tab.hide();
                    tabPnCenter.child('#tabAppTeplomer').tab.hide();
                    tabPnCenter.child('#tabNachAppVoda').tab.hide();
                    tabPnCenter.child('#tabNachAppTeplo').tab.hide();
                    tabPnCenter.child('#tabNachApp').tab.show();

                    break;
            }

            if (nameactiveTab==='tabkassa'){
                crKassa.onTabKassaActivate();
            } else {
                tabPnCenter.setActiveTab('tabKassa');
            }




        }else{   //ВЫБИРАЕМ ДОМ
            tabPnCenter.child('#tabAppBti').tab.hide();
            tabPnCenter.child('#tabKassa').tab.hide();
            tabPnCenter.child('#tabNachApp').tab.hide();
            tabPnCenter.child('#tabNachAppVoda').tab.hide();
            tabPnCenter.child('#tabOplata').tab.hide();
            tabPnCenter.child('#tabAppVodomer').tab.hide();
            tabPnCenter.child('#tabAppTeplomer').tab.hide();
            tabPnCenter.child('#tabNachAppVoda').tab.hide();
            tabPnCenter.child('#tabOrgVodomer').tab.hide();
            tabPnCenter.child('#tabOrgTeplomer').tab.hide();
            tabPnCenter.child('#tabFilial').tab.hide();
            tabPnCenter.child('#tabNachFilial').tab.hide();
            tabPnCenter.child('#tabNachAppTeplo').tab.hide();

            tabPnCenter.child('#tabOrg').tab.hide();
            tabPnCenter.child('#tabLogin').tab.hide();

            switch (values.get('role')){
                case "3":
                    tabPnCenter.child('#tabDteplomer').tab.hide();
                    tabPnCenter.child('#tabDvodomer').tab.show();
                    tabPnCenter.setActiveTab('tabDvodomer');
                    me.LoadTabDvodomer();

                    break;
                case "2":
                    tabPnCenter.child('#tabDteplomer').tab.show();
                    tabPnCenter.child('#tabDvodomer').tab.hide();
                    tabPnCenter.setActiveTab('tabDteplomer');
                    me.LoadTabDteplomer();
                    break;
                case "7":
                    tabPnCenter.child('#tabDteplomer').tab.show();
                    tabPnCenter.child('#tabDvodomer').tab.show();
                    tabPnCenter.setActiveTab('tabDteplomer');
                    me.LoadTabDteplomer();
                    break;

            }

        }
    },

    loadOrg: function() {
        //in use
        var me = this;
        var showOrg = Ext.getCmp('showOrg');

        // STORE

        var stUser = Ext.data.StoreManager.get("StUser");
        var StOrg = Ext.data.StoreManager.get("StOrg");
        var StOrgDog = Ext.data.StoreManager.get("StOrgDog");
        var StOrgPhones = Ext.data.StoreManager.get("StOrgPhones");
        var StBanksOrg = Ext.data.StoreManager.get("StBanksOrg");
        var StFilialOpl = Ext.data.StoreManager.get("StFilialOpl");


        //TAB

        var tabPnCenter = me.getTabPnCenter();



        // FORM

        var form_org = Ext.getCmp("fmOrg");  //Форма организации
        var fmDTeplomers = Ext.getCmp('fmDTeplomers');


        //LOGIN & PASSWORD & ID

        var values =stUser.getAt(0);
        var login = values.get('login');
        var password = values.get('password');
        var org_id = values.get('org_id');
        var org = values.get('org');

        //LOGIKA

        //form_org.getForm().reset();

        StOrg.load({
            params: {
                what:'FmOrgInfo',
                org_id: org_id,
                login:login,
                password:password
            },
            callback: function(records,operation,success){
                if(success){
                    //    console.log(records[0]);
                    values.set('sobstv_id', records[0].get('cat_id'));
                    form_org.getForm().loadRecord(records[0]);
                    showOrg.setText(records[0].get('sname')).show();
                }},
            scope:this
        });
        StOrgPhones.load({
            params: {
                what:'getOrgPhones',
                org_id: org_id,
                login:login,
                password:password
            },
            scope:this
        });

        StBanksOrg.load({
            params: {
                what:'getBankOrg',
                org_id: values.get('org_id'),
                login:values.get('login'),
                password:values.get('password')
            },
            scope:this
        });
        StFilialOpl.load({
            params: {
                what:'getFilialOrg',
                org_id: values.get('org_id'),
                login:values.get('login'),
                password:values.get('password')
            },
            scope:this
        });

        //ДОМА
        tabPnCenter.child('#tabDteplomer').tab.hide();
        tabPnCenter.child('#tabDvodomer').tab.hide();
        // tabPnCenter.child('#tabWaterHouse').tab.hide();


        //КВАРТИРЫ
        tabPnCenter.child('#tabAppBti').tab.hide();
        tabPnCenter.child('#tabKassa').tab.hide();
        tabPnCenter.child('#tabNachApp').tab.hide();
        tabPnCenter.child('#tabNachAppVoda').tab.hide();
        tabPnCenter.child('#tabNachAppTeplo').tab.hide();

        tabPnCenter.child('#tabOplata').tab.hide();

        tabPnCenter.child('#tabAppVodomer').tab.hide();
        tabPnCenter.child('#tabAppTeplomer').tab.hide();
        //ОБЬЕКТЫ
        tabPnCenter.child('#tabOrgVodomer').tab.hide();
        tabPnCenter.child('#tabOrgTeplomer').tab.hide();
        tabPnCenter.child('#tabFilial').tab.hide();
        tabPnCenter.child('#tabNachFilial').tab.hide();
        //ОРГАНИЗАЦИИ
        //tabPnCenter.child('#tabDog').tab.show();
        tabPnCenter.child('#tabOrg').tab.show();
        //СПРАВОЧНИК
        //tabPnCenter.child('#tabSprav').tab.hide();
        //   tabPnCenter.child('#tabReportOrg').tab.hide();
        tabPnCenter.child('#tabLogin').tab.hide();

        tabPnCenter.setActiveTab('tabOrg');
    },

    AddFilial: function(org_id) {

        var winAddFilial = Ext.ClassManager.instantiateByAlias('widget.winaddfilial');
        var form = Ext.getCmp("fmAddFilial");
        var showOrg = Ext.getCmp('showOrgAddFilial');
        var stUser = Ext.data.StoreManager.get("StUser");
        var values =stUser.getAt(0);
        var org = values.get('org');
        form.getForm().reset();
        form.getForm().findField('org_id').setValue(org_id);

        showOrg.setText(org).show();

        winAddFilial.show();

    }

});
